const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/qr-scanner.min-DWG_x7wc.js","assets/app-DzEmJHii.js"])))=>i.map(i=>d[i]);
import{i as j}from"./isEqual-D_8aNiOR.js";import{c as L}from"./cloneDeep-CRZrXCcn.js";import{B as A}from"./Button-gD2nuYEJ.js";import{S as O}from"./Switch-Bn46wuTp.js";import{R,S as B}from"./StoreLogo-Df2VlIwX.js";import{I,X as D}from"./Input-CE4RPfme.js";import{d as _,r as u,o as i,_ as T,c as m,b as r,e as g,t as y,w as W,F as V,a as M,n as k,g as C,f as E,i as w,k as q,T as Q}from"./app-DzEmJHii.js";import{_ as S}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./qr-scanner.min-DWG_x7wc.js";import{C as X}from"./check-CpwWn7Mi.js";import{S as Y}from"./Select-DevKOWun.js";import{E as N}from"./external-link-Dd0p5gum.js";import{S as G}from"./SelectCurrency-B3XUT1Eg.js";import{I as H}from"./info-P1D1b4JP.js";import{C as J}from"./cloud-upload-BdfG_93L.js";import{B as K}from"./banknote-hAbsxx7X.js";import{M as F}from"./move-right-dsRLGEJ0.js";import"./Loader-BbY_PjoY.js";import"./ShineEffect-7ISWLx82.js";import"./Popover-DanCA_pE.js";import"./createLucideIcon-B1C9m8SV.js";import"./plus-9ZeBx_gh.js";import"./Copy-BxvDy_-Q.js";import"./Skeleton-caFmp0IF.js";const Z={components:{Input:I},props:{modelValue:{type:String},configSchemaEntity:{type:Object}},data(){return{localModelValue:this.modelValue}},watch:{modelValue(o){this.localModelValue=o},localModelValue(o,e){this.$emit("update:modelValue",o)}}};function $(o,e,t,n,a,l){const s=u("Input");return i(),_(s,{modelValue:a.localModelValue,"onUpdate:modelValue":e[0]||(e[0]=d=>a.localModelValue=d),label:t.configSchemaEntity.label,description:t.configSchemaEntity.description,popoverContent:t.configSchemaEntity.description_info,secondaryLabel:t.configSchemaEntity.optional?"(optional)":null,externalLinkUrl:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.href:null,externalLinkName:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.label:null},null,8,["modelValue","label","description","popoverContent","secondaryLabel","externalLinkUrl","externalLinkName"])}const ee=S(Z,[["render",$]]),te={components:{X:D,Check:X,RefreshCw:R},props:{modelValue:{type:Object,default:()=>null},configSchemaEntity:{type:Object},paymentMethod:{type:Object},deletePaymentMethodImage:{type:Function},uploadSinglePaymentMethodImage:{type:Function},getPaymentMethodValidationErrors:{type:Function}},data(){return{localModelValue:null}},watch:{modelValue:{immediate:!0,handler(o){this.localModelValue=L(o)},deep:!0},localModelValue:{handler(o){j(this.modelValue,o)||this.$emit("update:modelValue",o)},deep:!0}},computed:{acceptedFileTypes(){var o,e;if((e=(o=this.configSchemaEntity)==null?void 0:o.validation_rules)!=null&&e.mime_types){const[t]=this.configSchemaEntity.validation_rules.mime_types;if(Array.isArray(t)&&t.length>0)return t.join(",")}return"image/*"},hasCloudImage(){var o,e;return((o=this.localModelValue)==null?void 0:o.path)&&!((e=this.localModelValue)!=null&&e.path.startsWith("blob:"))},hasLocalImage(){var o,e;return((o=this.localModelValue)==null?void 0:o.path)&&((e=this.localModelValue)==null?void 0:e.path.startsWith("blob:"))}},methods:{triggerFileInput(){this.$refs.fileInput.click()},handleFileUpload(o){const e=o.target.files[0];e&&this.processFile(e)},handleDrop(o){o.preventDefault();const e=o.dataTransfer.files[0];e&&this.processFile(e)},processFile(o){o&&new Promise(e=>{const t=new FileReader;t.onload=()=>{this.localModelValue.path=URL.createObjectURL(o),this.localModelValue.uploading=!1,this.localModelValue.uploaded=null,this.localModelValue.file_ref=o,e()},t.readAsDataURL(o)}).then(async()=>{var e;(e=this.configSchemaEntity.validation_rules)!=null&&e.qr_code&&await this.validateQRCode(),this.paymentMethod.store_payment_method_id&&await this.uploadImage()})},async validateQRCode(){try{const e=await(await T(async()=>{const{default:n}=await import("./qr-scanner.min-DWG_x7wc.js");return{default:n}},__vite__mapDeps([0,1]))).default.scanImage(this.localModelValue.path,{returnDetailedScanResult:!0}),t=(e==null?void 0:e.data)??e;if(t)console.log(`‚úÖ QR Code detected: ${t}`),this.localModelValue={...this.localModelValue,valid_qr:!0,qrData:t};else throw new Error("Invalid QR Code")}catch(o){console.error("‚ùå Invalid QR Code:",o),this.localModelValue={...this.localModelValue,valid_qr:!1}}},async removeImage(){this.hasLocalImage?this.localModelValue.path=null:this.localModelValue.path!=null&&await this.deletePaymentMethodImage(this.paymentMethod,this.configSchemaEntity.attribute)},async uploadImage(){const{attribute:o}=this.configSchemaEntity,e={[o]:this.paymentMethod.configs[o]};if(!e[o]){console.log(`‚ö†Ô∏è No valid config found for '${o}'`);return}const t=this.getPaymentMethodValidationErrors(this.configSchemaEntity,e);t.length?console.log("‚ùå Upload prevented due to validation errors:",t):await this.uploadSinglePaymentMethodImage(this.paymentMethod,o)}}},oe={class:"text-sm leading-6 font-medium text-gray-900"},ae={key:0,class:"font-normal text-gray-400 ml-1"},ne=["accept"],le={class:"relative mt-2"},se={key:0,class:"absolute z-10 top-1 right-1 bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"},ie={class:"absolute z-10 top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"},re={key:1,class:k(["absolute inset-0 bg-gray-900/80 bg-opacity-50 rounded-lg flex items-center justify-center"])},de={key:2,class:k(["absolute inset-0 bg-red-900/80 bg-opacity-50 rounded-lg flex items-center justify-center"])},ce=["src"],me={key:5,class:"bg-red-500/20 py-2 px-4 relative rounded-b-lg text-xs"};function ue(o,e,t,n,a,l){const s=u("Check"),d=u("X"),b=u("RefreshCw");return i(),m("div",null,[r("div",oe,[r("span",null,y(t.configSchemaEntity.label),1),t.configSchemaEntity.optional?(i(),m("span",ae,"(optional)")):g("",!0)]),a.localModelValue.path?g("",!0):(i(),m("div",{key:0,onDragover:e[1]||(e[1]=W(()=>{},["prevent"])),onDrop:e[2]||(e[2]=(...h)=>l.handleDrop&&l.handleDrop(...h)),onClick:e[3]||(e[3]=(...h)=>l.triggerFileInput&&l.triggerFileInput(...h)),class:"mt-2 w-full h-40 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 text-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"},[e[7]||(e[7]=r("p",null,"Click or Drag & Drop Image",-1)),r("input",{type:"file",class:"hidden",ref:"fileInput",onChange:e[0]||(e[0]=(...h)=>l.handleFileUpload&&l.handleFileUpload(...h)),accept:l.acceptedFileTypes},null,40,ne)],32)),r("div",le,[l.hasLocalImage&&!a.localModelValue.uploading?(i(),m(V,{key:0},[a.localModelValue.uploaded===!0?(i(),m("div",se,[M(s,{size:"16"})])):a.localModelValue.uploaded===!1?(i(),m(V,{key:1},[r("div",ie,[M(d,{size:"16"})]),r("div",{onClick:e[4]||(e[4]=(...h)=>l.uploadImage&&l.uploadImage(...h)),class:"flex items-center justify-center w-8 h-8 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 active:scale-95 absolute z-10 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 cursor-pointer"},[M(b,{size:"16"})]),e[8]||(e[8]=r("div",{class:"absolute inset-0 bg-white/80 bg-opacity-80 border border-red-500 rounded-lg flex items-center justify-center"},null,-1))],64)):g("",!0),!a.localModelValue.uploaded&&!a.localModelValue.uploading?(i(),m("div",{key:2,onClick:e[5]||(e[5]=(...h)=>l.removeImage&&l.removeImage(...h)),class:"absolute z-10 top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition cursor-pointer"},[M(d,{size:"16"})])):g("",!0)],64)):g("",!0),l.hasLocalImage&&a.localModelValue.uploading?(i(),m("div",re,e[9]||(e[9]=[r("span",{class:"text-white text-xs font-bold"},"Uploading...",-1)]))):l.hasCloudImage&&a.localModelValue.deleting?(i(),m("div",de,e[10]||(e[10]=[r("span",{class:"text-white text-xs font-bold"},"Deleting...",-1)]))):g("",!0),(l.hasCloudImage||l.hasLocalImage)&&!a.localModelValue.deleting&&!a.localModelValue.uploading?(i(),m("div",{key:3,onClick:e[6]||(e[6]=(...h)=>l.removeImage&&l.removeImage(...h)),class:"absolute top-1 right-1 cursor-pointer bg-red-500 hover:bg-red-600 text-white rounded-full w-fit px-4 py-1 flex items-center justify-center text-xs active:scale-95 transition-all"}," Remove ")):g("",!0),l.hasCloudImage||l.hasLocalImage?(i(),m("img",{key:4,src:a.localModelValue.path,class:"w-full max-h-40 p-4 object-contain rounded-lg border border-gray-300 dark:border-gray-700"},null,8,ce)):g("",!0),a.localModelValue.error_message?(i(),m("p",me,y(a.localModelValue.error_message),1)):g("",!0)])])}const he=S(te,[["render",ue]]),ge={components:{Select:Y},props:{modelValue:{type:String},configSchemaEntity:{type:Object}},data(){return{localModelValue:this.modelValue}},watch:{modelValue(o){this.localModelValue=o},localModelValue(o,e){this.$emit("update:modelValue",o)}}};function fe(o,e,t,n,a,l){const s=u("Select");return i(),_(s,{width:"w-full",modelValue:a.localModelValue,"onUpdate:modelValue":e[0]||(e[0]=d=>a.localModelValue=d),label:t.configSchemaEntity.label,options:t.configSchemaEntity.options,placeholder:t.configSchemaEntity.placeholder,description:t.configSchemaEntity.description,popoverContent:t.configSchemaEntity.description_info,secondaryLabel:t.configSchemaEntity.optional?"(optional)":null,externalLinkUrl:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.href:null,externalLinkName:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.label:null},null,8,["modelValue","label","options","placeholder","description","popoverContent","secondaryLabel","externalLinkUrl","externalLinkName"])}const pe=S(ge,[["render",fe]]),ye={components:{Input:I},props:{modelValue:{type:String},configSchemaEntity:{type:Object}},data(){return{localModelValue:this.modelValue}},watch:{modelValue(o){this.localModelValue=o},localModelValue(o,e){this.$emit("update:modelValue",o)}}},_e={class:"leading-4 text-gray-400 text-sm"};function be(o,e,t,n,a,l){const s=u("Input");return i(),_(s,{type:"text",modelValue:a.localModelValue,"onUpdate:modelValue":e[0]||(e[0]=d=>a.localModelValue=d),label:t.configSchemaEntity.label,placeholder:t.configSchemaEntity.placeholder,description:t.configSchemaEntity.description,popoverContent:t.configSchemaEntity.description_info,secondaryLabel:t.configSchemaEntity.optional?"(optional)":null,externalLinkUrl:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.href:null,externalLinkName:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.label:null},{prefix:C(()=>[r("span",_e,y(t.configSchemaEntity.prefix),1)]),_:1},8,["modelValue","label","placeholder","description","popoverContent","secondaryLabel","externalLinkUrl","externalLinkName"])}const Me=S(ye,[["render",be]]),Pe={components:{ExternalLink:N},props:{configSchemaEntity:{type:Object}}},Se={class:"space-x-1"},Ve=["href"],xe={key:1,class:"text-xs"};function we(o,e,t,n,a,l){const s=u("ExternalLink");return i(),m("div",Se,[(i(!0),m(V,null,E(t.configSchemaEntity.content,(d,b)=>(i(),m(V,{key:b},[d.text&&d.href?(i(),m("a",{key:0,target:"_blank",href:d.href,class:"text-xs text-blue-700 hover:underline hover:text-blue-90"},[w(y(d.text)+" ",1),M(s,{size:"12",class:"inline-block ml-0.5 -mt-0.5"})],8,Ve)):d.text?(i(),m("span",xe,y(d.text),1)):g("",!0)],64))),128))])}const ve=S(Pe,[["render",we]]),Ce={components:{SelectCurrency:G},props:{modelValue:{type:String},paymentMethod:{type:Object},configSchemaEntity:{type:Object}},data(){return{localModelValue:this.modelValue}},watch:{modelValue(o){this.localModelValue=o},localModelValue(o,e){this.$emit("update:modelValue",o)}}};function ke(o,e,t,n,a,l){const s=u("SelectCurrency");return i(),_(s,{clearable:!0,modelValue:a.localModelValue,"onUpdate:modelValue":e[0]||(e[0]=d=>a.localModelValue=d),label:t.configSchemaEntity.label,allowedCurrencies:t.paymentMethod.currencies,description:t.configSchemaEntity.description,popoverContent:t.configSchemaEntity.description_info,secondaryLabel:t.configSchemaEntity.optional?"(optional)":null,externalLinkUrl:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.href:null,externalLinkName:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.label:null},null,8,["modelValue","label","allowedCurrencies","description","popoverContent","secondaryLabel","externalLinkUrl","externalLinkName"])}const Ee=S(Ce,[["render",ke]]),Ie={components:{Input:I},props:{modelValue:{type:String},configSchemaEntity:{type:Object}},data(){return{localModelValue:this.modelValue}},watch:{modelValue(o){this.localModelValue=o},localModelValue(o,e){this.$emit("update:modelValue",o)}}};function Ue(o,e,t,n,a,l){const s=u("Input");return i(),_(s,{type:"text",modelValue:a.localModelValue,"onUpdate:modelValue":e[0]||(e[0]=d=>a.localModelValue=d),label:t.configSchemaEntity.label,description:t.configSchemaEntity.description,popoverContent:t.configSchemaEntity.description_info,secondaryLabel:t.configSchemaEntity.optional?"(optional)":null,learn_moreLink:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.href:null,learn_moreLabel:t.configSchemaEntity.learn_more?t.configSchemaEntity.learn_more.label:null},null,8,["modelValue","label","description","popoverContent","secondaryLabel","learn_moreLink","learn_moreLabel"])}const Le=S(Ie,[["render",Ue]]),Fe={components:{Info:H,Input:I,EmailConfig:ee,ImageConfig:he,SelectConfig:pe,StringConfig:Me,ContentConfig:ve,CurrencyConfig:Ee,MobileNumberConfig:Le},props:{paymentMethod:{type:Object},paymentMethodIndex:{type:Number},deletePaymentMethodImage:{type:Function},uploadSinglePaymentMethodImage:{type:Function},getPaymentMethodValidationErrors:{type:Function},getPaymentMethodFirstValidationError:{type:Function},checkIfPaymentMethodConfigSchemaEntityPassesCondition:{type:Function}}},je={key:0},Ne={key:7,class:"flex space-x-1 text-xs text-yellow-600 font-semibold bg-yellow-100 border border-yellow-300 p-3 rounded-lg shadow-md mt-2"};function ze(o,e,t,n,a,l){const s=u("Input"),d=u("StringConfig"),b=u("MobileNumberConfig"),h=u("EmailConfig"),f=u("SelectConfig"),U=u("CurrencyConfig"),v=u("ImageConfig"),p=u("ContentConfig"),x=u("Info");return t.paymentMethod.active?(i(),m("div",je,[t.paymentMethod.type=="other"?(i(),_(s,{key:0,type:"text",class:"mt-4",label:"Custom Name",modelValue:t.paymentMethod.custom_name,"onUpdate:modelValue":e[0]||(e[0]=c=>t.paymentMethod.custom_name=c),description:"Provide your own custom payment name"},null,8,["modelValue"])):g("",!0),(i(!0),m(V,null,E(t.paymentMethod.config_schema,(c,z)=>(i(),m("div",{key:z,class:"mt-4"},[t.checkIfPaymentMethodConfigSchemaEntityPassesCondition(c,t.paymentMethod.configs)?(i(),m(V,{key:0},[c.type=="string"?(i(),_(d,{key:0,configSchemaEntity:c,modelValue:t.paymentMethod.configs[c.attribute],"onUpdate:modelValue":P=>t.paymentMethod.configs[c.attribute]=P},null,8,["configSchemaEntity","modelValue","onUpdate:modelValue"])):c.type=="mobile_number"?(i(),_(b,{key:1,configSchemaEntity:c,modelValue:t.paymentMethod.configs[c.attribute],"onUpdate:modelValue":P=>t.paymentMethod.configs[c.attribute]=P},null,8,["configSchemaEntity","modelValue","onUpdate:modelValue"])):c.type=="email"?(i(),_(h,{key:2,configSchemaEntity:c,modelValue:t.paymentMethod.configs[c.attribute],"onUpdate:modelValue":P=>t.paymentMethod.configs[c.attribute]=P},null,8,["configSchemaEntity","modelValue","onUpdate:modelValue"])):c.type=="select"?(i(),_(f,{key:3,configSchemaEntity:c,modelValue:t.paymentMethod.configs[c.attribute],"onUpdate:modelValue":P=>t.paymentMethod.configs[c.attribute]=P},null,8,["configSchemaEntity","modelValue","onUpdate:modelValue"])):c.type=="currency"?(i(),_(U,{key:4,paymentMethod:t.paymentMethod,configSchemaEntity:c,modelValue:t.paymentMethod.configs[c.attribute],"onUpdate:modelValue":P=>t.paymentMethod.configs[c.attribute]=P},null,8,["paymentMethod","configSchemaEntity","modelValue","onUpdate:modelValue"])):c.type=="image"?(i(),_(v,{key:5,paymentMethod:t.paymentMethod,configSchemaEntity:c,deletePaymentMethodImage:t.deletePaymentMethodImage,modelValue:t.paymentMethod.configs[c.attribute],"onUpdate:modelValue":P=>t.paymentMethod.configs[c.attribute]=P,uploadSinglePaymentMethodImage:t.uploadSinglePaymentMethodImage,getPaymentMethodValidationErrors:t.getPaymentMethodValidationErrors},null,8,["paymentMethod","configSchemaEntity","deletePaymentMethodImage","modelValue","onUpdate:modelValue","uploadSinglePaymentMethodImage","getPaymentMethodValidationErrors"])):c.type=="content"?(i(),_(p,{key:6,configSchemaEntity:c},null,8,["configSchemaEntity"])):g("",!0),t.getPaymentMethodFirstValidationError(c,t.paymentMethod.configs)?(i(),m("p",Ne,[M(x,{size:"14",class:"shrink-0"}),r("span",null,y(t.getPaymentMethodFirstValidationError(c,t.paymentMethod.configs)),1)])):g("",!0)],64)):g("",!0)]))),128))])):g("",!0)}const Ae=S(Fe,[["render",ze]]),Oe={inject:["formState","storeState","notificationState"],components:{Button:A,Switch:O,StoreLogo:B,MoveRight:F,Banknote:K,CloudUpload:J,ExternalLink:N,PaymentMethodConfigInputs:Ae},data(){return{MoveRight:F,uploadMessage:"",paymentMethods:[],isUploading:!1,totalCompletedSteps:0,totalCompletedUploads:0,uploadsFailedBefore:!1,originalPaymentMethods:[],associatedPaymentMethods:[],unassociatedPaymentMethods:[],isSubmittingPaymentMethods:!1,isLoadingAssociatedPaymentMethods:!1,isLoadingUnassociatedPaymentMethods:!1}},computed:{store(){return this.storeState.store},totalUploads(){return this.changedPaymentMethods.reduce((o,e)=>o+e.config_schema.filter(t=>e.configs[t.attribute]&&e.configs[t.attribute].path&&e.configs[t.attribute].hasOwnProperty("uploaded")).length,0)},totalFailedUploads(){return this.changedPaymentMethods.reduce((o,e)=>o+e.config_schema.filter(t=>{var a;const n=e.configs[t.attribute];return((a=n==null?void 0:n.path)==null?void 0:a.startsWith("blob:"))&&n.uploaded===!1}).length,0)},totalCompletionSteps(){return this.changedPaymentMethods.filter(o=>o.store_payment_method_id?!0:!!o.active).length+this.totalUploads},progressPercentage(){return this.totalCompletionSteps===0?0:Math.round(this.totalCompletedSteps/this.totalCompletionSteps*100)},hasFailedUploads(){return this.totalFailedUploads>0},changedPaymentMethods(){return this.paymentMethods.filter((o,e)=>!j(o,this.originalPaymentMethods[e]))},hasChangedPaymentMethods(){return this.changedPaymentMethods.length>0},hasSelectedPaymentMethods(){return this.totalSelectedPaymentMethods>0},hasAssociatedPaymentMethods(){return this.associatedPaymentMethods.length>0},totalSelectedPaymentMethods(){return this.paymentMethods.filter(o=>o.active).length},paymentMethodValidationErrors(){return this.paymentMethods.filter(o=>o.active).flatMap(o=>o.config_schema.filter(e=>this.checkIfPaymentMethodConfigSchemaEntityPassesCondition(e,o.configs)).map(e=>this.getPaymentMethodFirstValidationError(e,o.configs)).filter(e=>e!==null))},hasPaymentMethodValidationErrors(){return this.paymentMethodValidationErrors.length>0}},methods:{reset(){this.pagination=null,this.uploadMessage="",this.paymentMethods=[],this.isUploading=!1,this.totalCompletedSteps=0,this.totalCompletedUploads=0,this.originalPaymentMethods=[],this.associatedPaymentMethods=[],this.unassociatedPaymentMethods=[],this.isSubmittingPaymentMethods=!1,this.isLoadingUnassociatedPaymentMethods=!1},async showAssociatedPaymentMethods(){var o,e;try{this.isLoadingAssociatedPaymentMethods=!0;let t={params:{store_id:this.store.id,_relationships:"paymentMethod,logo,photo"}};const n=await axios.get("/api/store-payment-methods",t);this.pagination=n.data,this.associatedPaymentMethods=this.pagination.data.map(a=>{const l=a.logo,s=a.photo,d=a.payment_method;let b=Object.fromEntries(d.config_schema.filter(f=>!["content"].includes(f.type)).map(f=>[f.attribute,f.default??null]));b={...b,...a.configs??{}};let h={configs:b,id:d.id,name:d.name,type:d.type,logo:d.image_url,active:a.active,currencies:d.currencies,config_schema:d.config_schema,custom_name:a.custom_name,store_payment_method_id:a.id};return d.config_schema.forEach(f=>{f.type==="image"&&f.attribute=="logo"?h.configs[f.attribute]={id:l==null?void 0:l.id,deleting:!1,path:l==null?void 0:l.path}:f.type==="image"&&f.attribute=="photo"&&(h.configs[f.attribute]={id:s==null?void 0:s.id,deleting:!1,path:s==null?void 0:s.path})}),h}),this.setPaymentMethods()}catch(t){const n=((e=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:e.message)||(t==null?void 0:t.message)||"Something went wrong while fetching payment methods";this.notificationState.showWarningNotification(n),this.formState.setServerFormErrors(t),console.error("Failed to fetch payment methods:",t)}finally{this.isLoadingAssociatedPaymentMethods=!1}},async showUnassociatedPaymentMethods(){var o,e;try{this.isLoadingUnassociatedPaymentMethods=!0;let t={params:{store_id:this.store.id,association:"unassociated"}};const n=await axios.get("/api/payment-methods",t);this.pagination=n.data,this.unassociatedPaymentMethods=this.pagination.data.map(a=>{let l={active:!1,id:a.id,name:a.name,type:a.type,logo:a.image_url,custom_name:a.name,currencies:a.currencies,config_schema:a.config_schema,configs:Object.fromEntries(a.config_schema.filter(s=>!["content"].includes(s.type)).map(s=>[s.attribute,s.default??null]))};return a.config_schema.forEach(s=>{s.type==="image"&&(l.configs[s.attribute]={path:null})}),l}),this.setPaymentMethods()}catch(t){const n=((e=(o=t==null?void 0:t.response)==null?void 0:o.data)==null?void 0:e.message)||(t==null?void 0:t.message)||"Something went wrong while fetching payment methods";this.notificationState.showWarningNotification(n),this.formState.setServerFormErrors(t),console.error("Failed to fetch payment methods:",t)}finally{this.isLoadingUnassociatedPaymentMethods=!1}},setPaymentMethods(){this.paymentMethods=L([...this.associatedPaymentMethods,...this.unassociatedPaymentMethods]),this.setOriginalPaymentMethods()},setOriginalPaymentMethods(){this.originalPaymentMethods=L(this.paymentMethods)},getPaymentMethodValidationErrors(o,e){var a;let t=[];if(!o.hasOwnProperty("validation_rules"))return t;const n=e[o.attribute];if(o.validation_rules.hasOwnProperty("required")){const[l,s]=o.validation_rules.required;l&&(n==null||typeof n=="string"&&n.trim()===""||typeof n=="object"&&Object.keys(n).length===0||Array.isArray(n)&&n.length===0)&&t.push(s)}if(o.validation_rules.hasOwnProperty("regex_pattern")){const[l,s]=o.validation_rules.regex_pattern;if(typeof n=="string")try{new RegExp(l).test(n.trim())||t.push(s)}catch{console.error(`Invalid regex pattern: ${l}`)}}if(o.validation_rules.hasOwnProperty("qr_code")){const[l]=o.validation_rules.qr_code;(a=n==null?void 0:n.path)!=null&&a.startsWith("blob:")&&(n==null?void 0:n.valid_qr)===!1&&t.push(l)}if(o.validation_rules.hasOwnProperty("mime_types")){const[l,s]=o.validation_rules.mime_types;if(n&&n.file_ref){const d=n.file_ref.type;l.includes(d)||t.push(s)}}if(o.validation_rules.hasOwnProperty("max_size")){const[l,s]=o.validation_rules.max_size;n!=null&&n.file_ref&&n.file_ref.size>l&&t.push(s)}return t},getPaymentMethodFirstValidationError(o,e){const t=this.getPaymentMethodValidationErrors(o,e);return t.length?t[0]:null},checkIfPaymentMethodConfigSchemaEntityPassesCondition(o,e){return o.hasOwnProperty("condition")?o.condition.every(t=>{const n=t.match(/^([^!=]+)(!=|=)(.+)$/);if(!n)return console.log(`Invalid condition format: ${t}`),!1;const[,a,l,s]=n.map(d=>d.trim());return e.hasOwnProperty(a)?l==="="?e[a]===s:l==="!="?e[a]!==s:!1:!1}):!0},async submitPaymentMethods(){if(this.isSubmittingPaymentMethods||this.isUploading)return;this.isSubmittingPaymentMethods=!0;let o=this.changedPaymentMethods.map(e=>{if(e.store_payment_method_id)return this.updatePaymentMethod(e);if(e.active)return this.addPaymentMethod(e)});await Promise.allSettled(o).then(e=>{let t=0,n=[];e.forEach((a,l)=>{var s;a.status==="fulfilled"?t++:(n.push(`Payment method ${l+1}: ${((s=a.reason)==null?void 0:s.message)||"An error occurred"}`),this.formErrorMessagesIndex=l,this.formState.setServerFormErrors(a.reason,l))}),t&&(this.hasAssociatedPaymentMethods?this.notificationState.showSuccessNotification("Payment methods updated!"):this.notificationState.showSuccessNotification("Payment methods added!")),n.length>0&&this.notificationState.showWarningNotification(n.join(`
`))}).catch(e=>{this.notificationState.showWarningNotification("An unexpected error occurred while submitting payment methods."),console.error(e)}).finally(()=>{this.isSubmittingPaymentMethods=!1,this.setOriginalPaymentMethods()}),this.totalFailedUploads==0||this.uploadsFailedBefore?this.navigateToAddSocials():this.uploadsFailedBefore=!0},async addPaymentMethod(o){var e,t;try{this.uploadMessage=`Creating ${o.name}`;let n={return:"1",store_id:this.store.id,active:o.active,configs:o.configs,payment_method_id:o.id,custom_name:o.custom_name};const a=await axios.post("/api/store-payment-methods",n);this.totalCompletedSteps<this.totalCompletionSteps&&this.totalCompletedSteps++;let l=a.data.store_payment_method;o.store_payment_method_id=l.id,await this.uploadStorePaymentMethodImages(o)}catch(n){const a=((t=(e=n==null?void 0:n.response)==null?void 0:e.data)==null?void 0:t.message)||(n==null?void 0:n.message)||`Something went wrong while creating ${o.name}`;this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(n),console.error("Failed to create store payment method:",n)}},async updatePaymentMethod(o){var e,t;try{let n={store_id:this.store.id,active:o.active,configs:o.configs,custom_name:o.custom_name};await axios.put(`/api/store-payment-methods/${o.store_payment_method_id}`,n),this.totalCompletedSteps<this.totalCompletionSteps&&this.totalCompletedSteps++}catch(n){const a=((t=(e=n==null?void 0:n.response)==null?void 0:e.data)==null?void 0:t.message)||(n==null?void 0:n.message)||`Something went wrong while updating ${o.name}`;this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(n),console.error("Failed to update store payment method:",n)}},async uploadStorePaymentMethodImages(o){let e=o.config_schema.filter(a=>a.type==="image").map(a=>this.uploadSinglePaymentMethodImage(o,a.attribute)).filter(Boolean);if(e.length===0)return;this.isUploading=!0,this.uploadMessage="Uploading images...";let n=(await Promise.allSettled(e)).filter(a=>a.status==="rejected").length;n>0&&this.notificationState.showWarningNotification(`‚ö†Ô∏è ${n} image(s) failed to upload. You can retry manually.`),this.isUploading=!1},async uploadSinglePaymentMethodImage(o,e,t=0,n=null){var a,l;try{if(t>2)return console.log(`‚ùå Image upload for '${o.name}' failed after 3 attempts.`),o.configs[e].uploaded=!1,o.configs[e].error_message=((l=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:l.message)||(n==null?void 0:n.message)||`Something went wrong while uploading ${e}`,Promise.reject("Failed after 3 attempts");let s=new FormData;s.append("return","1"),s.append("store_id",this.store.id),s.append("mediable_type","store payment method"),s.append("file",o.configs[e].file_ref),s.append("mediable_id",o.store_payment_method_id),s.append("upload_folder_name",`store_payment_method_${e}`),o.configs[e].uploading=!0,o.configs[e].error_message=null;const d={headers:{"Content-Type":"multipart/form-data"}},b=await axios.post("/api/media-files",s,d);this.totalCompletedSteps<this.totalCompletionSteps&&this.totalCompletedSteps++;const h=b.data.media_file;return this.totalCompletedUploads++,o.configs[e]={uploaded:!0,deleting:!1,id:h.id,path:h.path},console.log(`‚úÖ Image for '${o.name}' uploaded successfully.`),this.uploadMessage=`Uploaded ${this.totalCompletedUploads}/${this.totalUploads} images`,b}catch(s){console.error(`‚ö†Ô∏è Image upload for '${o.name}' attempt ${t+1} failed.`,s),await this.uploadSinglePaymentMethodImage(o,e,t+1,s)}finally{o.configs[e].uploading=!1}},async deletePaymentMethodImage(o,e){var t,n;try{if(o.configs[e].deleting)return;o.configs[e].deleting=!0;let a={data:{store_id:this.store.id}};await axios.delete(`/api/media-files/${o.configs[e].id}`,a),o.configs[e].path=null,o.configs[e].uploaded=!1,console.log(`‚úÖ Successfully deleted ${e} for '${o.name}'`)}catch(a){const l=((n=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:n.message)||(a==null?void 0:a.message)||`Something went wrong while deleting ${o.name} ${e}`;this.notificationState.showWarningNotification(l),this.formState.setServerFormErrors(a),console.error(`Failed to delete ${e} for '${o.name}':`,a)}finally{o.configs[e].deleting=!1}},navigateToAddSocials(){this.$router.push({name:"add-socials",params:{store_id:this.store.id}})}},beforeRouteLeave(o,e,t){if((this.isSubmittingPaymentMethods||this.isUploading||this.hasChangedPaymentMethods&&this.progressPercentage!=100&&!this.hasFailedUploads)&&!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return t(!1);t()},created(){this.reset(),this.showAssociatedPaymentMethods(),this.showUnassociatedPaymentMethods()}},Re={class:"min-h-screen flex flex-col items-center pt-20 pb-40"},Be={class:"w-full max-w-lg"},De={class:"w-full max-w-lg"},Te={class:"space-y-3 mb-4"},We={class:"flex justify-between items-center"},qe={class:"flex items-center space-x-2 font-bold"},Qe={class:"w-8 h-8 rounded-full overflow-hidden flex items-center justify-center"},Xe=["src"],Ye={class:"text-sm"},Ge={key:0,class:"list-disc text-xs text-yellow-600 bg-yellow-100 border border-yellow-300 py-3 px-4 rounded-lg shadow-md mb-4"},He={class:"space-y-1"},Je={key:1,class:"text-blue-600 bg-blue-100 border border-blue-300 p-3 rounded-lg shadow-md mb-4"},Ke={class:"flex items-center space-x-2"},Ze={key:0,class:"text-sm font-semibold"},$e={class:"font-bold"},et={key:2,class:"mb-4"},tt={class:"w-full max-w-lg bg-gray-200 rounded-full h-2 mb-2"},ot={class:"text-xs text-center mt-2 font-bold"},at={key:3,class:"text-xs text-blue-600 font-semibold bg-blue-100 border border-blue-300 p-3 rounded-lg shadow-md mb-4"},nt={class:"flex items-center space-x-2"},lt={key:0},st={class:"mt-2 p-2 border-t border-dotted border-blue-300"},it={class:"font-normal space-y-1"},rt={href:"https://tinypng.com/",target:"_blank",class:"underline inline-flex items-center"},dt={class:"flex justify-end"};function ct(o,e,t,n,a,l){const s=u("StoreLogo"),d=u("Switch"),b=u("PaymentMethodConfigInputs"),h=u("Banknote"),f=u("CloudUpload"),U=u("ExternalLink"),v=u("Button");return i(),m("div",Re,[r("div",Be,[M(s,{showButton:!1,class:"flex justify-center mb-4"}),e[0]||(e[0]=r("h2",{class:"text-2xl font-semibold text-center mb-2"},"Add Payment Methods",-1)),e[1]||(e[1]=r("p",{class:"text-gray-500 text-center mb-6"},"Make it easy for customers to pay! Pick the payment options you‚Äôd like to accept",-1))]),r("div",De,[r("div",Te,[(i(!0),m(V,null,E(a.paymentMethods,(p,x)=>(i(),m("div",{key:x,class:"bg-white p-4 shadow-sm rounded-xl transition-all duration-300 border border-transparent hover:border-gray-300 hover:shadow-lg cursor-pointer"},[r("div",We,[r("div",qe,[r("div",Qe,[r("img",{alt:"Payment Method Logo",class:"h-full object-contain",src:p.configs.logo&&p.configs.logo.path?p.configs.logo.path:p.logo},null,8,Xe)]),r("span",Ye,y(p.type=="other"&&p.custom_name?p.custom_name:p.name),1)]),M(d,{size:"md",modelValue:p.active,"onUpdate:modelValue":c=>p.active=c},null,8,["modelValue","onUpdate:modelValue"])]),M(b,{paymentMethod:p,paymentMethodIndex:x,deletePaymentMethodImage:l.deletePaymentMethodImage,uploadSinglePaymentMethodImage:l.uploadSinglePaymentMethodImage,getPaymentMethodValidationErrors:l.getPaymentMethodValidationErrors,getPaymentMethodFirstValidationError:l.getPaymentMethodFirstValidationError,checkIfPaymentMethodConfigSchemaEntityPassesCondition:l.checkIfPaymentMethodConfigSchemaEntityPassesCondition},null,8,["paymentMethod","paymentMethodIndex","deletePaymentMethodImage","uploadSinglePaymentMethodImage","getPaymentMethodValidationErrors","getPaymentMethodFirstValidationError","checkIfPaymentMethodConfigSchemaEntityPassesCondition"])]))),128))]),l.hasPaymentMethodValidationErrors?(i(),m("div",Ge,[e[2]||(e[2]=r("p",{class:"text-lg font-semibold mb-2"},"Resolve these to continue",-1)),r("ul",He,[(i(!0),m(V,null,E(l.paymentMethodValidationErrors,(p,x)=>(i(),m("li",{key:x},y(p),1))),128))])])):(i(),m("div",Je,[r("div",Ke,[M(h,{size:"36"}),r("div",null,[l.hasSelectedPaymentMethods?(i(),m("p",Ze,[w(y(l.store.name)+" supports ",1),r("span",$e,y(l.totalSelectedPaymentMethods)+" "+y(l.totalSelectedPaymentMethods==1?"payment method":"payment methods"),1)])):g("",!0),r("p",{class:k([l.hasSelectedPaymentMethods?"text-xs":"text-sm font-semibold"])},"You can always "+y(l.hasSelectedPaymentMethods?"add more":"add")+" payment options later! üòä",3)])])])),a.isSubmittingPaymentMethods||a.isUploading||l.progressPercentage===100?(i(),m("div",et,[r("div",tt,[r("div",{class:k(["h-2 rounded-full transition-all duration-500",l.progressPercentage===100?"bg-green-500":"bg-blue-500"]),style:q({width:l.progressPercentage+"%"})},null,6)]),r("p",ot,y(l.progressPercentage===100?"Payment Methods Ready üéâ":`${a.uploadMessage} (${l.progressPercentage}%)`),1)])):g("",!0),l.hasFailedUploads?(i(),m("div",at,[r("div",nt,[M(f,{size:"36"}),r("div",null,[r("p",null,[e[3]||(e[3]=w(" We could not upload ")),l.totalFailedUploads?(i(),m("span",lt,y(l.totalFailedUploads)+" "+y(l.totalFailedUploads==1?"photo":"photos")+". ",1)):g("",!0)]),e[4]||(e[4]=r("p",null,"But no worries‚Äîyou can always add more later! üòä",-1))])]),r("div",st,[r("ul",it,[e[8]||(e[8]=r("li",null,"‚úÖ Make sure you‚Äôre uploading images (jpeg, jpg, png, gif or svg).",-1)),e[9]||(e[9]=r("li",null,"‚úÖ Ensure your images are not too large (we accept up to 5MB).",-1)),r("li",null,[e[6]||(e[6]=w("‚úÖ Use ")),r("a",rt,[e[5]||(e[5]=w(" tinypng.com ")),M(U,{size:"10",class:"ml-1"})]),e[7]||(e[7]=w(" to reduce image size (it‚Äôs free). "))])])])])):g("",!0),r("div",dt,[M(Q,{name:"fade-1",mode:"out-in"},{default:C(()=>[l.hasSelectedPaymentMethods||l.hasAssociatedPaymentMethods?(i(),_(v,{key:0,size:"md",type:"primary",buttonClass:"w-full",action:l.submitPaymentMethods,loading:a.isSubmittingPaymentMethods,disabled:a.isLoadingAssociatedPaymentMethods||a.isLoadingUnassociatedPaymentMethods||a.isSubmittingPaymentMethods||l.hasPaymentMethodValidationErrors},{default:C(()=>e[10]||(e[10]=[r("span",null,"Continue",-1)])),_:1,__:[10]},8,["action","loading","disabled"])):(i(),_(v,{key:1,size:"md",type:"light",rightIconSize:"24",buttonClass:"w-full",rightIcon:a.MoveRight,action:l.navigateToAddSocials},{default:C(()=>e[11]||(e[11]=[r("span",null,"Skip",-1)])),_:1,__:[11]},8,["rightIcon","action"]))]),_:1})])])])}const Nt=S(Oe,[["render",ct]]);export{Nt as default};
