import{i as p}from"./isEqual-K_oMWfyo.js";import{I as _}from"./Input-IgyxXd0Z.js";import{M as T}from"./Modal-CrlOZDZU.js";import{B as E}from"./Button-Bf8PGHdu.js";import{L as V}from"./Loader-ChKcfiit.js";import{S as B}from"./Select-DSeTonF9.js";import{P as L}from"./Popover-CUukG3Vi.js";import{S as D}from"./Skeleton-B1ZqWcQs.js";import{S as A}from"./SelectTags-BOvO5i6x.js";import{A as I}from"./AddressInput-DjUkQ_hF.js";import{B as k}from"./BackdropLoader-Cz8CMJxD.js";import{c,b as i,e as S,a as n,g as y,r as u,t as h,d as H,n as N,i as g,o as l}from"./app-CLfu_pic.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{M as O}from"./move-left-DEA1DwDU.js";import{T as U}from"./trash-2-CpCedVzS.js";import"./cloneDeep-Cv64Qkv5.js";import"./Copy-DHRqWJPr.js";import"./ShineEffect-Cz7fIyrn.js";import"./createLucideIcon-FkRKWxCW.js";import"./vue-draggable-next.esm-bundler-aWOMqaVw.js";import"./GoogleMaps-BxOjcz_l.js";import"./SelectCountry-C02eVgYF.js";import"./plus-e8yeq13D.js";const M={inject:["formState","storeState","customerState","changeHistoryState","notificationState"],components:{Input:_,Modal:T,Button:E,Loader:V,Select:B,Popover:L,Skeleton:D,SelectTags:A,AddressInput:I,BackdropLoader:k},data(){return{Trash2:U,MoveLeft:O,tags:[]}},watch:{store(r,t){!t&&r&&this.setup()},customerId(r){r&&(this.setup(),this.setActionButtons())}},computed:{store(){return this.storeState.store},customer(){return this.customerState.customer},hasCustomer(){return this.customerState.hasCustomer},customerId(){return this.$route.params.customer_id},isLoadingStore(){return this.storeState.isLoadingStore},isLoadingCustomer(){return this.customerState.isLoadingCustomer},isEditing(){return this.$route.name==="edit-customer"},isCreating(){return this.$route.name==="create-customer"},customerForm(){return this.customerState.customerForm},isSubmitting(){return this.changeHistoryState.actionButtons.length==0?!1:this.changeHistoryState.actionButtons[1].loading},isDeletingCustomer(){return this.customerState.isDeletingCustomer}},methods:{goBack(){this.navigateToCustomers()},async setup(){this.customerForm==null&&this.customerState.setCustomerForm(null,this.isCreating),this.isEditing&&this.store&&await this.showCustomer(),this.store&&(this.tags=this.store.customer_tags.map(r=>({label:r.name,value:r.id})))},async navigateToCustomers(){await this.$router.replace({name:"show-customers",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},setAddress(r){this.customerState.customerForm.address=r,this.customerState.saveStateDebounced("Address changed")},unsetAddress(){this.customerState.customerForm.address=null,this.customerState.saveStateDebounced("Address removed")},async onView(r){await this.$router.push({name:"edit-customer",params:{customer_id:r.id},query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async showCustomer(){var r,t;try{this.customerState.isLoadingCustomer=!0;let s={params:{store_id:this.store.id,_relationships:["address","tags"].join(",")}};const m=(await axios.get(`/api/customers/${this.customerId}`,s)).data;this.customerState.setCustomer(m),this.customerState.setCustomerForm(m)}catch(s){const a=((t=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:t.message)||(s==null?void 0:s.message)||"Something went wrong while fetching customer";this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(s),console.error("Failed to fetch customer:",s),s.status==404&&await this.$router.replace({name:"show-customers",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})}finally{this.customerState.isLoadingCustomer=!1}},async createCustomer(){var r,t;try{if(this.customerState.isCreatingCustomer||(this.formState.hideFormErrors(),(this.customerForm.first_name==null||this.customerForm.first_name.trim()==="")&&this.formState.setFormError("first_name","The first name is required"),this.formState.hasErrors))return;this.customerState.isCreatingCustomer=!0,this.changeHistoryState.actionButtons[1].loading=!0;const s={...this.customerForm,store_id:this.store.id},m=(await axios.post("/api/customers",s)).data.customer,e=this.changeHistoryState.getOriginalState();p(this.customerForm.tags,e.tags)||this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Customer created"),this.customerState.saveOriginalState("Original customer"),await this.onView(m)}catch(s){const a=((t=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:t.message)||(s==null?void 0:s.message)||"Something went wrong while creating customer";this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(s),console.error("Failed to create customer:",s)}finally{this.customerState.isCreatingCustomer=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async updateCustomer(){var r,t;try{if(this.customerState.isUpdatingCustomer||(this.formState.hideFormErrors(),(this.customerForm.first_name==null||this.customerForm.first_name.trim()==="")&&this.formState.setFormError("first_name","The first name is required"),this.formState.hasErrors))return;this.customerState.isUpdatingCustomer=!0,this.changeHistoryState.actionButtons[1].loading=!0;const s={...this.customerForm,store_id:this.store.id};await axios.put(`/api/customers/${this.customerForm.id}`,s);const a=this.changeHistoryState.getOriginalState();p(this.customerForm.tags,a.tags)||this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Customer updated"),this.customerState.saveOriginalState("Original customer")}catch(s){const a=((t=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:t.message)||(s==null?void 0:s.message)||"Something went wrong while updating customer";this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(s),console.error("Failed to update customer:",s)}finally{this.customerState.isUpdatingCustomer=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async deleteCustomer(r){var t,s;try{if(this.customerState.isDeletingCustomer)return;this.customerState.isDeletingCustomer=!0;const a={data:{store_id:this.store.id}};await axios.delete(`/api/customers/${this.customer.id}`,a),r(),await new Promise(m=>setTimeout(m,1e3)),this.notificationState.showSuccessNotification("Customer deleted"),await this.navigateToCustomers()}catch(a){const m=((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)||(a==null?void 0:a.message)||"Something went wrong while deleting customer";this.notificationState.showWarningNotification(m),this.formState.setServerFormErrors(a),console.error("Failed to delete customer:",a)}finally{this.customerState.isDeletingCustomer=!1,r()}},setActionButtons(){(this.isCreating||this.isEditing)&&(this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(this.onDiscard),this.changeHistoryState.addActionButton(this.isEditing?"Save Changes":"Create Customer",this.isEditing?this.updateCustomer:this.createCustomer,"primary",null))},setCustomerForm(r){this.customerState.customerForm=r}},beforeRouteLeave(r,t,s){if(this.changeHistoryState.hasChangeHistory&&!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return s(!1);s()},unmounted(){this.customerState.reset(),this.changeHistoryState.reset()},created(){this.setup(),this.setActionButtons();const r=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let t=0;t<r.length;t++){let s=r[t];this.changeHistoryState.listeners[s]=this.setCustomerForm}}},j={class:"pt-24 px-4"},P={class:"grid grid-cols-12 gap-4 mb-4"},W={class:"col-span-8 col-start-3"},z={class:"select-none bg-white rounded-lg p-4 mb-4"},R={class:"flex items-center space-x-4"},J={key:0,class:"flex items-center space-x-2"},Y={key:1,class:"flex items-center space-x-1"},G={class:"text-lg text-gray-700 font-semibold"},K={class:"relative mb-8"},Q={class:"bg-white rounded-lg space-y-4 p-4 mb-4"},X={class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},Z={class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},$={class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},tt={class:"space-y-2"},et={class:"font-bold text-black"},st={class:"flex justify-end"},rt={class:"mb-8"},ot={class:"font-bold text-black"};function at(r,t,s,a,m,e){const b=u("Button"),f=u("Skeleton"),C=u("Popover"),v=u("BackdropLoader"),d=u("Input"),F=u("SelectTags"),x=u("AddressInput"),w=u("Modal");return l(),c("div",j,[i("div",P,[i("div",W,[i("div",z,[i("div",R,[n(b,{size:"xs",type:"light",action:e.goBack,leftIcon:m.MoveLeft},{default:y(()=>t[16]||(t[16]=[i("span",null,"Back",-1)])),_:1,__:[16]},8,["action","leftIcon"]),e.isLoadingStore||e.isLoadingCustomer||e.isEditing&&!e.hasCustomer?(l(),c("div",J,[n(f,{width:"w-40"}),n(f,{width:"w-4"})])):(l(),c("div",Y,[i("h1",G,h(e.isCreating?"Add Customer":e.customerForm.name||"..."),1),n(C,{content:"Customers are groups that help organize your products so customers can easily browse and find what theyâ€™re looking for.",placement:"top"})]))])]),i("div",K,[e.isLoadingCustomer||e.isSubmitting?(l(),H(v,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):S("",!0),i("div",Q,[i("div",X,[n(d,{type:"text",label:"First Name",placeholder:"John",modelValue:e.customerForm.first_name,"onUpdate:modelValue":t[0]||(t[0]=o=>e.customerForm.first_name=o),errorText:e.formState.getFormError("first_name"),onInput:t[1]||(t[1]=o=>e.customerState.saveStateDebounced("First name changed"))},null,8,["modelValue","errorText"]),n(d,{type:"text",label:"Last Name",placeholder:"John",modelValue:e.customerForm.last_name,"onUpdate:modelValue":t[2]||(t[2]=o=>e.customerForm.last_name=o),errorText:e.formState.getFormError("last_name"),onInput:t[3]||(t[3]=o=>e.customerState.saveStateDebounced("Last name changed"))},null,8,["modelValue","errorText"])]),i("div",Z,[n(d,{type:"email",label:"Email",modelValue:e.customerForm.email,"onUpdate:modelValue":t[4]||(t[4]=o=>e.customerForm.email=o),placeholder:"johndoe@example.com",errorText:e.formState.getFormError("email"),onInput:t[5]||(t[5]=o=>e.customerState.saveStateDebounced("Email changed"))},null,8,["modelValue","errorText"]),n(d,{type:"text",label:"Mobile Number",modelValue:e.customerForm.mobile_number,"onUpdate:modelValue":t[6]||(t[6]=o=>e.customerForm.mobile_number=o),errorText:e.formState.getFormError("mobile_number"),onInput:t[7]||(t[7]=o=>e.customerState.saveStateDebounced("Mobile number changed"))},null,8,["modelValue","errorText"])]),i("div",$,[n(d,{type:"date",label:"Birthday",modelValue:e.customerForm.birthday,"onUpdate:modelValue":t[8]||(t[8]=o=>e.customerForm.birthday=o),errorText:e.formState.getFormError("birthday"),onInput:t[9]||(t[9]=o=>e.customerState.saveStateDebounced("Birthday changed"))},null,8,["modelValue","errorText"]),n(d,{type:"text",label:"Referral Code",modelValue:e.customerForm.referral_code,"onUpdate:modelValue":t[10]||(t[10]=o=>e.customerForm.referral_code=o),errorText:e.formState.getFormError("referral_code"),onInput:t[11]||(t[11]=o=>e.customerState.saveStateDebounced("Referral code changed"))},null,8,["modelValue","errorText"])]),n(d,{rows:"2",label:"Notes",type:"textarea",modelValue:e.customerForm.notes,"onUpdate:modelValue":t[12]||(t[12]=o=>e.customerForm.notes=o),errorText:e.formState.getFormError("notes"),placeholder:"Say something about the customer",onInput:t[13]||(t[13]=o=>e.customerState.saveStateDebounced("Notes changed"))},null,8,["modelValue","errorText"]),n(F,{label:"Tags",options:m.tags,placeholder:"Add tag",modelValue:e.customerForm.tags,"onUpdate:modelValue":t[14]||(t[14]=o=>e.customerForm.tags=o),errorText:e.formState.getFormError("tags"),onChange:t[15]||(t[15]=o=>e.customerState.saveStateDebounced("Tags changed"))},null,8,["options","modelValue","errorText"])]),n(x,{title:"Address",onlyValidate:!0,pinLocationOnMap:!0,onOnDeleted:e.unsetAddress,onOnValidated:e.setAddress,address:e.customerForm.address,triggerClass:"space-y-4 p-4 rounded-lg shadow-lg bg-white",subtitle:e.customerForm.address?"Change customer address":"Add customer address"},null,8,["onOnDeleted","onOnValidated","address","subtitle"])]),e.customer?(l(),c("div",{key:0,class:N(["flex items-center justify-between space-x-4 overflow-hidden rounded-lg p-4 border mb-20",e.isLoadingCustomer?"border-gray-300 bg-gray-50":"border-red-300 bg-red-50"])},[i("div",tt,[i("p",null,[t[17]||(t[17]=g("Delete ")),i("span",et,h(e.customerForm.name),1),t[18]||(t[18]=g("?"))]),t[19]||(t[19]=i("p",{class:"text-sm"},"Once this customer is deleted you will not be able to recover it.",-1))]),i("div",st,[n(w,{triggerType:"danger",approveType:"danger",approveLeftIcon:m.Trash2,triggerText:"Delete Customer",approveText:"Delete Customer",approveAction:e.deleteCustomer,triggerLoading:e.isDeletingCustomer,approveLoading:e.isDeletingCustomer},{content:y(()=>[t[22]||(t[22]=i("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Confirm Delete",-1)),i("p",rt,[t[20]||(t[20]=g("Are you sure you want to permanently delete ")),i("span",ot,h(e.customerForm.name),1),t[21]||(t[21]=g("?"))])]),_:1},8,["approveLeftIcon","approveAction","triggerLoading","approveLoading"])])],2)):S("",!0)])])])}const Bt=q(M,[["render",at]]);export{Bt as default};
