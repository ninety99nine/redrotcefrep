import{I as q}from"./Input-xmg1-jx3.js";import{M as I}from"./Modal-lj_XHY8-.js";import{c as D}from"./cloneDeep-DrLrU9Pi.js";import{B as w}from"./Button-B0TvGvIg.js";import{L as j}from"./Loader-DpTxBFLW.js";import{P as H}from"./Popover-5BdqxDZI.js";import{S as N}from"./Skeleton-BbkRw7Um.js";import{B as R}from"./BackdropLoader-mdNS0HmB.js";import{P as C}from"./Pill-HxPM5V1z.js";import{S as k}from"./Search-Vhi2QS7N.js";import{c as d,b as i,a as l,g as y,r as g,F,f as P,o as c,i as f,t as m,e as _,d as T,n as $}from"./app-lQaTPIyZ.js";import{_ as v}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{T as x}from"./trash-2-CDYOtcvp.js";import{M as O}from"./move-left-Dhk8tFOU.js";import"./Copy-DQ-8ZEKw.js";import"./ShineEffect-C4eRWABu.js";import"./createLucideIcon-DWtItcWc.js";const A={inject:["formState","tagState","storeState","notificationState"],components:{Pill:C,Button:w,Search:k},data(){return{Trash2:x,productOptions:[],latestRequestId:null,cancelTokenSource:null,isLoadingProducts:!1}},watch:{store(s){s&&this.showProducts()}},computed:{store(){return this.storeState.store},tagForm(){return this.tagState.tagForm},tagProducts(){return this.tagForm.products},totalTagProducts(){return this.tagProducts.length},hasTagProducts(){return this.totalTagProducts>0}},methods:{async showProducts(s=null){var e,r;const t=++this.latestRequestId;try{this.isLoadingProducts=!0,this.cancelTokenSource&&this.cancelTokenSource.cancel("Request superseded by a newer one"),this.cancelTokenSource=axios.CancelToken.source();let a={params:{store_id:this.store.id,association:"team member",_relationships:["variant","photo"].join(","),_countable_relationships:["variants"].join(",")},cancelToken:this.cancelTokenSource.token};s&&(a.params.search=s);const o=await axios.get("/api/products",a);if(t!==this.latestRequestId)return;const h=o.data.data;this.productOptions=h.map(u=>({label:u.name,product:u}))}catch(a){if(axios.isCancel(a)||t!==this.latestRequestId)return;const o=((r=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:r.message)||(a==null?void 0:a.message)||"Something went wrong while fetching products";this.notificationState.showWarningNotification(o),this.formState.setServerFormErrors(a),console.error("Failed to fetch products:",a)}finally{if(t!==this.latestRequestId)return;this.isLoadingProducts=!1,this.cancelTokenSource=null}},addProduct(s){this.tagState.addProduct(s.product)},removeProduct(s){this.tagState.removeProduct(s)}},created(){this.store&&this.showProducts()}},V={class:"bg-white rounded-lg p-4 shadow-sm"},z={class:"flex items-center space-x-2 mb-4"},M={class:"w-full flex justify-between items-center"},U={class:"flex space-x-4 items-center"},W={key:0,class:"flex items-center justify-center w-10 h-10"},Y=["src"],G={class:"truncate"},J={key:0},K={class:"flex space-x-4 items-center"},Q={key:0,class:"flex items-center justify-center w-10 h-10"},X=["src"],Z={class:"truncate"},tt={key:1,class:"flex justify-center bg-gray-50 rounded-lg p-4"};function et(s,t,e,r,a,o){const p=g("Pill"),h=g("Search"),u=g("Button");return c(),d("div",V,[i("div",z,[t[0]||(t[0]=i("p",{class:"text-lg text-gray-700 font-semibold"},"Products",-1)),l(p,{type:"light",size:"xs"},{default:y(()=>[f(m(`${o.totalTagProducts} total`),1)]),_:1})]),l(h,{class:"mb-4",onSelected:o.addProduct,options:a.productOptions,isLoading:a.isLoadingProducts,placeholder:"Search products to add",search:n=>o.showProducts(n)},{option:y(n=>[i("div",M,[i("div",U,[n.option.product.photo?(c(),d("div",W,[i("img",{class:"w-full max-h-full object-contain rounded-lg flex-shrink-0",src:n.option.product.photo.path},null,8,Y)])):_("",!0),i("span",G,m(n.option.label),1)]),l(p,{type:n.option.product.visible?"success":"warning",size:"xs"},{default:y(()=>[f(m(n.option.product.visible?"visible":"hidden"),1)]),_:2},1032,["type"])])]),_:1},8,["onSelected","options","isLoading","search"]),o.hasTagProducts?(c(),d("div",J,[(c(!0),d(F,null,P(o.tagProducts,(n,S)=>(c(),d("div",{key:S,class:"flex items-center justify-between hover:bg-gray-100 rounded-lg py-2 px-4"},[i("div",K,[n.photo?(c(),d("div",Q,[i("img",{class:"w-full max-h-full object-contain rounded-lg flex-shrink-0",src:n.photo.path},null,8,X)])):_("",!0),i("span",Z,m(n.name),1),l(p,{type:n.visible?"success":"warning",size:"xs"},{default:y(()=>[f(m(n.visible?"visible":"hidden"),1)]),_:2},1032,["type"])]),l(u,{size:"xs",type:"bareDanger",leftIcon:a.Trash2,action:()=>o.removeProduct(S)},null,8,["leftIcon","action"])]))),128))])):(c(),d("div",tt,t[1]||(t[1]=[i("p",{class:"text-sm"},"No products added",-1)])))])}const st=v(A,[["render",et]]),at={inject:["formState","tagState","storeState","notificationState"],components:{Pill:C,Button:w,Search:k},data(){return{Trash2:x,customerOptions:[],latestRequestId:null,cancelTokenSource:null,isLoadingCustomers:!1}},watch:{store(s){s&&this.showCustomers()}},computed:{store(){return this.storeState.store},tagForm(){return this.tagState.tagForm},tagCustomers(){return this.tagForm.customers},totalTagCustomers(){return this.tagCustomers.length},hasTagCustomers(){return this.totalTagCustomers>0}},methods:{async showCustomers(s=null){var e,r;const t=++this.latestRequestId;try{this.isLoadingCustomers=!0,this.cancelTokenSource&&this.cancelTokenSource.cancel("Request superseded by a newer one"),this.cancelTokenSource=axios.CancelToken.source();let a={params:{store_id:this.store.id,association:"team member"},cancelToken:this.cancelTokenSource.token};s&&(a.params.search=s);const o=await axios.get("/api/customers",a);if(t!==this.latestRequestId)return;const h=o.data.data;this.customerOptions=h.map(u=>({label:u.name,customer:u}))}catch(a){if(axios.isCancel(a)||t!==this.latestRequestId)return;const o=((r=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:r.message)||(a==null?void 0:a.message)||"Something went wrong while fetching customers";this.notificationState.showWarningNotification(o),this.formState.setServerFormErrors(a),console.error("Failed to fetch customers:",a)}finally{if(t!==this.latestRequestId)return;this.isLoadingCustomers=!1,this.cancelTokenSource=null}},addCustomer(s){this.tagState.addCustomer(s.customer)},removeCustomer(s){this.tagState.removeCustomer(s)}},created(){this.store&&this.showCustomers()}},ot={class:"bg-white rounded-lg p-4 shadow-sm"},it={class:"flex items-center space-x-2 mb-4"},rt={key:0},nt={class:"truncate"},ct={key:1,class:"flex justify-center bg-gray-50 rounded-lg p-4"};function dt(s,t,e,r,a,o){const p=g("Pill"),h=g("Search"),u=g("Button");return c(),d("div",ot,[i("div",it,[t[0]||(t[0]=i("p",{class:"text-lg text-gray-700 font-semibold"},"Customers",-1)),l(p,{type:"light",size:"xs"},{default:y(()=>[f(m(`${o.totalTagCustomers} total`),1)]),_:1})]),l(h,{class:"mb-4",onSelected:o.addCustomer,options:a.customerOptions,isLoading:a.isLoadingCustomers,placeholder:"Search customers to add",search:n=>o.showCustomers(n)},null,8,["onSelected","options","isLoading","search"]),o.hasTagCustomers?(c(),d("div",rt,[(c(!0),d(F,null,P(o.tagCustomers,(n,S)=>(c(),d("div",{key:S,class:"flex items-center justify-between hover:bg-gray-100 rounded-lg py-2 px-4"},[i("span",nt,m(n.name),1),l(u,{size:"xs",type:"bareDanger",leftIcon:a.Trash2,action:()=>o.removeCustomer(S)},null,8,["leftIcon","action"])]))),128))])):(c(),d("div",ct,t[1]||(t[1]=[i("p",{class:"text-sm"},"No customers added",-1)])))])}const gt=v(at,[["render",dt]]),lt={inject:["formState","storeState","tagState","changeHistoryState","notificationState"],components:{Input:q,Modal:I,Button:w,Loader:j,Popover:H,Skeleton:N,BackdropLoader:R,TagProducts:st,TagCustomers:gt},data(){return{Trash2:x,MoveLeft:O,products:[]}},watch:{store(s){s&&this.setup()},"$route.params.tag_id"(s){s&&(this.setup(),this.setActionButtons())}},computed:{store(){return this.storeState.store},tag(){return this.tagState.tag},hasTag(){return this.tagState.hasTag},tagId(){return this.$route.params.tag_id},isLoadingStore(){return this.storeState.isLoadingStore},isLoadingTag(){return this.tagState.isLoadingTag},isEditing(){return["edit-product-tag","edit-customer-tag"].includes(this.$route.name)},isCreating(){return["create-product-tag","create-customer-tag"].includes(this.$route.name)},isEditingProductTag(){return this.$route.name=="edit-product-tag"},isCreatingProductTag(){return this.$route.name=="create-product-tag"},tagForm(){return this.tagState.tagForm},isSubmitting(){return this.changeHistoryState.actionButtons.length==0?!1:this.changeHistoryState.actionButtons[1].loading},isDeletingTag(){return this.tagState.isDeletingTag}},methods:{goBack(){this.navigateToTags()},async setup(){this.tagForm==null&&this.tagState.setTagForm(null,this.isCreating),this.isEditing&&this.store&&await this.showTag()},async navigateToTags(){await this.$router.replace({name:this.isEditingProductTag||this.isCreatingProductTag?"show-product-tags":"show-customer-tags",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async onView(s){await this.$router.push({name:this.$route.name=="create-product-tag"?"edit-product-tag":"edit-customer-tag",params:{tag_id:s.id},query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async showTag(){var s,t;try{this.tagState.isLoadingTag=!0;let e={params:{store_id:this.store.id,_relationships:[this.isEditingProductTag||this.isCreatingProductTag?"products.photo":"customers"].join(",")}};const a=(await axios.get(`/api/tags/${this.tagId}`,e)).data;this.tagState.setTag(a),this.tagState.setTagForm(a)}catch(e){const r=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Something went wrong while fetching tag";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(e),console.error("Failed to fetch tag:",e),e.status==404&&await this.$router.replace({name:"show-tags",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})}finally{this.tagState.isLoadingTag=!1}},async createTag(){var s,t;try{if(this.tagState.isCreatingTag||(this.formState.hideFormErrors(),(this.tagForm.name==null||this.tagForm.name.trim()==="")&&this.formState.setFormError("name","The name is required"),this.formState.hasErrors))return;this.tagState.isCreatingTag=!0,this.changeHistoryState.actionButtons[1].loading=!0;const e={...this.getPayload(),store_id:this.store.id},a=(await axios.post("/api/tags",e)).data.tag;this.tagForm.id=a.id,this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Tag created"),this.tagState.saveOriginalState("Original tag"),await this.onView(a)}catch(e){const r=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Something went wrong while creating tag";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(e),console.error("Failed to create tag:",e)}finally{this.tagState.isCreatingTag=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async updateTag(){var s,t;try{if(this.tagState.isUpdatingTag||(this.formState.hideFormErrors(),(this.tagForm.name==null||this.tagForm.name.trim()==="")&&this.formState.setFormError("name","The name is required"),this.formState.hasErrors))return;this.tagState.isUpdatingTag=!0,this.changeHistoryState.actionButtons[1].loading=!0;const e={...this.getPayload(),store_id:this.store.id};await axios.put(`/api/tags/${this.tagForm.id}`,e),this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Tag updated"),this.tagState.saveOriginalState("Original tag")}catch(e){const r=((t=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:t.message)||(e==null?void 0:e.message)||"Something went wrong while updating tag";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(e),console.error("Failed to update tag:",e)}finally{this.tagState.isUpdatingTag=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async deleteTag(s){var t,e;try{if(this.tagState.isDeletingTag)return;this.tagState.isDeletingTag=!0;const r={data:{store_id:this.store.id}};await axios.delete(`/api/tags/${this.tag.id}`,r),this.storeState.silentUpdate(),s(),await new Promise(a=>setTimeout(a,1e3)),this.notificationState.showSuccessNotification("Tag deleted"),await this.navigateToTags()}catch(r){const a=((e=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:e.message)||(r==null?void 0:r.message)||"Something went wrong while deleting tag";this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(r),console.error("Failed to delete tag:",r)}finally{this.tagState.isDeletingTag=!1,s()}},getPayload(){let s=D(this.tagForm);return s.product_ids=s.products.map(t=>t.id),delete s.products,s},setActionButtons(){(this.isCreating||this.isEditing)&&(this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(this.onDiscard),this.changeHistoryState.addActionButton(this.isEditing?"Save Changes":"Create Tag",this.isEditing?this.updateTag:this.createTag,"primary",null))},setTagForm(s){this.tagState.tagForm=s}},beforeRouteLeave(s,t,e){if(this.changeHistoryState.hasChangeHistory&&!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return e(!1);e()},unmounted(){this.tagState.reset(),this.changeHistoryState.reset()},created(){this.setup(),this.setActionButtons();const s=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let t=0;t<s.length;t++){let e=s[t];this.changeHistoryState.listeners[e]=this.setTagForm}}},ut={class:"pt-24 px-4"},ht={class:"grid grid-cols-12 gap-4 mb-4"},mt={class:"col-span-8 col-start-3"},pt={class:"select-none bg-white rounded-lg p-4 mb-4"},ft={class:"flex items-center space-x-4"},St={key:0,class:"flex items-center space-x-2"},yt={key:1,class:"flex items-center space-x-1"},_t={class:"text-lg text-gray-700 font-semibold"},Tt={class:"relative mb-8"},wt={class:"bg-white rounded-lg space-y-4 p-4"},vt={class:"relative mb-8"},xt={class:"space-y-2"},bt={class:"font-bold text-black"},Ct={class:"flex justify-end"},kt={class:"mb-8"},Ft={class:"font-bold text-black"};function Pt(s,t,e,r,a,o){const p=g("Button"),h=g("Skeleton"),u=g("Popover"),n=g("BackdropLoader"),S=g("Input"),L=g("TagProducts"),E=g("TagCustomers"),B=g("Modal");return c(),d("div",ut,[i("div",ht,[i("div",mt,[i("div",pt,[i("div",ft,[l(p,{size:"xs",type:"light",action:o.goBack,leftIcon:a.MoveLeft},{default:y(()=>t[2]||(t[2]=[i("span",null,"Back",-1)])),_:1,__:[2]},8,["action","leftIcon"]),o.isLoadingStore||o.isLoadingTag||o.isEditing&&!o.hasTag?(c(),d("div",St,[l(h,{width:"w-40"}),l(h,{width:"w-4"})])):(c(),d("div",yt,[i("h1",_t,m(o.isCreating?"Add Tag":o.tagForm.name||"..."),1),l(u,{content:"Tags are keywords or labels that highlight specific features of your products, helping customers discover related items more easily.",placement:"top"})]))])]),i("div",Tt,[o.isLoadingTag||o.isSubmitting?(c(),T(n,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):_("",!0),i("div",wt,[l(S,{type:"text",label:"Name",placeholder:"Main Dish",modelValue:o.tagForm.name,"onUpdate:modelValue":t[0]||(t[0]=b=>o.tagForm.name=b),errorText:o.formState.getFormError("name"),onInput:t[1]||(t[1]=b=>o.tagState.saveStateDebounced("Name changed")),tooltipContent:"The name of your tag e.g Main Dish"},null,8,["modelValue","errorText"])])]),i("div",vt,[o.isLoadingTag||o.isSubmitting?(c(),T(n,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):_("",!0),o.isEditingProductTag||o.isCreatingProductTag?(c(),T(L,{key:1})):(c(),T(E,{key:2}))]),o.tag?(c(),d("div",{key:0,class:$(["flex items-center justify-between space-x-4 overflow-hidden rounded-lg p-4 border mb-20",o.isLoadingTag?"border-gray-300 bg-gray-50":"border-red-300 bg-red-50"])},[i("div",xt,[i("p",null,[t[3]||(t[3]=f("Delete ")),i("span",bt,m(o.tagForm.name),1),t[4]||(t[4]=f("?"))]),t[5]||(t[5]=i("p",{class:"text-sm"},"Once this tag is deleted you will not be able to recover it.",-1))]),i("div",Ct,[l(B,{triggerType:"danger",approveType:"danger",approveLeftIcon:a.Trash2,triggerText:"Delete Tag",approveText:"Delete Tag",approveAction:o.deleteTag,triggerLoading:o.isDeletingTag,approveLoading:o.isDeletingTag},{content:y(()=>[t[8]||(t[8]=i("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Confirm Delete",-1)),i("p",kt,[t[6]||(t[6]=f("Are you sure you want to permanently delete ")),i("span",Ft,m(o.tagForm.name),1),t[7]||(t[7]=f("?"))])]),_:1},8,["approveLeftIcon","approveAction","triggerLoading","approveLoading"])])],2)):_("",!0)])])])}const Wt=v(lt,[["render",Pt]]);export{Wt as default};
