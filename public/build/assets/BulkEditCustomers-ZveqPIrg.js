import{c as m,b as a,a as u,g as h,r as w,h as C,o as d,F as y,f as _,n as E,e as c,w as F,d as U,t as S,i as T}from"./app-CaCDZNvD.js";import{i as V}from"./isEqual-C-TSbD7k.js";import{I as P}from"./Input-CI0gKfpk.js";import{M as A}from"./Modal-B0SwX18I.js";import{L as M}from"./Loader-C6t2-ZQM.js";import{B as N}from"./Button-CMAESCwz.js";import{D as L}from"./Dropdown-C-ct582I.js";import{T as B}from"./Table-5GemRj8j.js";import{a as q}from"./stringUtils-Bvzw0-oW.js";import{_ as I}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{R as j}from"./refresh-ccw-C1cdGvMt.js";import{T as H}from"./trash-2-B_yhlISY.js";import{P as O}from"./plus-BsLTh-Ke.js";import"./Copy-DtqSf0U1.js";import"./ShineEffect-9Bzjo95p.js";import"./createLucideIcon-hJfW1V63.js";import"./Popover-1WlbTYZh.js";import"./x-Do1GLDRA.js";import"./Skeleton-KK-V-B9B.js";import"./circle-check-CFrnoQ4d.js";import"./circle-alert-ChEGa5ss.js";import"./parsePhoneNumber-DR0S47Bc.js";import"./Pill-CfzFjwDX.js";import"./Select-CJEvn7MY.js";import"./Paginator-CDzCbTsx.js";import"./Drawer-BPOs_ACI.js";import"./SelectCountry-DKZVHq57.js";import"./Datepicker-CQnjtjto.js";import"./chevron-up-CHJq7Wo_.js";import"./Switch-Z6sczeAN.js";import"./vue-draggable-next.esm-bundler-DDZvFHTU.js";import"./move-6uIJOqKA.js";import"./rotate-ccw-DvkZlnyi.js";const W={inject:["formState","customerState","storeState","changeHistoryState","notificationState"],components:{Input:P,Modal:A,Loader:M,Button:N,Dropdown:L,Table:B},data(){return{Plus:O,Trash2:H,RefreshCcw:j,notes:null,perPage:"15",checkedRows:[],pagination:null,searchTerm:null,selectAll:!1,latestRequestId:0,filterExpressions:[],sortingExpressions:[],isDeletingProducIds:[],deletableCustomer:null,cancelTokenSource:null,isLoadingCustomers:!1,isUpdatingCustomers:!1,columns:this.prepareColumns(),includeCustomerFieldNames:!0,bulkSelectionOptions:[{label:"Add Customer Notes",action:this.showUpdateCustomersModal},{label:"Delete",action:this.showDeleteCustomersModal}]}},watch:{store(r,t){!t&&r&&this.showCustomers()},selectAll(r){this.checkedRows=this.customerForms.reduce((t,o)=>(t[o.id]=r,t),{})}},computed:{store(){return this.storeState.store},hasSearchTerm(){return this.isNotEmpty(this.searchTerm)},isDeletingCustomers(){return this.isDeletingProducIds.length>0},totalCheckedRows(){return Object.values(this.checkedRows).filter(r=>r).length},hasFilterExpressions(){return this.filterExpressions.length>0},hasSortingExpressions(){return this.sortingExpressions.length>0},customerForms(){return this.customerState.customerForms}},methods:{isNotEmpty:q,prepareColumns(){const r=["First Name","Last Name","Mobile","Email","Birthday","Notes","Referral Code"],t=["First Name","Last Name","Mobile","Email","Birthday","Notes","Referral Code"];return r.map(o=>({name:o,active:t.includes(o),priority:t.includes(o)}))},showDeleteCustomersModal(){this.$refs.actionDropdown.hideDropdown(),this.$refs.deleteCustomersModal.showModal()},showUpdateCustomersModal(){this.$refs.actionDropdown.hideDropdown(),this.$refs.updateCustomersModal.showModal()},showDeleteConfirmationModal(r){this.deletableCustomer=r,this.$refs.deleteCustomerModal.showModal()},isDeletingCustomer(r){return r==null?!1:this.isDeletingProducIds.findIndex(t=>t==r.id)!=-1},onView(r){this.$router.push({name:"edit-customer",params:{customer_id:r.id},query:{store_id:this.store.id,searchTerm:this.searchTerm,filterExpressions:this.filterExpressions.join("|"),sortingExpressions:this.sortingExpressions.join("|")}})},onAddCustomer(){this.$router.push({name:"create-customer",query:{store_id:this.store.id}})},captureChange(r,t){this.customerForms[r].modified=!0,this.customerState.saveStateDebounced(t)},paginate(r){this.showCustomers(r)},search(r){this.searchTerm=r,this.showCustomers()},updatedColumns(r){this.columns=r},updatedFilters(r){const t=r.map(o=>o.expression);V(this.filterExpressions,t)||(this.filterExpressions=t,this.showCustomers())},updatedSorting(r){const t=r.map(o=>o.expression);V(this.sortingExpressions,t)||(this.sortingExpressions=t,this.showCustomers())},updatedPerPage(r){this.perPage=r,this.showCustomers()},async showCustomers(r=1){var o,n;const t=++this.latestRequestId;try{this.isLoadingCustomers=!0,this.cancelTokenSource&&this.cancelTokenSource.cancel("Request superseded by a newer one"),this.cancelTokenSource=C.CancelToken.source();let s={params:{page:r,per_page:this.perPage,store_id:this.store.id},cancelToken:this.cancelTokenSource.token};this.hasSearchTerm&&(s.params.search=this.searchTerm),this.hasFilterExpressions&&(s.params._filters=this.filterExpressions.join("|")),this.hasSortingExpressions&&(s.params._sort=this.sortingExpressions.join("|"));const e=await C.get("/api/customers",s);if(t!==this.latestRequestId)return;this.pagination=e.data;const b=this.pagination.data;this.customerState.setCustomerForms(b),this.checkedRows=this.customerForms.reduce((x,p)=>(x[p.id]=!1,x),{})}catch(s){if(C.isCancel(s)||t!==this.latestRequestId)return;const e=((n=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:n.message)||(s==null?void 0:s.message)||"Something went wrong while fetching customers";this.notificationState.showWarningNotification(e),this.formState.setServerFormErrors(s),console.error("Failed to fetch customers:",s)}finally{if(t!==this.latestRequestId)return;this.isLoadingCustomers=!1,this.cancelTokenSource=null}},async updateCustomers(r=null){var t,o;try{if(this.isUpdatingCustomers)return;const n={store_id:this.store.id};r==null?n.customers=this.customerForms.filter(e=>e.modified):n.customers=this.customerForms.filter(e=>this.checkedRows[e.id]).map(e=>({id:e.id})),r=="notes"&&(n.notes=this.notes),n.customers.length>0&&(this.isUpdatingCustomers=!0,await C.put("/api/customers",n),this.showCustomers(),this.notificationState.showSuccessNotification("Customers updated")),n.customers.forEach(e=>{this.checkedRows[e.id]!==void 0&&(this.checkedRows[e.id]=!1)}),this.selectAll=!1}catch(n){const s=((o=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:o.message)||(n==null?void 0:n.message)||"Something went wrong while updating customer";this.notificationState.showWarningNotification(s),this.formState.setServerFormErrors(n),console.error("Failed to update customer:",n)}finally{this.isUpdatingCustomers=!1,this.$refs.updateCustomersModal.hideModal()}},async deleteCustomers(){var r,t;try{const o=this.customerForms.filter(s=>this.checkedRows[s.id]).map(s=>s.id).filter(s=>!this.isDeletingProducIds.includes(s));if(o.length===0)return;this.isDeletingProducIds.push(...o);const n={data:{store_id:this.store.id,customer_ids:o}};await C.delete("/api/customers",n),this.notificationState.showSuccessNotification(o==1?"Customer deleted":"Customers deleted"),this.customerState.customerForms=this.customerForms.filter(s=>!o.includes(s.id)),this.customerForms.length==0&&this.showCustomers(),this.isDeletingProducIds=this.isDeletingProducIds.filter(s=>!o.includes(s)),o.forEach(s=>{this.checkedRows[s]!==void 0&&(this.checkedRows[s]=!1)}),this.selectAll=!1}catch(o){const n=((t=(r=o==null?void 0:o.response)==null?void 0:r.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while deleting customers";this.notificationState.showWarningNotification(n),this.formState.setServerFormErrors(o),console.error("Failed to delete customers:",o)}finally{this.$refs.deleteCustomersModal.hideModal()}},async deleteCustomer(){var r,t;try{if(this.isDeletingProducIds.includes(this.deletableCustomer.id))return;this.isDeletingProducIds.push(this.deletableCustomer.id);const o={data:{store_id:this.store.id}};await C.delete(`/api/customers/${this.deletableCustomer.id}`,o),this.notificationState.showSuccessNotification("Customer deleted"),this.customerState.customerForms=this.customerForms.filter(n=>n.id!=this.deletableCustomer.id),this.customerForms.length==0&&this.showCustomers()}catch(o){const n=((t=(r=o==null?void 0:o.response)==null?void 0:r.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while deleting customer";this.notificationState.showWarningNotification(n),this.formState.setServerFormErrors(o),console.error("Failed to delete customer:",o)}finally{this.isDeletingProducIds.splice(this.isDeletingProducIds.findIndex(o=>o==this.deletableCustomer.id),1),this.$refs.deleteCustomerModal.hideModal()}},setActionButtons(){this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(),this.changeHistoryState.addActionButton("Save Changes",this.updateCustomers,"primary",null)},setCustomerForms(r){this.customerState.customerForms=r}},unmounted(){this.customerState.reset()},created(){this.setActionButtons();const r=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let t=0;t<r.length;t++){let o=r[t];this.changeHistoryState.listeners[o]=this.setCustomerForms}this.isLoadingCustomers=!0,this.searchTerm=this.$route.query.searchTerm,this.$route.query.filterExpressions&&(this.filterExpressions=this.$route.query.filterExpressions.split("|")),this.$route.query.sortingExpressions&&(this.sortingExpressions=this.$route.query.sortingExpressions.split("|")),this.store&&this.showCustomers()}},z={class:"pt-24 px-8 relative select-none"},Y={class:"relative bg-white/80 p-4 rounded-md"},Z={class:"flex items-center space-x-2"},G={scope:"col",class:"whitespace-nowrap align-center px-4 py-4"},J={key:0,scope:"col",class:"whitespace-nowrap align-center pr-4 py-4"},K={key:0,class:"whitespace-nowrap align-center pr-4 py-4"},Q={key:1,class:"whitespace-nowrap align-center pr-4 py-4"},X={key:2,class:"whitespace-nowrap align-center pr-4 py-4"},$={key:3,class:"whitespace-nowrap align-center pr-4 py-4"},ee={key:4,class:"whitespace-nowrap align-center pr-4 py-4"},te={key:5,class:"whitespace-nowrap align-center pr-4 py-4"},se={key:6,class:"whitespace-nowrap align-center pr-4 py-4"},oe={key:2,class:"align-center pr-4 py-4"},re={class:"flex items-center space-x-4"},ie=["onClick"],ae=["onClick"],ne={class:"flex justify-between items-end p-10 bg-blue-50 border-t border-blue-200"},le={class:"space-y-4 mb-8"},de={class:"flex space-x-2 items-center p-4 text-xs bg-red-50 rounded-lg mb-8"},me={class:"text-red-500"},ue={key:0,class:"mb-8"},ce={class:"font-bold text-black"};function pe(r,t,o,n,s,e){const b=w("Button"),x=w("Dropdown"),p=w("Input"),D=w("Loader"),R=w("Table"),k=w("Modal");return d(),m("div",z,[t[16]||(t[16]=a("img",{src:"/images/clouds.png",class:"absolute bottom-0"},null,-1)),a("div",Y,[t[9]||(t[9]=a("h1",{class:"text-lg text-gray-700 font-semibold mb-4"},"Bulk Edit",-1)),u(R,{onSearch:e.search,columns:s.columns,perPage:s.perPage,resource:"customers",onPaginate:e.paginate,onRefresh:e.showCustomers,searchTerm:s.searchTerm,pagination:s.pagination,isLoading:s.isLoadingCustomers,onUpdatedColumns:e.updatedColumns,onUpdatedFilters:e.updatedFilters,onUpdatedSorting:e.updatedSorting,onUpdatedPerPage:e.updatedPerPage,filterExpressions:s.filterExpressions,sortingExpressions:s.sortingExpressions,searchPlaceholder:"Search by customer name, phone, email or notes"},{afterRefreshButton:h(()=>[a("div",Z,[u(b,{size:"xs",type:"primary",leftIcon:s.Plus,action:e.onAddCustomer},{default:h(()=>t[3]||(t[3]=[a("span",null,"Add Customer",-1)])),_:1,__:[3]},8,["leftIcon","action"])])]),belowToolbar:h(()=>[a("div",{class:E([{hidden:e.totalCheckedRows==0},"bg-gray-50 border border-gray-200 flex items-center mb-2 p-4 rounded-lg shadow space-x-2"])},[t[4]||(t[4]=a("span",{class:"text-sm"},"Actions: ",-1)),u(x,{ref:"actionDropdown",dropdownClasses:"w-72",options:s.bulkSelectionOptions},{triggerText:h(()=>[a("span",null,"Select Action ("+S(`${e.totalCheckedRows} selected`)+")",1)]),_:1},8,["options"])],2)]),head:h(()=>[a("tr",null,[a("th",G,[u(p,{type:"checkbox",modelValue:s.selectAll,"onUpdate:modelValue":t[0]||(t[0]=g=>s.selectAll=g)},null,8,["modelValue"])]),(d(!0),m(y,null,_(s.columns,(g,i)=>(d(),m(y,{key:i},[g.active?(d(),m("th",J,S(g.name),1)):c("",!0)],64))),128)),t[5]||(t[5]=a("th",{scope:"col",class:"whitespace-nowrap align-center pr-4 py-4"},null,-1))])]),body:h(()=>[(d(!0),m(y,null,_(e.customerForms,(g,i)=>(d(),m("tr",{key:g.id,class:E([s.checkedRows[g.id]?"bg-blue-50":"bg-white hover:bg-gray-50","group cursor-pointer border-b border-blue-100"])},[(d(!0),m(y,null,_(s.columns,(f,v)=>(d(),m(y,{key:v},[v==0?(d(),m("td",{key:0,onClick:t[1]||(t[1]=F(()=>{},["stop"])),class:"whitespace-nowrap align-center px-4 py-4"},[u(p,{type:"checkbox",modelValue:s.checkedRows[g.id],"onUpdate:modelValue":l=>s.checkedRows[g.id]=l},null,8,["modelValue","onUpdate:modelValue"])])):c("",!0),f.active?(d(),m(y,{key:1},[f.name=="First Name"?(d(),m("td",K,[u(p,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].first_name,"onUpdate:modelValue":l=>e.customerForms[i].first_name=l,onInput:l=>e.captureChange(i,"First name changed"),errorText:e.formState.getFormError(`customer.${i}.first_name`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Last Name"?(d(),m("td",Q,[u(p,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].last_name,"onUpdate:modelValue":l=>e.customerForms[i].last_name=l,onInput:l=>e.captureChange(i,"Last name changed"),errorText:e.formState.getFormError(`customer.${i}.last_name`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Mobile"?(d(),m("td",X,[u(p,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].mobile_number,"onUpdate:modelValue":l=>e.customerForms[i].mobile_number=l,onInput:l=>e.captureChange(i,"Mobile number changed"),errorText:e.formState.getFormError(`customer.${i}.mobile_number`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Email"?(d(),m("td",$,[u(p,{type:"text",class:"min-w-60",modelValue:e.customerForms[i].email,"onUpdate:modelValue":l=>e.customerForms[i].email=l,onInput:l=>e.captureChange(i,"Email changed"),errorText:e.formState.getFormError(`customer.${i}.email`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Birthday"?(d(),m("td",ee,[u(p,{type:"date",class:"min-w-40",modelValue:e.customerForms[i].birthday,"onUpdate:modelValue":l=>e.customerForms[i].birthday=l,onInput:l=>e.captureChange(i,"Birthday changed"),errorText:e.formState.getFormError(`customer.${i}.birthday`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Referral Code"?(d(),m("td",te,[u(p,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].referral_code,"onUpdate:modelValue":l=>e.customerForms[i].referral_code=l,onInput:l=>e.captureChange(i,"Referral code changed"),errorText:e.formState.getFormError(`customer.${i}.referral_code`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Notes"?(d(),m("td",se,[u(p,{type:"text",class:"min-w-80",modelValue:e.customerForms[i].notes,"onUpdate:modelValue":l=>e.customerForms[i].notes=l,onInput:l=>e.captureChange(i,"Notes changed"),errorText:e.formState.getFormError(`customer.${i}.notes`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0)],64)):c("",!0),v==s.columns.length-1?(d(),m("td",oe,[a("div",re,[e.isDeletingCustomer(e.customerForms[i])?c("",!0):(d(),m("span",{key:0,onClick:F(l=>e.onView(e.customerForms[i]),["stop","prevent"]),class:"text-sm font-medium text-blue-600 dark:text-blue-500 hover:underline"},"View",8,ie)),e.isDeletingCustomer(e.customerForms[i])?(d(),U(D,{key:1,type:"danger"},{default:h(()=>t[6]||(t[6]=[a("span",{class:"text-xs ml-2"},"Deleting...",-1)])),_:1,__:[6]})):(d(),m("span",{key:2,onClick:F(l=>e.showDeleteConfirmationModal(e.customerForms[i]),["stop","prevent"]),class:"text-sm font-medium text-red-600 dark:text-red-500 hover:underline"},"Delete",8,ae))])])):c("",!0)],64))),128))],2))),128))]),noResults:h(()=>[a("div",ne,[t[8]||(t[8]=a("div",null,[a("h1",{class:"text-2xl font-bold mb-4"}," Ready For Your First Sale? "),a("p",{class:"text-sm text-gray-500"}," Your customers will appear here once customers start shopping. ")],-1)),a("div",null,[u(b,{size:"lg",type:"primary",leftIcon:s.Plus,action:e.onAddCustomer},{default:h(()=>t[7]||(t[7]=[a("span",null,"Add Customer",-1)])),_:1,__:[7]},8,["leftIcon","action"])])])]),_:1},8,["onSearch","columns","perPage","onPaginate","onRefresh","searchTerm","pagination","isLoading","onUpdatedColumns","onUpdatedFilters","onUpdatedSorting","onUpdatedPerPage","filterExpressions","sortingExpressions"])]),u(k,{approveType:"primary",scrollOnContent:!1,ref:"updateCustomersModal",leftApproveIcon:s.RefreshCcw,approveText:"Update Customers",approveLoading:s.isUpdatingCustomers,approveAction:()=>e.updateCustomers("notes")},{content:h(()=>[t[10]||(t[10]=a("p",{class:"text-lg font-bold border-b border-dashed border-gray-200 pb-4 mb-4"},"Update Customers",-1)),a("div",le,[u(p,{rows:"2",class:"w-full",type:"textarea",modelValue:s.notes,"onUpdate:modelValue":t[2]||(t[2]=g=>s.notes=g),label:"Customer Notes",placeholder:`Say something about the ${e.totalCheckedRows==1?"customer":"customers"}`},null,8,["modelValue","placeholder"])])]),_:1},8,["leftApproveIcon","approveLoading","approveAction"]),u(k,{approveType:"danger",ref:"deleteCustomersModal",leftApproveIcon:s.Trash2,approveAction:e.deleteCustomers,approveLoading:e.isDeletingCustomers,approveText:e.totalCheckedRows==1?"Delete Customer":"Delete Customers"},{content:h(()=>[t[12]||(t[12]=a("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Delete Customers",-1)),a("div",de,[t[11]||(t[11]=a("svg",{class:"w-6 h-6 text-red-500 shrink-0",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"})],-1)),a("span",me,"Are you sure you want to delete "+S(e.totalCheckedRows>1?`these ${e.totalCheckedRows} customers`:"this customer")+"?",1)])]),_:1},8,["leftApproveIcon","approveAction","approveLoading","approveText"]),u(k,{approveType:"danger",ref:"deleteCustomerModal",leftApproveIcon:s.Trash2,approveText:"Delete Customer",approveAction:e.deleteCustomer,approveLoading:e.isDeletingCustomer(s.deletableCustomer)},{content:h(()=>[t[15]||(t[15]=a("p",{class:"text-lg font-bold border-b border-dashed border-gray-200 pb-4 mb-4"},"Confirm Delete",-1)),s.deletableCustomer?(d(),m("p",ue,[t[13]||(t[13]=T("Are you sure you want to permanently delete ")),a("span",ce,S(s.deletableCustomer.name),1),t[14]||(t[14]=T("?"))])):c("",!0)]),_:1},8,["leftApproveIcon","approveAction","approveLoading"])])}const Ze=I(W,[["render",pe]]);export{Ze as default};
