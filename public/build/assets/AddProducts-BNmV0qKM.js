import{I as N}from"./Input-B2ak7xuW.js";import{B as R}from"./Button-CPqWnTAQ.js";import{S as z,R as L}from"./StoreLogo-oGjJYh_S.js";import{a as D,i as M}from"./stringUtils-Bvzw0-oW.js";import{c as n,b as r,a as g,e as u,F as v,f as U,i as y,t as w,n as A,k as x,g as S,r as b,o as l,w as F,d as I}from"./app-qohHnai2.js";import{_ as B}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as V}from"./external-link-uSoPx_cC.js";import{C as W}from"./cloud-upload-DXX6SWrv.js";import{C as q}from"./check-nRCYUTKI.js";import{X as O}from"./x-D2eEjOWs.js";import"./Copy-BivnTeSq.js";import"./ShineEffect-bdFyZnCD.js";import"./createLucideIcon-DFF6csNE.js";import"./Popover-BLOHpHVX.js";import"./Tooltip-DNCrFSbg.js";import"./Skeleton-TldU7eME.js";import"./capitalize-ChUSrr1V.js";import"./refresh-ccw-gHkE3gSp.js";import"./circle-check-CkMv-4m2.js";import"./circle-alert-y8k_vQsc.js";import"./parsePhoneNumber-xMTQFMCS.js";import"./Loader-BkdSj3Qz.js";import"./plus-Dn-tsknJ.js";const X={inject:["formState","storeState","notificationState"],components:{X:O,Check:q,RefreshCw:L,CloudUpload:W,ExternalLink:V,Input:N,Button:R,StoreLogo:z},data(){return{products:[],maxProducts:5,fileInputs:[],uploadMessage:"",isUploading:!1,totalCompletedSteps:0,maxPhotosPerProduct:5,totalCompletedUploads:0,isCreatingProducts:!1,formErrorMessagesIndex:null}},computed:{logo(){return this.store.logo},store(){return this.storeState.store},progressPercentage(){return this.totalCompletionSteps===0?0:Math.round(this.totalCompletedSteps/this.totalCompletionSteps*100)},totalUploads(){return this.products.reduce((o,e)=>o+e.photos.length,0)},totalFailedUploads(){return this.products.reduce((o,e)=>o+e.photos.filter(i=>i.uploaded===!1).length,0)},totalCompletionSteps(){return this.products.length+this.totalUploads},hasCompletedSteps(){return this.totalCompletedSteps>0},hasFailedUploads(){return this.totalFailedUploads>0},hasReachedProductLimit(){return this.maxProducts==this.products.length}},methods:{isEmpty:M,isNotEmpty:D,addProduct(){this.products.push({id:null,name:"",photos:[],unit_regular_price:"0.00"})},removeProduct(o){this.products.splice(o,1)},productIsUploading(o){return this.products[o].photos.filter(e=>e.uploading===!0).length>0},productHasFailedUploads(o){return this.products[o].photos.filter(e=>e.uploaded===!1).length},setFileInputRef(o,e){o&&(this.fileInputs[e]=o)},triggerFileInput(o){if(this.isCreatingProducts||this.isUploading){this.notificationState.showWarningNotification("Still creating products");return}if(typeof o!="number"){console.log(`âš ï¸ Invalid index: ${o}`,o);return}this.fileInputs[o]?this.fileInputs[o].click():console.log(`âš ï¸ File input not found for index: ${o}`)},handleFileUpload(o,e){const i=o.target.files;i.length&&(this.processFiles(i,e),this.$nextTick(()=>{this.fileInputs[e].value=""}))},handleDrop(o,e){o.preventDefault();const i=o.dataTransfer.files;this.processFiles(i,e)},processFiles(o,e){if(!o.length)return;const i=this.products[e],a=i.photos.length,t=this.maxPhotosPerProduct-a;if(t<=0){this.notificationState.showWarningNotification(`You can only upload up to ${this.maxPhotosPerProduct} photos per product.`);return}const m=Array.from(o).slice(0,t).map(f=>new Promise(c=>{const _=new FileReader;_.onload=P=>{i.photos.push({path:URL.createObjectURL(f),error_message:null,uploading:!1,uploaded:null,file_ref:f}),c()},_.readAsDataURL(f)}));Promise.all(m).then(()=>{this.uploadProductImages(i)})},removePhoto(o,e,i){o&&(o.preventDefault(),o.stopPropagation()),this.products[e].photos.splice(i,1)},submit(){this.isCreatingProducts||this.isUploading||(this.totalCompletedSteps==0?this.submitProducts():this.navigateToAddPayments())},async submitProducts(){for(const[e,i]of this.products.entries()){if(this.isEmpty(i.name)){this.formState.setFormError("name","The product name is required",e),this.notificationState.showWarningNotification("The product name is required"),this.formErrorMessagesIndex=e;return}if(this.isEmpty(i.unit_regular_price)){this.formState.setFormError("unit_regular_price","The product price is required",e),this.notificationState.showWarningNotification("The product price is required"),this.formErrorMessagesIndex=e;return}}this.isCreatingProducts=!0;let o=this.products.map(async e=>{var i,a;try{let t={return:"1",store_id:this.store.id,name:e.name,unit_regular_price:e.unit_regular_price};this.uploadMessage=`Creating ${e.name}`;const s=await axios.post("/api/products",t);this.totalCompletedSteps++;let m=s.data.product;return e.id=m.id,this.uploadProductImages(e)}catch(t){const s=((a=(i=t==null?void 0:t.response)==null?void 0:i.data)==null?void 0:a.message)||(t==null?void 0:t.message)||`Something went wrong while creating ${e.name}`;this.notificationState.showWarningNotification(s),this.formState.setServerFormErrors(t),console.error("Failed to create product:",t)}});await Promise.allSettled(o).then(e=>{let i=0,a=[];e.forEach((t,s)=>{var m;t.status==="fulfilled"?(i++,this.notificationState.showSuccessNotification(`${this.products[s].name} created successfully`)):(a.push(`Product ${s+1}: ${((m=t.reason)==null?void 0:m.message)||"An error occurred"}`),this.formErrorMessagesIndex=s,this.formState.setServerFormErrors(t.reason,s))}),i&&this.notificationState.showSuccessNotification("Products added!"),a.length>0&&this.notificationState.showWarningNotification(a.join(`
`))}).catch(e=>{this.notificationState.showWarningNotification("An unexpected error occurred while submitting products."),console.error(e)}).finally(()=>{this.isCreatingProducts=!1}),this.totalCompletedSteps>0&&!this.isUploading&&this.totalFailedUploads==0&&this.navigateToAddPayments()},async uploadProductImages(o,e=null){if(!o.id)return Promise.resolve();let i=[];for(let a=0;a<o.photos.length;a++){const t=o.photos[a];(t.uploaded===null||t.uploaded===!1)&&(e==null||e==a)&&i.push(this.uploadSingleImage(o,t,a))}return i.length?(this.isUploading=!0,this.uploadMessage="Uploading photos",Promise.allSettled(i).then(a=>{let t=a.filter(s=>s.status==="rejected").length;t>0&&this.notificationState.showWarningNotification(`âš ï¸ ${t} image(s) failed to upload. Try again or change the image.`),this.isUploading=!1})):Promise.resolve()},async uploadSingleImage(o,e,i,a=0,t=null){var s,m,f;try{if(a>2)return console.log(`âŒ Image ${i+1} permanently failed after 3 attempts.`),e.uploaded=!1,e.uploading=!1,e.error_message=((m=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:m.message)||(t==null?void 0:t.message)||"Something went wrong while uploading photo",Promise.reject("Failed after 3 attempts");let c=new FormData;c.append("file",e.file_ref),c.append("store_id",this.store.id),c.append("mediable_type","product"),c.append("mediable_id",o.id),c.append("upload_folder_name","product_photo"),e.uploading=!0,e.error_message=null;const _={headers:{"Content-Type":"multipart/form-data"}},P=await axios.post("/api/media-files",c,_);return e.uploaded=!0,e.uploading=!1,this.totalCompletedSteps++,this.totalCompletedUploads++,this.uploadMessage=`Uploaded ${this.totalCompletedUploads}/${this.totalUploads} photos`,console.log(`âœ… Image ${i+1} uploaded successfully.`),P}catch(c){return console.error(`âš ï¸ Image ${i+1} upload attempt ${a+1} failed.`,c),c.code==="ECONNABORTED"||((f=c.response)==null?void 0:f.status)===504?void 0:this.uploadSingleImage(o,e,i,a+1,c)}},navigateToAddPayments(){this.$router.push({name:"add-payments",params:{store_id:this.store.id}})}},beforeRouteLeave(o,e,i){if(this.isCreatingProducts||this.isUploading){if(!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return i(!1)}else if(this.totalCompletedSteps==0&&this.products.some(a=>this.isNotEmpty(a.name)||a.photos.length>0)&&!window.confirm("Are you sure you want to leave before adding products?"))return i(!1);i()},created(){this.addProduct()}},H={class:"min-h-screen flex flex-col items-center pb-40"},Y={class:"w-full max-w-lg"},K={class:"w-full max-w-lg"},G={class:"space-y-2 mb-4"},J={class:"flex items-center space-x-1 font-bold mb-4"},Q={class:"w-5 h-5 flex items-center justify-center bg-gray-100 rounded-full text-xs"},Z=["onClick","onDrop"],$={key:0},ee={key:1},te=["onChange"],se={key:0,class:"grid grid-cols-3 gap-2"},oe={key:0,class:"absolute z-10 top-1 right-1 bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"},re={class:"absolute z-10 top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"},ie=["onClick"],ae=["onClick"],le={key:1,class:x(["absolute inset-0 bg-gray-900/80 bg-opacity-50 rounded-lg flex items-center justify-center"])},ne=["src"],de={key:2,class:"bg-red-500/20 py-2 px-4 relative rounded-b-lg text-xs"},ue={key:0,class:"space-y-2 mb-4"},pe={key:0,class:"text-sm text-blue-600 font-semibold bg-blue-100 border border-blue-300 p-3 rounded-lg shadow-md text-center"},ce={class:"underline"},me={class:"font-bold"},ge={key:1,class:"text-xs text-blue-600 font-semibold bg-blue-100 border border-blue-300 p-3 rounded-lg shadow-md"},he={class:"flex items-center space-x-2"},fe={key:0},ye={class:"mt-2 p-2 border-t border-dotted border-blue-300"},be={class:"font-normal space-y-1"},_e={href:"https://tinypng.com/",target:"_blank",class:"underline inline-flex items-center"},we={key:1,class:"mb-4"},xe={class:"w-full max-w-lg bg-gray-200 rounded-full h-2 mb-2"},Pe={class:"text-xs text-center mt-2 font-bold"};function Ce(o,e,i,a,t,s){const m=b("StoreLogo"),f=b("Input"),c=b("Check"),_=b("X"),P=b("RefreshCw"),C=b("Button"),E=b("CloudUpload"),j=b("ExternalLink");return l(),n("div",H,[r("div",Y,[g(m,{showButton:!1,class:"flex justify-center mb-4"}),e[1]||(e[1]=r("h2",{class:"text-2xl font-semibold text-center mb-2"},"Add Products",-1)),e[2]||(e[2]=r("p",{class:"text-gray-500 text-center mb-6"},"Keep it simpleâ€”just the essentials to get started! ðŸš€",-1))]),r("div",K,[r("div",G,[(l(!0),n(v,null,U(t.products,(h,p)=>(l(),n("div",{key:p,class:x(["space-y-3 bg-white p-4 shadow-lg rounded-xl"])},[r("div",J,[e[3]||(e[3]=r("span",{class:"text-sm"},"Product",-1)),r("div",Q,w(p+1),1)]),g(f,{type:"text",modelValue:h.name,"onUpdate:modelValue":d=>h.name=d,placeholder:"Standard Ticket",errorText:s.formState.getFormError("name",p)},null,8,["modelValue","onUpdate:modelValue","errorText"]),g(f,{type:"money",modelValue:h.unit_regular_price,"onUpdate:modelValue":d=>h.unit_regular_price=d,currencySymbol:s.store.currency.symbol,errorText:s.formState.getFormError("unit_regular_price",p)},null,8,["modelValue","onUpdate:modelValue","currencySymbol","errorText"]),r("div",null,[e[4]||(e[4]=r("label",{class:"block text-sm font-medium text-gray-700 dark:text-gray-200"},[y(" Images "),r("span",{class:"font-normal text-gray-500"},"(Optional)")],-1)),h.photos.length<t.maxPhotosPerProduct?(l(),n("div",{key:0,onDragover:e[0]||(e[0]=F(()=>{},["prevent"])),onClick:()=>s.triggerFileInput(p),onDrop:d=>s.handleDrop(d,p),class:"mt-2 w-full h-20 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 text-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"},[h.photos.length?(l(),n("p",ee,"Upload More Images")):(l(),n("p",$,"Click or Drag & Drop Images")),r("input",{multiple:"",type:"file",class:"hidden",accept:"image/*",ref_for:!0,ref:d=>s.setFileInputRef(d,p),onChange:d=>s.handleFileUpload(d,p)},null,40,te)],40,Z)):u("",!0)]),h.photos.length?(l(),n("div",se,[(l(!0),n(v,null,U(h.photos,(d,k)=>(l(),n("div",{key:k,class:"relative group"},[d.uploading?u("",!0):(l(),n(v,{key:0},[d.uploaded===!0?(l(),n("div",oe,[g(c,{size:"16"})])):d.uploaded===!1?(l(),n(v,{key:1},[r("div",re,[g(_,{size:"16"})]),r("div",{onClick:()=>s.uploadProductImages(h,k),class:"flex items-center justify-center w-8 h-8 rounded-full bg-yellow-500 text-white hover:bg-yellow-600 active:scale-95 absolute z-10 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 cursor-pointer"},[g(P,{size:"16"})],8,ie),e[5]||(e[5]=r("div",{class:"absolute inset-0 bg-white/80 bg-opacity-80 border border-red-500 rounded-lg flex items-center justify-center"},null,-1))],64)):u("",!0),!d.uploaded&&!d.uploading?(l(),n("div",{key:2,onClick:F(T=>s.removePhoto(T,p,k),["stop"]),class:"absolute z-10 top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition cursor-pointer"},[g(_,{size:"16"})],8,ae)):u("",!0)],64)),d.uploading?(l(),n("div",le,[...e[6]||(e[6]=[r("span",{class:"text-white text-xs font-bold"},"Uploading...",-1)])])):u("",!0),r("img",{src:d.path,class:"w-full h-24 p-4 object-contain rounded-lg border border-gray-300 dark:border-gray-700"},null,8,ne),d.error_message?(l(),n("p",de,w(d.error_message),1)):u("",!0)]))),128))])):u("",!0),s.productHasFailedUploads(p)?(l(),n("div",{key:1,class:x(["flex justify-end pt-2",{"pb-4":p==t.products.length-1}])},[g(C,{size:"xs",type:"warning",icon:"refresh",disabled:s.productIsUploading(p),action:()=>s.uploadProductImages(h)},{default:S(()=>[...e[7]||(e[7]=[r("span",null,"Retry Uplaods",-1)])]),_:1},8,["disabled","action"])],2)):u("",!0),t.products.length>1&&!s.hasCompletedSteps?(l(),n("div",{key:2,class:x(["flex justify-end pt-2",{"pb-4":p==t.products.length-1}])},[t.isCreatingProducts?u("",!0):(l(),I(C,{key:0,size:"xs",icon:"delete",type:"danger",action:()=>s.removeProduct(p)},{default:S(()=>[...e[8]||(e[8]=[r("span",null,"Remove Product",-1)])]),_:1},8,["action"]))],2)):u("",!0),p==t.products.length-1&&!s.hasReachedProductLimit&&!s.hasCompletedSteps?(l(),n("div",{key:3,class:x(["flex justify-center pt-4",{"border-t-2 border-dashed border-gray-100":t.products.length>1}])},[p==t.products.length-1&&!t.isCreatingProducts?(l(),I(C,{key:0,size:"sm",icon:"add",type:"light",action:s.addProduct},{default:S(()=>[...e[9]||(e[9]=[r("span",null,"Add Product",-1)])]),_:1},8,["action"])):u("",!0)],2)):u("",!0)]))),128))]),s.hasReachedProductLimit||s.hasFailedUploads||s.formState.hasErrors?(l(),n("div",ue,[s.hasReachedProductLimit?(l(),n("p",pe,[e[11]||(e[11]=y(" Let's work with ",-1)),r("span",ce,[r("span",me,w(t.maxProducts),1),e[10]||(e[10]=y(" products",-1))]),e[12]||(e[12]=y(" for now! ðŸš€ ",-1))])):u("",!0),s.hasFailedUploads?(l(),n("div",ge,[r("div",he,[g(E,{size:"36"}),r("div",null,[r("p",null,[e[13]||(e[13]=y(" We could not upload ",-1)),s.totalFailedUploads?(l(),n("span",fe,w(s.totalFailedUploads)+" "+w(s.totalFailedUploads==1?"photo":"photos")+". ",1)):u("",!0)]),e[14]||(e[14]=r("p",null,"But no worriesâ€”you can always add more later! ðŸ˜Š",-1))])]),r("div",ye,[r("ul",be,[e[18]||(e[18]=r("li",null,"âœ… Make sure youâ€™re uploading images (jpeg, jpg, png, gif or svg).",-1)),e[19]||(e[19]=r("li",null,"âœ… Ensure your images are not too large (we accept up to 5MB).",-1)),r("li",null,[e[16]||(e[16]=y("âœ… Use ",-1)),r("a",_e,[e[15]||(e[15]=y(" tinypng.com ",-1)),g(j,{size:"10",class:"ml-1"})]),e[17]||(e[17]=y(" to reduce image size (itâ€™s free). ",-1))])])])])):u("",!0)])):u("",!0),t.isCreatingProducts||t.isUploading||s.progressPercentage===100?(l(),n("div",we,[r("div",xe,[r("div",{class:x(["h-2 rounded-full transition-all duration-500",s.progressPercentage===100?"bg-green-500":"bg-blue-500"]),style:A({width:s.progressPercentage+"%"})},null,6)]),r("p",Pe,w(s.progressPercentage===100?"Upload Complete ðŸŽ‰":`${t.uploadMessage} (${s.progressPercentage}%)`),1)])):u("",!0),g(C,{size:"lg",type:"primary",action:s.submit,buttonClass:"w-full",loading:t.isCreatingProducts,disabled:t.isCreatingProducts},{default:S(()=>[...e[20]||(e[20]=[r("span",null,"Continue",-1)])]),_:1},8,["action","loading","disabled"])])])}const Ye=B(X,[["render",Ce]]);export{Ye as default};
