import{I as L}from"./Input-BtMsYEQC.js";import{M as D}from"./Modal-kjURmp1k.js";import{c as h,b as i,a as c,d as C,g as S,r as g,o as u,i as v,t as f,e as b,F as B,f as I,w as V,j as U,A as q}from"./app-NqhLBX5U.js";import{B as x}from"./Button-DQZsVgv2.js";import{L as N}from"./Loader-Cx-EKtVY.js";import{S as j}from"./Select-D6ibtGLL.js";import{P as H}from"./Popover-B8o2G8jc.js";import{i as M}from"./stringUtils-Bvzw0-oW.js";import{S as A}from"./Skeleton-CrFOPy1K.js";import{V as F}from"./vue-draggable-next.esm-bundler-BlYdwj8Y.js";import{B as O}from"./BackdropLoader-BlspkjIg.js";import{P as R}from"./Pill-DpqrMa0r.js";import{S as z}from"./Search-D6j3M_2l.js";import{_ as T}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{M as W}from"./move-CMQ-4NJm.js";import{T as k}from"./trash-2-C8lxGBuv.js";import{M as G}from"./move-left-uceyjw08.js";import"./Copy-Balf8fLz.js";import"./ShineEffect-D1afC5Ah.js";import"./createLucideIcon-DnmJ9UE3.js";import"./x-BAZkSzS9.js";import"./refresh-ccw-D0BER8Gi.js";import"./circle-check-CR2oW9jw.js";import"./circle-alert-CK7NUARt.js";import"./parsePhoneNumber-DR0S47Bc.js";const Y={inject:["formState","categoryState","storeState","notificationState"],components:{Move:W,Pill:R,Button:x,Search:z,draggable:F},data(){return{Trash2:k,productOptions:[],latestRequestId:null,cancelTokenSource:null,isLoadingProducts:!1}},watch:{store(a,t){!t&&a&&this.showProducts()}},computed:{store(){return this.storeState.store},categoryForm(){return this.categoryState.categoryForm},categoryProducts(){return this.categoryForm.products},totalCategoryProducts(){return this.categoryProducts.length},hasCategoryProducts(){return this.totalCategoryProducts>0}},methods:{async showProducts(a=null){var o,r;const t=++this.latestRequestId;try{this.isLoadingProducts=!0,this.cancelTokenSource&&this.cancelTokenSource.cancel("Request superseded by a newer one"),this.cancelTokenSource=axios.CancelToken.source();let s={params:{store_id:this.store.id,association:"team member",_relationships:["variant","photo"].join(","),_countable_relationships:["variants"].join(",")},cancelToken:this.cancelTokenSource.token};a&&(s.params.search=a);const e=await axios.get("/api/products",s);if(t!==this.latestRequestId)return;const y=e.data.data;this.productOptions=y.map(l=>({label:l.name,product:l}))}catch(s){if(axios.isCancel(s)||t!==this.latestRequestId)return;const e=((r=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:r.message)||(s==null?void 0:s.message)||"Something went wrong while fetching products";this.notificationState.showWarningNotification(e),this.formState.setServerFormErrors(s),console.error("Failed to fetch products:",s)}finally{if(t!==this.latestRequestId)return;this.isLoadingProducts=!1,this.cancelTokenSource=null}},addProduct(a){this.categoryState.addProduct(a.product)},removeProduct(a){this.categoryState.removeProduct(a)}},created(){this.store&&this.showProducts()}},$={class:"bg-white rounded-lg p-4 shadow-sm"},J={class:"flex items-center space-x-2 mb-4"},K={class:"w-full flex justify-between items-center"},Q={class:"flex space-x-4 items-center"},X={key:0,class:"flex items-center justify-center w-10 h-10"},Z=["src"],tt={class:"truncate"},et={class:"flex space-x-4 items-center"},ot={key:0,class:"flex items-center justify-center w-10 h-10"},st=["src"],at={class:"text-sm truncate"},rt={class:"flex items-center space-x-4"},it={key:1,class:"flex justify-center bg-gray-50 rounded-lg p-4"};function nt(a,t,o,r,s,e){const m=g("Pill"),y=g("Search"),l=g("Button"),w=g("Move"),p=g("draggable");return u(),h("div",$,[i("div",J,[t[3]||(t[3]=i("p",{class:"text-lg text-gray-700 font-semibold"},"Products",-1)),c(m,{type:"light",size:"xs"},{default:S(()=>[v(f(`${e.totalCategoryProducts} total`),1)]),_:1})]),c(y,{class:"mb-4",onSelected:e.addProduct,options:s.productOptions,isLoading:s.isLoadingProducts,placeholder:"Search products to add",search:n=>e.showProducts(n)},{option:S(n=>[i("div",K,[i("div",Q,[n.option.product.photo?(u(),h("div",X,[i("img",{class:"w-full max-h-full object-contain rounded-lg flex-shrink-0",src:n.option.product.photo.path},null,8,Z)])):b("",!0),i("span",tt,f(n.option.label),1)]),c(m,{type:n.option.product.visible?"success":"warning",size:"xs"},{default:S(()=>[v(f(n.option.product.visible?"visible":"hidden"),1)]),_:2},1032,["type"])])]),_:1},8,["onSelected","options","isLoading","search"]),e.hasCategoryProducts?(u(),C(p,{key:0,handle:".draggable-handle","ghost-class":"bg-yellow-50",modelValue:e.categoryForm.products,"onUpdate:modelValue":t[1]||(t[1]=n=>e.categoryForm.products=n),class:"divide-y divide-gray-200 mb-4",onChange:t[2]||(t[2]=n=>e.categoryState.saveStateDebounced("Product arrangement changed"))},{default:S(()=>[(u(!0),h(B,null,I(e.categoryForm.products,(n,_)=>(u(),h("div",{key:_,class:"flex items-center justify-between hover:bg-gray-100 min-h-16 px-4"},[i("div",et,[n.photo?(u(),h("div",ot,[i("img",{class:"w-full max-h-full object-contain rounded-lg flex-shrink-0",src:n.photo.path},null,8,st)])):b("",!0),i("span",at,f(n.name),1),c(m,{type:n.visible?"success":"warning",size:"xs"},{default:S(()=>[v(f(n.visible?"visible":"hidden"),1)]),_:2},1032,["type"])]),i("div",rt,[c(l,{size:"xs",type:"bareDanger",leftIcon:s.Trash2,action:()=>e.removeProduct(_)},null,8,["leftIcon","action"]),c(w,{onClick:t[0]||(t[0]=V(()=>{},["stop"])),size:"16",class:"draggable-handle cursor-grab active:cursor-grabbing text-gray-500 hover:text-yellow-500"})])]))),128))]),_:1},8,["modelValue"])):(u(),h("div",it,t[4]||(t[4]=[i("p",{class:"text-sm"},"No products added",-1)])))])}const lt=T(Y,[["render",nt]]),ct={inject:["formState","storeState","categoryState","changeHistoryState","notificationState"],components:{Input:L,Modal:D,Button:x,Loader:N,Select:j,Popover:H,Skeleton:A,draggable:F,BackdropLoader:O,CategoryProducts:lt},data(){return{Trash2:k,MoveLeft:G,products:[],visibilityTypes:[{label:"Visible",value:!0},{label:"Hidden",value:!1}]}},watch:{store(a,t){!t&&a&&this.setup()},"$route.params.category_id"(a){a&&(this.setup(),this.setActionButtons())}},computed:{store(){return this.storeState.store},category(){return this.categoryState.category},hasCategory(){return this.categoryState.hasCategory},categoryId(){return this.$route.params.category_id},isLoadingStore(){return this.storeState.isLoadingStore},isLoadingCategory(){return this.categoryState.isLoadingCategory},isEditing(){return this.$route.name==="edit-category"},isCreating(){return this.$route.name==="create-category"},categoryForm(){return this.categoryState.categoryForm},isSubmitting(){return this.changeHistoryState.actionButtons.length==0?!1:this.changeHistoryState.actionButtons[1].loading},isDeletingCategory(){return this.categoryState.isDeletingCategory}},methods:{isEmpty:M,goBack(){this.navigateToCategories()},async setup(){this.categoryForm==null&&this.categoryState.setCategoryForm(null,this.isCreating),this.isEditing&&this.store&&await this.showCategory()},async navigateToCategories(){await this.$router.replace({name:"show-categories",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async onView(a){await this.$router.push({name:"edit-category",params:{category_id:a.id},query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async showCategory(){var a,t,o;try{this.categoryState.isLoadingCategory=!0;let r={params:{store_id:this.store.id,_relationships:["photos","products.photo"].join(",")}};const e=(await axios.get(`/api/categories/${this.categoryId}`,r)).data;this.categoryState.setCategory(e),this.categoryState.setCategoryForm(e)}catch(r){const s=((t=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:t.message)||(r==null?void 0:r.message)||"Something went wrong while fetching category";this.notificationState.showWarningNotification(s),this.formState.setServerFormErrors(r),console.error("Failed to fetch category:",r),((o=r.response)==null?void 0:o.status)===404&&await this.$router.replace({name:"show-categories",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})}finally{this.categoryState.isLoadingCategory=!1}},async createCategory(){var a,t;try{if(this.categoryState.isCreatingCategory||this.categoryState.isUploading||(this.formState.hideFormErrors(),this.isEmpty(this.categoryForm.name)&&this.formState.setFormError("name","The name is required"),this.formState.hasErrors))return;this.categoryState.isCreatingCategory=!0,this.changeHistoryState.actionButtons[1].loading=!0;const o={...this.getPayload(),store_id:this.store.id},s=(await axios.post("/api/categories",o)).data.category;this.categoryForm.id=s.id,this.categoryForm.photos.length&&await this.uploadImages(this.categoryForm.id),this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Category created"),this.categoryState.saveOriginalState("Original category"),await this.onView(s)}catch(o){const r=((t=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while creating category";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(o),console.error("Failed to create category:",o)}finally{this.categoryState.isUploading=!1,this.categoryState.isCreatingCategory=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async updateCategory(){var a,t;try{if(this.categoryState.isUpdatingCategory||this.categoryState.isUploading||(this.formState.hideFormErrors(),this.isEmpty(this.categoryForm.name)&&this.formState.setFormError("name","The name is required"),this.formState.hasErrors))return;this.categoryState.isUpdatingCategory=!0,this.changeHistoryState.actionButtons[1].loading=!0;const o={...this.getPayload(),store_id:this.store.id};await axios.put(`/api/categories/${this.categoryForm.id}`,o),this.categoryForm.photos.length&&await this.uploadImages(this.categoryForm.id),this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Category updated"),this.categoryState.saveOriginalState("Original category")}catch(o){const r=((t=(a=o==null?void 0:o.response)==null?void 0:a.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while updating category";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(o),console.error("Failed to update category:",o)}finally{this.categoryState.isUploading=!1,this.categoryState.isUpdatingCategory=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async deleteCategory(a){var t,o;try{if(this.categoryState.isDeletingCategory)return;this.categoryState.isDeletingCategory=!0;const r={data:{store_id:this.store.id}};await axios.delete(`/api/categories/${this.category.id}`,r),this.storeState.silentUpdate(),a(),await new Promise(s=>setTimeout(s,500)),this.notificationState.showSuccessNotification("Category deleted"),await this.navigateToCategories()}catch(r){const s=((o=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:o.message)||(r==null?void 0:r.message)||"Something went wrong while deleting category";this.notificationState.showWarningNotification(s),this.formState.setServerFormErrors(r),console.error("Failed to delete category:",r),a()}finally{this.categoryState.isDeletingCategory=!1}},async uploadImages(a,t=null){let o=this.categoryForm.photos,r=[];for(let s=0;s<o.length;s++){let e=o[s];e.id==null&&e.uploading==!1&&(e.uploaded===null||e.uploaded===!1)&&(t==null||t==s)&&r.push(this.uploadSingleImage(a,o[s],s))}if(r.length===0){this.categoryState.isUploading=!1;return}return this.categoryState.isUploading=!0,Promise.allSettled(r).then(s=>{let e=s.filter(m=>m.status==="rejected").length;e>0&&this.notificationState.showWarningNotification(`⚠️ ${e} image(s) failed to upload. Try again or change the image.`),this.categoryState.isUploading=!1})},async uploadSingleImage(a,t,o,r=0,s=null){var e,m,y;try{if(r>2)return console.log(`❌ Image ${o+1} permanently failed after 3 attempts.`),t.uploaded=!1,t.uploading=!1,t.error_message=((m=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:m.message)||(s==null?void 0:s.message)||"Upload failed",Promise.reject("Failed after 3 attempts");let l=new FormData;l.append("file",t.file_ref),l.append("mediable_id",a),l.append("store_id",this.store.id),l.append("mediable_type","category"),l.append("upload_folder_name","category_photo"),t.uploading=!0,t.error_message=null;const w={headers:{"Content-Type":"multipart/form-data"}},p=await axios.post("/api/media-files",l,w),n=p.data.media_file;return t.uploaded=!0,t.uploading=!1,t.id=n.id,t.path=n.path,console.log(`✅ Image ${o+1} uploaded successfully.`),p}catch(l){return console.error(`⚠️ Image ${o+1} upload attempt ${r+1} failed.`,l),l.code==="ECONNABORTED"||((y=l.response)==null?void 0:y.status)===504?void 0:this.uploadSingleImage(a,t,o,r+1,l)}},getPayload(){let a=q(this.categoryForm);return a.product_ids=a.products.map(t=>t.id),delete a.products,a},setActionButtons(){(this.isCreating||this.isEditing)&&(this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(),this.changeHistoryState.addActionButton(this.isEditing?"Save Changes":"Create Category",this.isEditing?this.updateCategory:this.createCategory,"primary",null))},setCategoryForm(a){this.categoryState.categoryForm=a}},beforeRouteLeave(a,t,o){if(this.changeHistoryState.hasChangeHistory&&!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return o(!1);o()},unmounted(){this.categoryState.reset()},created(){this.setup(),this.setActionButtons();const a=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let t=0;t<a.length;t++){let o=a[t];this.changeHistoryState.listeners[o]=this.setCategoryForm}}},dt={class:"pt-24 px-4"},gt={class:"grid grid-cols-12 gap-4 mb-4"},ut={class:"col-span-8 col-start-3"},mt={class:"select-none bg-white rounded-lg p-4 mb-4"},ht={class:"flex items-center space-x-4"},yt={key:0,class:"flex items-center space-x-2"},pt={key:1,class:"flex items-center space-x-1"},ft={class:"text-lg text-gray-700 font-semibold"},St={class:"relative mb-8"},vt={class:"bg-white rounded-lg space-y-4 p-4"},wt={class:"relative mb-8"},bt={class:"space-y-2"},_t={class:"font-bold text-black"},Ct={class:"flex justify-end"},xt={class:"mb-8"},Ft={class:"font-bold text-black"};function Tt(a,t,o,r,s,e){const m=g("Button"),y=g("Skeleton"),l=g("Popover"),w=g("BackdropLoader"),p=g("Input"),n=g("Select"),_=g("CategoryProducts"),E=g("Modal");return u(),h("div",dt,[i("div",gt,[i("div",ut,[i("div",mt,[i("div",ht,[c(m,{size:"xs",type:"light",action:e.goBack,leftIcon:s.MoveLeft},{default:S(()=>t[10]||(t[10]=[i("span",null,"Back",-1)])),_:1,__:[10]},8,["action","leftIcon"]),e.isLoadingStore||e.isLoadingCategory||e.isEditing&&!e.hasCategory?(u(),h("div",yt,[c(y,{width:"w-40"}),c(y,{width:"w-4"})])):(u(),h("div",pt,[i("h1",ft,f(e.isCreating?"Add Category":e.categoryForm.name||"..."),1),c(l,{content:"Categories are groups that help organize your products so customers can easily browse and find what they’re looking for.",placement:"top"})]))])]),i("div",St,[e.isLoadingCategory||e.isSubmitting?(u(),C(w,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):b("",!0),i("div",vt,[c(p,{type:"text",label:"Name",placeholder:"Main Dish",modelValue:e.categoryForm.name,"onUpdate:modelValue":t[0]||(t[0]=d=>e.categoryForm.name=d),errorText:e.formState.getFormError("name"),tooltipContent:"The name of your category e.g Main Dish",onInput:t[1]||(t[1]=d=>e.categoryState.saveStateDebounced("Name changed"))},null,8,["modelValue","errorText"]),c(n,{class:"w-full",search:!1,label:"Visibility",options:s.visibilityTypes,modelValue:e.categoryForm.visible,"onUpdate:modelValue":t[2]||(t[2]=d=>e.categoryForm.visible=d),errorText:e.formState.getFormError("visible"),onChange:t[3]||(t[3]=d=>e.categoryState.saveStateDebounced("Visibility status changed")),tooltipContent:"Turn on if you want your category to be visible (Made available to customers)"},null,8,["options","modelValue","errorText"]),c(p,{rows:"2",type:"textarea",label:"Description",modelValue:e.categoryForm.description,"onUpdate:modelValue":t[4]||(t[4]=d=>e.categoryForm.description=d),errorText:e.formState.getFormError("description"),description:"Description must be less than 100 characters",onInput:t[5]||(t[5]=d=>e.categoryState.saveStateDebounced("Description changed")),placeholder:"Delicious, filling meals that take center stage on your plate",tooltipContent:"Sweet and short description of your category e.g Delicious, filling meals that take center stage on your plate"},null,8,["modelValue","errorText"]),c(p,{type:"file",maxFiles:1,imagePreviewGridCols:1,modelValue:e.categoryForm.photos,"onUpdate:modelValue":t[6]||(t[6]=d=>e.categoryForm.photos=d),onRetryUploads:t[7]||(t[7]=d=>e.uploadImages(e.categoryForm.id)),onChange:t[8]||(t[8]=d=>e.categoryState.saveStateDebounced("Photos changed")),onRetryUpload:t[9]||(t[9]=(d,P)=>e.uploadImages(e.categoryForm.id,P))},null,8,["modelValue"])])]),i("div",wt,[e.isLoadingCategory||e.isSubmitting?(u(),C(w,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):b("",!0),c(_)]),e.category?(u(),h("div",{key:0,class:U(["flex items-center justify-between space-x-4 overflow-hidden rounded-lg p-4 border mb-20",e.isLoadingCategory?"border-gray-300 bg-gray-50":"border-red-300 bg-red-50"])},[i("div",bt,[i("p",null,[t[11]||(t[11]=v("Delete ")),i("span",_t,f(e.categoryForm.name),1),t[12]||(t[12]=v("?"))]),t[13]||(t[13]=i("p",{class:"text-sm"},"Once this category is deleted you will not be able to recover it.",-1))]),i("div",Ct,[c(E,{triggerType:"danger",approveType:"danger",approveLeftIcon:s.Trash2,triggerText:"Delete Category",approveText:"Delete Category",approveAction:e.deleteCategory,triggerLoading:e.isDeletingCategory,approveLoading:e.isDeletingCategory},{content:S(()=>[t[16]||(t[16]=i("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Confirm Delete",-1)),i("p",xt,[t[14]||(t[14]=v("Are you sure you want to permanently delete ")),i("span",Ft,f(e.categoryForm.name),1),t[15]||(t[15]=v("?"))])]),_:1},8,["approveLeftIcon","approveAction","triggerLoading","approveLoading"])])],2)):b("",!0)])])])}const Xt=T(ct,[["render",Tt]]);export{Xt as default};
