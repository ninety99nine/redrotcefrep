import{c as m,a as u,b as n,g as h,h as C,r as w,o as d,F as y,f as F,k as T,e as c,w as E,d as P,t as x,i as V}from"./app-BqBcK2Me.js";import{i as D}from"./index-BmkpYdFn.js";import{I as A}from"./Input-DjuOdbF1.js";import{M}from"./Modal-C-fODVOW.js";import{L as N}from"./Loader-BgqDxGis.js";import{B}from"./Button-BNac3Uy4.js";import{D as L}from"./Dropdown-DAhegZ8H.js";import{T as I}from"./Table-BvD-e7YZ.js";import{a as q}from"./stringUtils-Bvzw0-oW.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{U as H}from"./users-DxeaxKlN.js";import{R as z}from"./refresh-ccw-CRBonytR.js";import{T as O}from"./trash-2-CjbEW11q.js";import{P as W}from"./plus-DG46xS87.js";import"./Copy-Bc6MjpSO.js";import"./ShineEffect-DJP6tw7V.js";import"./createLucideIcon-OabOCuoO.js";import"./Popover-DiVqkWjb.js";import"./Tooltip-BzW-KZ4w.js";import"./Skeleton-BEzu_4lT.js";import"./capitalize-ChUSrr1V.js";import"./circle-check-DQp1AnuL.js";import"./circle-alert-DCWIbGb_.js";import"./x-PgxH0pkw.js";import"./parsePhoneNumber-xMTQFMCS.js";import"./Pill-0qkov1t4.js";import"./Select-LUycGOZz.js";import"./Paginator-C2SHUWxU.js";import"./Drawer-DjX_rRWH.js";import"./SelectCountry-DAzH5pe4.js";import"./Datepicker-CBhW7FEH.js";import"./chevron-down-C_8LTtlf.js";import"./chevron-up-CRebbkwY.js";import"./Switch-DHdUFK33.js";import"./vue-draggable-next.esm-bundler-kmF9HwhL.js";import"./move-CNLa0216.js";import"./rotate-ccw-Gb8UcEcQ.js";const Y={inject:["formState","customerState","storeState","changeHistoryState","notificationState"],components:{Users:H,Input:A,Modal:M,Loader:N,Button:B,Dropdown:L,Table:I},data(){return{Plus:W,Trash2:O,RefreshCcw:z,notes:null,perPage:"15",checkedRows:[],pagination:null,searchTerm:null,selectAll:!1,latestRequestId:0,filterExpressions:[],sortingExpressions:[],isDeletingProducIds:[],deletableCustomer:null,hasInitialResults:null,cancelTokenSource:null,isLoadingCustomers:!1,isUpdatingCustomers:!1,columns:this.prepareColumns(),includeCustomerFieldNames:!0,bulkSelectionOptions:[{label:"Add Customer Notes",action:this.showUpdateCustomersModal},{label:"Delete",action:this.showDeleteCustomersModal}]}},watch:{store(r,t){!t&&r&&this.showCustomers()},selectAll(r){this.checkedRows=this.customerForms.reduce((t,o)=>(t[o.id]=r,t),{})}},computed:{store(){return this.storeState.store},hasSearchTerm(){return this.isNotEmpty(this.searchTerm)},isDeletingCustomers(){return this.isDeletingProducIds.length>0},totalCheckedRows(){return Object.values(this.checkedRows).filter(r=>r).length},hasFilterExpressions(){return this.filterExpressions.length>0},hasSortingExpressions(){return this.sortingExpressions.length>0},customerForms(){return this.customerState.customerForms}},methods:{isNotEmpty:q,prepareColumns(){const r=["First Name","Last Name","Mobile","Email","Birthday","Notes","Referral Code"],t=["First Name","Last Name","Mobile","Email","Birthday","Notes","Referral Code"];return r.map(o=>({name:o,active:t.includes(o),priority:t.includes(o)}))},showDeleteCustomersModal(){this.$refs.actionDropdown.hideDropdown(),this.$refs.deleteCustomersModal.showModal()},showUpdateCustomersModal(){this.$refs.actionDropdown.hideDropdown(),this.$refs.updateCustomersModal.showModal()},showDeleteConfirmationModal(r){this.deletableCustomer=r,this.$refs.deleteCustomerModal.showModal()},isDeletingCustomer(r){return r==null?!1:this.isDeletingProducIds.findIndex(t=>t==r.id)!=-1},onView(r){this.$router.push({name:"edit-customer",params:{customer_id:r.id},query:{store_id:this.store.id,searchTerm:this.searchTerm,filterExpressions:this.filterExpressions.join("|"),sortingExpressions:this.sortingExpressions.join("|")}})},onAddCustomer(){this.$router.push({name:"create-customer",query:{store_id:this.store.id}})},captureChange(r,t){this.customerForms[r].modified=!0,this.customerState.saveStateDebounced(t)},paginate(r){this.showCustomers(r)},search(r){this.searchTerm=r,this.showCustomers()},updatedColumns(r){this.columns=r},updatedFilters(r){const t=r.map(o=>o.expression);D(this.filterExpressions,t)||(this.filterExpressions=t,this.showCustomers())},updatedSorting(r){const t=r.map(o=>o.expression);D(this.sortingExpressions,t)||(this.sortingExpressions=t,this.showCustomers())},updatedPerPage(r){this.perPage=r,this.showCustomers()},async showCustomers(r=1){var o,a;const t=++this.latestRequestId;try{this.isLoadingCustomers=!0,this.cancelTokenSource&&this.cancelTokenSource.cancel("Request superseded by a newer one"),this.cancelTokenSource=C.CancelToken.source();let s={params:{page:r,per_page:this.perPage,store_id:this.store.id},cancelToken:this.cancelTokenSource.token};this.hasSearchTerm&&(s.params.search=this.searchTerm),this.hasFilterExpressions&&(s.params._filters=this.filterExpressions.join("|")),this.hasSortingExpressions&&(s.params._sort=this.sortingExpressions.join("|"));const e=await C.get("/api/customers",s);if(t!==this.latestRequestId)return;this.pagination==null&&(this.hasInitialResults=e.data.meta.total>0),this.pagination=e.data;const k=this.pagination.data;this.customerState.setCustomerForms(k),this.checkedRows=this.customerForms.reduce((b,S)=>(b[S.id]=!1,b),{})}catch(s){if(C.isCancel(s)||t!==this.latestRequestId)return;const e=((a=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:a.message)||(s==null?void 0:s.message)||"Something went wrong while fetching customers";this.notificationState.showWarningNotification(e),this.formState.setServerFormErrors(s),console.error("Failed to fetch customers:",s)}finally{if(t!==this.latestRequestId)return;this.isLoadingCustomers=!1,this.cancelTokenSource=null}},async updateCustomers(r=null){var t,o;try{if(this.isUpdatingCustomers)return;const a={store_id:this.store.id};r==null?a.customers=this.customerForms.filter(e=>e.modified):a.customers=this.customerForms.filter(e=>this.checkedRows[e.id]).map(e=>({id:e.id})),r=="notes"&&(a.notes=this.notes),a.customers.length>0&&(this.isUpdatingCustomers=!0,await C.put("/api/customers",a),this.showCustomers(),this.notificationState.showSuccessNotification("Customers updated")),a.customers.forEach(e=>{this.checkedRows[e.id]!==void 0&&(this.checkedRows[e.id]=!1)}),this.selectAll=!1}catch(a){const s=((o=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:o.message)||(a==null?void 0:a.message)||"Something went wrong while updating customer";this.notificationState.showWarningNotification(s),this.formState.setServerFormErrors(a),console.error("Failed to update customer:",a)}finally{this.isUpdatingCustomers=!1,this.$refs.updateCustomersModal.hideModal()}},async deleteCustomers(){var r,t;try{const o=this.customerForms.filter(s=>this.checkedRows[s.id]).map(s=>s.id).filter(s=>!this.isDeletingProducIds.includes(s));if(o.length===0)return;this.isDeletingProducIds.push(...o);const a={data:{store_id:this.store.id,customer_ids:o}};await C.delete("/api/customers",a),this.notificationState.showSuccessNotification(o==1?"Customer deleted":"Customers deleted"),this.customerState.customerForms=this.customerForms.filter(s=>!o.includes(s.id)),this.customerForms.length==0&&this.showCustomers(),this.isDeletingProducIds=this.isDeletingProducIds.filter(s=>!o.includes(s)),o.forEach(s=>{this.checkedRows[s]!==void 0&&(this.checkedRows[s]=!1)}),this.selectAll=!1}catch(o){const a=((t=(r=o==null?void 0:o.response)==null?void 0:r.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while deleting customers";this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(o),console.error("Failed to delete customers:",o)}finally{this.$refs.deleteCustomersModal.hideModal()}},async deleteCustomer(){var r,t;try{if(this.isDeletingProducIds.includes(this.deletableCustomer.id))return;this.isDeletingProducIds.push(this.deletableCustomer.id);const o={data:{store_id:this.store.id}};await C.delete(`/api/customers/${this.deletableCustomer.id}`,o),this.notificationState.showSuccessNotification("Customer deleted"),this.customerState.customerForms=this.customerForms.filter(a=>a.id!=this.deletableCustomer.id),this.customerForms.length==0&&this.showCustomers()}catch(o){const a=((t=(r=o==null?void 0:o.response)==null?void 0:r.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while deleting customer";this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(o),console.error("Failed to delete customer:",o)}finally{this.isDeletingProducIds.splice(this.isDeletingProducIds.findIndex(o=>o==this.deletableCustomer.id),1),this.$refs.deleteCustomerModal.hideModal()}},setActionButtons(){this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(),this.changeHistoryState.addActionButton("Save Changes",this.updateCustomers,"primary",null)},setCustomerForms(r){this.customerState.customerForms=r}},unmounted(){this.customerState.reset()},created(){this.setActionButtons();const r=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let t=0;t<r.length;t++){let o=r[t];this.changeHistoryState.listeners[o]=this.setCustomerForms}this.isLoadingCustomers=!0,this.searchTerm=this.$route.query.searchTerm,this.$route.query.filterExpressions&&(this.filterExpressions=this.$route.query.filterExpressions.split("|")),this.$route.query.sortingExpressions&&(this.sortingExpressions=this.$route.query.sortingExpressions.split("|")),this.store&&this.showCustomers()}},Z={class:"pt-24 px-8 relative select-none"},G={key:0,class:"flex flex-col items-center justify-center bg-linear-to-b from-white p-8 rounded-2xl"},J={class:"bg-blue-200 text-blue-900 rounded-full p-10 mt-8 mb-16"},K={class:"mt-10"},Q={key:1,class:"relative bg-white/80 p-4 rounded-md mb-60"},X={class:"flex items-center space-x-2"},$={scope:"col",class:"whitespace-nowrap align-center px-4 py-4"},ee={key:0,scope:"col",class:"whitespace-nowrap align-center pr-4 py-4"},te={key:0,class:"whitespace-nowrap align-center pr-4 py-4"},se={key:1,class:"whitespace-nowrap align-center pr-4 py-4"},oe={key:2,class:"whitespace-nowrap align-center pr-4 py-4"},re={key:3,class:"whitespace-nowrap align-center pr-4 py-4"},ie={key:4,class:"whitespace-nowrap align-center pr-4 py-4"},ae={key:5,class:"whitespace-nowrap align-center pr-4 py-4"},ne={key:6,class:"whitespace-nowrap align-center pr-4 py-4"},le={key:2,class:"align-center pr-4 py-4"},de={class:"flex items-center space-x-4"},me=["onClick"],ue=["onClick"],ce={class:"space-y-4 mb-8"},pe={class:"flex space-x-2 items-center p-4 text-xs bg-red-50 rounded-lg mb-8"},he={class:"text-red-500"},ge={key:0,class:"mb-8"},fe={class:"font-bold text-black"};function we(r,t,o,a,s,e){const k=w("Users"),b=w("Button"),S=w("Dropdown"),g=w("Input"),R=w("Loader"),U=w("Table"),v=w("Modal");return d(),m("div",Z,[s.hasInitialResults==!1&&!this.hasFilterExpressions?(d(),m("div",G,[n("div",J,[u(k,{size:"40"})]),t[4]||(t[4]=n("div",{class:"text-center max-w-md"},[n("h1",{class:"text-3xl font-extrabold mb-3"}," Bulk Edit Customers "),n("p",{class:"text-base leading-relaxed"}," Your customers will appear here for fast bulk editing. You can add a customer yourself. ")],-1)),n("div",K,[u(b,{size:"lg",type:"primary",leftIcon:s.Plus,leftIconSize:"20",skeleton:!e.store,action:e.onAddCustomer},{default:h(()=>[...t[3]||(t[3]=[n("span",{class:"ml-1"},"Add Customer",-1)])]),_:1},8,["leftIcon","skeleton","action"])])])):(d(),m("div",Q,[t[9]||(t[9]=n("h1",{class:"text-lg font-semibold mb-4"},"Bulk Edit",-1)),u(U,{onSearch:e.search,columns:s.columns,perPage:s.perPage,resource:"customers",onPaginate:e.paginate,onRefresh:e.showCustomers,searchTerm:s.searchTerm,pagination:s.pagination,isLoading:s.isLoadingCustomers,onUpdatedColumns:e.updatedColumns,onUpdatedFilters:e.updatedFilters,onUpdatedSorting:e.updatedSorting,onUpdatedPerPage:e.updatedPerPage,filterExpressions:s.filterExpressions,sortingExpressions:s.sortingExpressions,searchPlaceholder:"Customer name, phone, email or notes"},{afterRefreshButton:h(()=>[n("div",X,[u(b,{size:"xs",type:"primary",leftIcon:s.Plus,action:e.onAddCustomer},{default:h(()=>[...t[5]||(t[5]=[n("span",null,"Add Customer",-1)])]),_:1},8,["leftIcon","action"])])]),belowToolbar:h(()=>[n("div",{class:T([{hidden:e.totalCheckedRows==0},"bg-gray-50 border border-gray-200 flex items-center mb-2 p-4 rounded-lg shadow space-x-2"])},[t[6]||(t[6]=n("span",{class:"text-sm"},"Actions: ",-1)),u(S,{ref:"actionDropdown",dropdownClasses:"w-72",options:s.bulkSelectionOptions},{triggerText:h(()=>[n("span",null,"Select Action ("+x(`${e.totalCheckedRows} selected`)+")",1)]),_:1},8,["options"])],2)]),head:h(()=>[n("tr",null,[n("th",$,[u(g,{type:"checkbox",modelValue:s.selectAll,"onUpdate:modelValue":t[0]||(t[0]=p=>s.selectAll=p)},null,8,["modelValue"])]),(d(!0),m(y,null,F(s.columns,(p,i)=>(d(),m(y,{key:i},[p.active?(d(),m("th",ee,x(p.name),1)):c("",!0)],64))),128)),t[7]||(t[7]=n("th",{scope:"col",class:"whitespace-nowrap align-center pr-4 py-4"},null,-1))])]),body:h(()=>[(d(!0),m(y,null,F(e.customerForms,(p,i)=>(d(),m("tr",{key:p.id,class:T([s.checkedRows[p.id]?"bg-blue-50":"bg-white hover:bg-gray-50","group cursor-pointer border-b border-blue-100"])},[(d(!0),m(y,null,F(s.columns,(f,_)=>(d(),m(y,{key:_},[_==0?(d(),m("td",{key:0,onClick:t[1]||(t[1]=E(()=>{},["stop"])),class:"whitespace-nowrap align-center px-4 py-4"},[u(g,{type:"checkbox",modelValue:s.checkedRows[p.id],"onUpdate:modelValue":l=>s.checkedRows[p.id]=l},null,8,["modelValue","onUpdate:modelValue"])])):c("",!0),f.active?(d(),m(y,{key:1},[f.name=="First Name"?(d(),m("td",te,[u(g,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].first_name,"onUpdate:modelValue":l=>e.customerForms[i].first_name=l,onInput:l=>e.captureChange(i,"First name changed"),errorText:e.formState.getFormError(`customer.${i}.first_name`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Last Name"?(d(),m("td",se,[u(g,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].last_name,"onUpdate:modelValue":l=>e.customerForms[i].last_name=l,onInput:l=>e.captureChange(i,"Last name changed"),errorText:e.formState.getFormError(`customer.${i}.last_name`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Mobile"?(d(),m("td",oe,[u(g,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].mobile_number,"onUpdate:modelValue":l=>e.customerForms[i].mobile_number=l,onInput:l=>e.captureChange(i,"Mobile number changed"),errorText:e.formState.getFormError(`customer.${i}.mobile_number`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Email"?(d(),m("td",re,[u(g,{type:"text",class:"min-w-60",modelValue:e.customerForms[i].email,"onUpdate:modelValue":l=>e.customerForms[i].email=l,onInput:l=>e.captureChange(i,"Email changed"),errorText:e.formState.getFormError(`customer.${i}.email`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Birthday"?(d(),m("td",ie,[u(g,{type:"date",class:"min-w-40",modelValue:e.customerForms[i].birthday,"onUpdate:modelValue":l=>e.customerForms[i].birthday=l,onInput:l=>e.captureChange(i,"Birthday changed"),errorText:e.formState.getFormError(`customer.${i}.birthday`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Referral Code"?(d(),m("td",ae,[u(g,{type:"text",class:"min-w-40",modelValue:e.customerForms[i].referral_code,"onUpdate:modelValue":l=>e.customerForms[i].referral_code=l,onInput:l=>e.captureChange(i,"Referral code changed"),errorText:e.formState.getFormError(`customer.${i}.referral_code`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0),f.name=="Notes"?(d(),m("td",ne,[u(g,{type:"text",class:"min-w-80",modelValue:e.customerForms[i].notes,"onUpdate:modelValue":l=>e.customerForms[i].notes=l,onInput:l=>e.captureChange(i,"Notes changed"),errorText:e.formState.getFormError(`customer.${i}.notes`)},null,8,["modelValue","onUpdate:modelValue","onInput","errorText"])])):c("",!0)],64)):c("",!0),_==s.columns.length-1?(d(),m("td",le,[n("div",de,[e.isDeletingCustomer(e.customerForms[i])?c("",!0):(d(),m("span",{key:0,onClick:E(l=>e.onView(e.customerForms[i]),["stop","prevent"]),class:"text-sm font-medium text-blue-600 dark:text-blue-500 hover:underline"},"View",8,me)),e.isDeletingCustomer(e.customerForms[i])?(d(),P(R,{key:1,type:"danger"},{default:h(()=>[...t[8]||(t[8]=[n("span",{class:"text-xs ml-2"},"Deleting...",-1)])]),_:1})):(d(),m("span",{key:2,onClick:E(l=>e.showDeleteConfirmationModal(e.customerForms[i]),["stop","prevent"]),class:"text-sm font-medium text-red-600 dark:text-red-500 hover:underline"},"Delete",8,ue))])])):c("",!0)],64))),128))],2))),128))]),_:1},8,["onSearch","columns","perPage","onPaginate","onRefresh","searchTerm","pagination","isLoading","onUpdatedColumns","onUpdatedFilters","onUpdatedSorting","onUpdatedPerPage","filterExpressions","sortingExpressions"])])),u(v,{approveType:"primary",scrollOnContent:!1,ref:"updateCustomersModal",leftApproveIcon:s.RefreshCcw,approveText:"Update Customers",approveLoading:s.isUpdatingCustomers,approveAction:()=>e.updateCustomers("notes")},{content:h(()=>[t[10]||(t[10]=n("p",{class:"text-lg font-bold border-b border-dashed border-gray-200 pb-4 mb-4"},"Update Customers",-1)),n("div",ce,[u(g,{rows:"2",class:"w-full",type:"textarea",modelValue:s.notes,"onUpdate:modelValue":t[2]||(t[2]=p=>s.notes=p),label:"Customer Notes",placeholder:`Say something about the ${e.totalCheckedRows==1?"customer":"customers"}`},null,8,["modelValue","placeholder"])])]),_:1},8,["leftApproveIcon","approveLoading","approveAction"]),u(v,{approveType:"danger",ref:"deleteCustomersModal",leftApproveIcon:s.Trash2,approveAction:e.deleteCustomers,approveLoading:e.isDeletingCustomers,approveText:e.totalCheckedRows==1?"Delete Customer":"Delete Customers"},{content:h(()=>[t[12]||(t[12]=n("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Delete Customers",-1)),n("div",pe,[t[11]||(t[11]=n("svg",{class:"w-6 h-6 text-red-500 shrink-0",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"})],-1)),n("span",he,"Are you sure you want to delete "+x(e.totalCheckedRows>1?`these ${e.totalCheckedRows} customers`:"this customer")+"?",1)])]),_:1},8,["leftApproveIcon","approveAction","approveLoading","approveText"]),u(v,{approveType:"danger",ref:"deleteCustomerModal",leftApproveIcon:s.Trash2,approveText:"Delete Customer",approveAction:e.deleteCustomer,approveLoading:e.isDeletingCustomer(s.deletableCustomer)},{content:h(()=>[t[15]||(t[15]=n("p",{class:"text-lg font-bold border-b border-dashed border-gray-200 pb-4 mb-4"},"Confirm Delete",-1)),s.deletableCustomer?(d(),m("p",ge,[t[13]||(t[13]=V("Are you sure you want to permanently delete ",-1)),n("span",fe,x(s.deletableCustomer.name),1),t[14]||(t[14]=V("?",-1))])):c("",!0)]),_:1},8,["leftApproveIcon","approveAction","approveLoading"])])}const tt=j(Y,[["render",we]]);export{tt as default};
