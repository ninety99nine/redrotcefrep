import{i as f}from"./index-ChmBBGBv.js";import{I as T}from"./Input-Ch5FVRoG.js";import{M as _}from"./Modal-X3iEO6Sa.js";import{B as E}from"./Button-0Fhg4Aii.js";import{L as V}from"./Loader-DjUD9LDC.js";import{S as B}from"./Select-B89KxZtb.js";import{P as L}from"./Popover-DfwFh9bM.js";import{i as D}from"./stringUtils-Bvzw0-oW.js";import{S as A}from"./Skeleton-DGkj9lRL.js";import{S as I}from"./SelectTags-DNlVV4wP.js";import{A as k}from"./AddressInput-CNrrxVX9.js";import{B as H}from"./BackdropLoader-CPXO7-36.js";import{c,b as i,e as S,a as n,g as y,t as h,d as N,k as q,i as g,r as u,o as l}from"./app-811fDb4C.js";import{_ as O}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{M as U}from"./move-left-C1am2jSW.js";import{T as M}from"./trash-2-COAOku7K.js";import"./Copy-XiSIbjW8.js";import"./ShineEffect-BW3gyXUb.js";import"./createLucideIcon-JVTSwxMK.js";import"./Tooltip-5EEAR2_1.js";import"./capitalize-ChUSrr1V.js";import"./refresh-ccw-fYK0zSuq.js";import"./circle-check-Ci8AvIUe.js";import"./circle-alert-DdTgr82K.js";import"./x-WVuudoOP.js";import"./parsePhoneNumber-xMTQFMCS.js";import"./vue-draggable-next.esm-bundler-mFF4mOoU.js";import"./GoogleMaps-RFPisK6o.js";import"./SelectCountry-CJD2sKOm.js";import"./plus-BU4OPlaU.js";const j={inject:["formState","storeState","customerState","changeHistoryState","notificationState"],components:{Input:T,Modal:_,Button:E,Loader:V,Select:B,Popover:L,Skeleton:A,SelectTags:I,AddressInput:k,BackdropLoader:H},data(){return{Trash2:M,MoveLeft:U,tags:[]}},watch:{store(o,t){!t&&o&&this.setup()},customerId(o){o&&(this.setup(),this.setActionButtons())}},computed:{store(){return this.storeState.store},customer(){return this.customerState.customer},hasCustomer(){return this.customerState.hasCustomer},customerId(){return this.$route.params.customer_id},isLoadingStore(){return this.storeState.isLoadingStore},isLoadingCustomer(){return this.customerState.isLoadingCustomer},isEditing(){return this.$route.name==="edit-customer"},isCreating(){return this.$route.name==="create-customer"},customerForm(){return this.customerState.customerForm},isSubmitting(){return this.changeHistoryState.actionButtons.length==0?!1:this.changeHistoryState.actionButtons[1].loading},isDeletingCustomer(){return this.customerState.isDeletingCustomer}},methods:{isEmpty:D,goBack(){this.navigateToCustomers()},async setup(){this.customerForm==null&&this.customerState.setCustomerForm(null,this.isCreating),this.isEditing&&this.store&&await this.showCustomer(),this.store&&(this.tags=this.store.customer_tags.map(o=>({label:o.name,value:o.id})))},async navigateToCustomers(){await this.$router.replace({name:"show-customers",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},setAddress(o){this.customerState.customerForm.address=o,this.customerState.saveStateDebounced("Address changed")},unsetAddress(){this.customerState.customerForm.address=null,this.customerState.saveStateDebounced("Address removed")},async onView(o){await this.$router.push({name:"edit-customer",params:{customer_id:o.id},query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async showCustomer(){var o,t,s;try{this.customerState.isLoadingCustomer=!0;let r={params:{store_id:this.store.id,_relationships:["address","tags"].join(",")}};const e=(await axios.get(`/api/customers/${this.customerId}`,r)).data;this.customerState.setCustomer(e),this.customerState.setCustomerForm(e)}catch(r){const m=((t=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:t.message)||(r==null?void 0:r.message)||"Something went wrong while fetching customer";this.notificationState.showWarningNotification(m),this.formState.setServerFormErrors(r),console.error("Failed to fetch customer:",r),((s=r.response)==null?void 0:s.status)===404&&await this.$router.replace({name:"show-customers",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})}finally{this.customerState.isLoadingCustomer=!1}},async createCustomer(){var o,t;try{if(this.customerState.isCreatingCustomer||(this.formState.hideFormErrors(),this.isEmpty(this.customerForm.first_name)&&this.formState.setFormError("first_name","The first name is required"),this.formState.hasErrors))return;this.customerState.isCreatingCustomer=!0,this.changeHistoryState.actionButtons[1].loading=!0;const s={...this.customerForm,store_id:this.store.id},m=(await axios.post("/api/customers",s)).data.customer,e=this.changeHistoryState.getOriginalState();f(this.customerForm.tags,e.tags)||this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Customer created"),this.customerState.saveOriginalState("Original customer"),await this.onView(m)}catch(s){const r=((t=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:t.message)||(s==null?void 0:s.message)||"Something went wrong while creating customer";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(s),console.error("Failed to create customer:",s)}finally{this.customerState.isCreatingCustomer=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async updateCustomer(){var o,t;try{if(this.customerState.isUpdatingCustomer||(this.formState.hideFormErrors(),this.isEmpty(this.customerForm.first_name)&&this.formState.setFormError("first_name","The first name is required"),this.formState.hasErrors))return;this.customerState.isUpdatingCustomer=!0,this.changeHistoryState.actionButtons[1].loading=!0;const s={...this.customerForm,store_id:this.store.id};await axios.put(`/api/customers/${this.customerForm.id}`,s);const r=this.changeHistoryState.getOriginalState();f(this.customerForm.tags,r.tags)||this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Customer updated"),this.customerState.saveOriginalState("Original customer")}catch(s){const r=((t=(o=s==null?void 0:s.response)==null?void 0:o.data)==null?void 0:t.message)||(s==null?void 0:s.message)||"Something went wrong while updating customer";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(s),console.error("Failed to update customer:",s)}finally{this.customerState.isUpdatingCustomer=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async deleteCustomer(o){var t,s;try{if(this.customerState.isDeletingCustomer)return;this.customerState.isDeletingCustomer=!0;const r={data:{store_id:this.store.id}};await axios.delete(`/api/customers/${this.customer.id}`,r),o(),await new Promise(m=>setTimeout(m,500)),this.notificationState.showSuccessNotification("Customer deleted"),await this.navigateToCustomers()}catch(r){const m=((s=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:s.message)||(r==null?void 0:r.message)||"Something went wrong while deleting customer";this.notificationState.showWarningNotification(m),this.formState.setServerFormErrors(r),console.error("Failed to delete customer:",r),o()}finally{this.customerState.isDeletingCustomer=!1}},setActionButtons(){(this.isCreating||this.isEditing)&&(this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(),this.changeHistoryState.addActionButton(this.isEditing?"Save Changes":"Create Customer",this.isEditing?this.updateCustomer:this.createCustomer,"primary",null))},setCustomerForm(o){this.customerState.customerForm=o}},beforeRouteLeave(o,t,s){if(this.changeHistoryState.hasChangeHistory&&!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return s(!1);s()},unmounted(){this.customerState.reset()},created(){this.setup(),this.setActionButtons();const o=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let t=0;t<o.length;t++){let s=o[t];this.changeHistoryState.listeners[s]=this.setCustomerForm}}},P={class:"pt-24 px-4"},W={class:"grid grid-cols-12 gap-4 mb-4"},z={class:"col-span-8 col-start-3"},R={class:"select-none bg-white rounded-lg p-4 mb-4"},J={class:"flex items-center space-x-4"},Y={key:0,class:"flex items-center space-x-2"},G={key:1,class:"flex items-center space-x-1"},K={class:"text-lg text-gray-700 font-semibold"},Q={class:"relative mb-8"},X={class:"bg-white rounded-lg space-y-4 p-4 mb-4"},Z={class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},$={class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},tt={class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},et={class:"space-y-2"},st={class:"font-bold text-black"},rt={class:"flex justify-end"},ot={class:"mb-8"},at={class:"font-bold text-black"};function it(o,t,s,r,m,e){const b=u("Button"),p=u("Skeleton"),C=u("Popover"),v=u("BackdropLoader"),d=u("Input"),x=u("SelectTags"),w=u("AddressInput"),F=u("Modal");return l(),c("div",P,[i("div",W,[i("div",z,[i("div",R,[i("div",J,[n(b,{size:"xs",type:"light",action:e.goBack,leftIcon:m.MoveLeft},{default:y(()=>[...t[16]||(t[16]=[i("span",null,"Back",-1)])]),_:1},8,["action","leftIcon"]),e.isLoadingStore||e.isLoadingCustomer||e.isEditing&&!e.hasCustomer?(l(),c("div",Y,[n(p,{width:"w-40"}),n(p,{width:"w-4"})])):(l(),c("div",G,[i("h1",K,h(e.isCreating?"Add Customer":e.customerForm.name||"..."),1),n(C,{content:"Customers are groups that help organize your products so customers can easily browse and find what theyâ€™re looking for.",placement:"top"})]))])]),i("div",Q,[e.isLoadingCustomer||e.isSubmitting?(l(),N(v,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):S("",!0),i("div",X,[i("div",Z,[n(d,{type:"text",label:"First Name",placeholder:"John",modelValue:e.customerForm.first_name,"onUpdate:modelValue":t[0]||(t[0]=a=>e.customerForm.first_name=a),errorText:e.formState.getFormError("first_name"),onInput:t[1]||(t[1]=a=>e.customerState.saveStateDebounced("First name changed"))},null,8,["modelValue","errorText"]),n(d,{type:"text",label:"Last Name",placeholder:"John",modelValue:e.customerForm.last_name,"onUpdate:modelValue":t[2]||(t[2]=a=>e.customerForm.last_name=a),errorText:e.formState.getFormError("last_name"),onInput:t[3]||(t[3]=a=>e.customerState.saveStateDebounced("Last name changed"))},null,8,["modelValue","errorText"])]),i("div",$,[n(d,{type:"email",label:"Email",modelValue:e.customerForm.email,"onUpdate:modelValue":t[4]||(t[4]=a=>e.customerForm.email=a),placeholder:"johndoe@example.com",errorText:e.formState.getFormError("email"),onInput:t[5]||(t[5]=a=>e.customerState.saveStateDebounced("Email changed"))},null,8,["modelValue","errorText"]),n(d,{type:"text",label:"Mobile Number",placeholder:"+26772000001",modelValue:e.customerForm.mobile_number,"onUpdate:modelValue":t[6]||(t[6]=a=>e.customerForm.mobile_number=a),errorText:e.formState.getFormError("mobile_number"),onInput:t[7]||(t[7]=a=>e.customerState.saveStateDebounced("Mobile number changed"))},null,8,["modelValue","errorText"])]),i("div",tt,[n(d,{type:"date",label:"Birthday",modelValue:e.customerForm.birthday,"onUpdate:modelValue":t[8]||(t[8]=a=>e.customerForm.birthday=a),errorText:e.formState.getFormError("birthday"),onInput:t[9]||(t[9]=a=>e.customerState.saveStateDebounced("Birthday changed"))},null,8,["modelValue","errorText"]),n(d,{type:"text",label:"Referral Code",modelValue:e.customerForm.referral_code,"onUpdate:modelValue":t[10]||(t[10]=a=>e.customerForm.referral_code=a),errorText:e.formState.getFormError("referral_code"),onInput:t[11]||(t[11]=a=>e.customerState.saveStateDebounced("Referral code changed"))},null,8,["modelValue","errorText"])]),n(d,{rows:"2",label:"Notes",type:"textarea",modelValue:e.customerForm.notes,"onUpdate:modelValue":t[12]||(t[12]=a=>e.customerForm.notes=a),errorText:e.formState.getFormError("notes"),placeholder:"Say something about the customer",onInput:t[13]||(t[13]=a=>e.customerState.saveStateDebounced("Notes changed"))},null,8,["modelValue","errorText"]),n(x,{label:"Tags",options:m.tags,placeholder:"Add tag",modelValue:e.customerForm.tags,"onUpdate:modelValue":t[14]||(t[14]=a=>e.customerForm.tags=a),errorText:e.formState.getFormError("tags"),onChange:t[15]||(t[15]=a=>e.customerState.saveStateDebounced("Tags changed"))},null,8,["options","modelValue","errorText"])]),n(w,{title:"Address",onlyValidate:!0,pinLocationOnMap:!0,onOnDeleted:e.unsetAddress,onOnValidated:e.setAddress,address:e.customerForm.address,triggerClass:"space-y-4 p-4 rounded-lg shadow-lg bg-white",subtitle:e.customerForm.address?"Change customer address":"Add customer address"},null,8,["onOnDeleted","onOnValidated","address","subtitle"])]),e.customer?(l(),c("div",{key:0,class:q(["flex items-center justify-between space-x-4 overflow-hidden rounded-lg p-4 border mb-20",e.isLoadingCustomer?"border-gray-300 bg-gray-50":"border-red-300 bg-red-50"])},[i("div",et,[i("p",null,[t[17]||(t[17]=g("Delete ",-1)),i("span",st,h(e.customerForm.name),1),t[18]||(t[18]=g("?",-1))]),t[19]||(t[19]=i("p",{class:"text-sm"},"Once this customer is deleted you will not be able to recover it.",-1))]),i("div",rt,[n(F,{triggerType:"danger",approveType:"danger",approveLeftIcon:m.Trash2,triggerText:"Delete Customer",approveText:"Delete Customer",approveAction:e.deleteCustomer,triggerLoading:e.isDeletingCustomer,approveLoading:e.isDeletingCustomer},{content:y(()=>[t[22]||(t[22]=i("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Confirm Delete",-1)),i("p",ot,[t[20]||(t[20]=g("Are you sure you want to permanently delete ",-1)),i("span",at,h(e.customerForm.name),1),t[21]||(t[21]=g("?",-1))])]),_:1},8,["approveLeftIcon","approveAction","triggerLoading","approveLoading"])])],2)):S("",!0)])])])}const qt=O(j,[["render",it]]);export{qt as default};
