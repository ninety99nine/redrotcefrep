import{I as E}from"./Input-5etQ1obE.js";import{M as T}from"./Modal-1KuVnYqp.js";import{B}from"./Button-C-mSVtjr.js";import{S as k}from"./Select-mk4gS599.js";import{P as L}from"./Popover-CErryWiK.js";import{S as C}from"./Skeleton-dcrsQT38.js";import{i as D}from"./stringUtils-Bvzw0-oW.js";import{B as V}from"./BackdropLoader-Csntr_1Q.js";import{p as H,q,c as v,b as o,e as h,a as l,g as p,t as c,d as I,F as N,f as A,k as M,r as d,o as m}from"./app-CfcRgAtV.js";import{_ as U}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as f}from"./star-Cawu6TdB.js";import{M as S}from"./move-left-Dt2sjdDQ.js";import{T as y}from"./trash-2-DH-tWKqJ.js";import"./Copy-DthcHkWW.js";import"./ShineEffect-DuM8M3bS.js";import"./createLucideIcon-6Wi-O4Lc.js";import"./Tooltip-DXGv3bv0.js";import"./capitalize-ChUSrr1V.js";import"./refresh-ccw-BfzP-qh6.js";import"./circle-check-DJt4jgY5.js";import"./circle-alert-DtAPlORr.js";import"./x-0E_1Yt9j.js";import"./parsePhoneNumber-xMTQFMCS.js";import"./Loader-DC71jh3F.js";const O={inject:["formState","storeState","reviewState","changeHistoryState","notificationState"],components:{Input:E,Modal:T,Button:B,Select:k,Popover:L,Skeleton:C,BackdropLoader:V,Trash2:y,MoveLeft:S,Star:f},data(){return{Trash2:y,MoveLeft:S,Star:f,visibilityTypes:[{label:"Visible",value:!0},{label:"Hidden",value:!1}]}},watch:{store(s,e){!e&&s&&this.setup()},reviewId(s){s&&(this.setup(),this.setActionButtons())}},computed:{store(){return this.storeState.store},review(){return this.reviewState.review},hasReview(){return this.reviewState.hasReview},reviewId(){return this.$route.params.review_id},isLoadingStore(){return this.storeState.isLoadingStore},isLoadingReview(){return this.reviewState.isLoadingReview},isEditing(){return this.$route.name==="edit-review"},isCreating(){return this.$route.name==="create-review"},reviewForm(){return this.reviewState.reviewForm},isSubmitting(){return this.changeHistoryState.actionButtons.length===0?!1:this.changeHistoryState.actionButtons[1].loading},isDeletingReview(){return this.reviewState.isDeletingReview}},methods:{isEmpty:D,formattedDatetime:q,formattedRelativeDate:H,goBack(){this.navigateToReviews()},setRating(s){this.reviewForm.rating=s,this.reviewState.saveStateDebounced("Rating changed")},async setup(){this.reviewForm==null&&this.reviewState.setReviewForm(null,this.isCreating),this.isEditing&&this.store&&await this.showReview()},async navigateToReviews(){await this.$router.replace({name:"show-reviews",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async navigateToEditReview(s){await this.$router.push({name:"edit-review",params:{review_id:s.id},query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async showReview(){var s,e,i;try{this.reviewState.isLoadingReview=!0;let r={params:{store_id:this.store.id}};const t=(await axios.get(`/api/reviews/${this.reviewId}`,r)).data;this.reviewState.setReview(t),this.reviewState.setReviewForm(t)}catch(r){const n=((e=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:e.message)||(r==null?void 0:r.message)||"Something went wrong while fetching review";this.notificationState.showWarningNotification(n),this.formState.setServerFormErrors(r),console.error("Failed to fetch review:",r),((i=r.response)==null?void 0:i.status)===404&&await this.$router.replace({name:"show-reviews",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})}finally{this.reviewState.isLoadingReview=!1}},async createReview(){var s,e;try{if(this.reviewState.isCreatingReview||(this.formState.hideFormErrors(),this.isEmpty(this.reviewForm.rating)&&this.formState.setFormError("rating","The rating is required"),(this.reviewForm.rating<1||this.reviewForm.rating>5)&&this.formState.setFormError("rating","Rating must be between 1 and 5"),this.formState.hasErrors))return;this.reviewState.isCreatingReview=!0,this.changeHistoryState.actionButtons[1].loading=!0;const i={...this.reviewForm,store_id:this.store.id},n=(await axios.post("/api/reviews",i)).data.review;this.notificationState.showSuccessNotification("Review created"),this.reviewState.saveOriginalState("Original review"),await this.navigateToEditReview(n)}catch(i){const r=((e=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:e.message)||(i==null?void 0:i.message)||"Something went wrong while creating review";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(i),console.error("Failed to create review:",i)}finally{this.reviewState.isCreatingReview=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async updateReview(){var s,e;try{if(this.reviewState.isUpdatingReview||(this.formState.hideFormErrors(),this.isEmpty(this.reviewForm.rating)&&this.formState.setFormError("rating","The rating is required"),(this.reviewForm.rating<1||this.reviewForm.rating>5)&&this.formState.setFormError("rating","Rating must be between 1 and 5"),this.formState.hasErrors))return;this.reviewState.isUpdatingReview=!0,this.changeHistoryState.actionButtons[1].loading=!0;const i={...this.reviewForm,store_id:this.store.id};await axios.put(`/api/reviews/${this.reviewForm.id}`,i),this.notificationState.showSuccessNotification("Review updated"),this.reviewState.saveOriginalState("Original review")}catch(i){const r=((e=(s=i==null?void 0:i.response)==null?void 0:s.data)==null?void 0:e.message)||(i==null?void 0:i.message)||"Something went wrong while updating review";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(i),console.error("Failed to update review:",i)}finally{this.reviewState.isUpdatingReview=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async deleteReview(s){var e,i;try{if(this.reviewState.isDeletingReview)return;this.reviewState.isDeletingReview=!0;const r={data:{store_id:this.store.id}};await axios.delete(`/api/reviews/${this.review.id}`,r),s(),await new Promise(n=>setTimeout(n,500)),this.notificationState.showSuccessNotification("Review deleted"),await this.navigateToReviews()}catch(r){const n=((i=(e=r==null?void 0:r.response)==null?void 0:e.data)==null?void 0:i.message)||(r==null?void 0:r.message)||"Something went wrong while deleting review";this.notificationState.showWarningNotification(n),this.formState.setServerFormErrors(r),console.error("Failed to delete review:",r),s()}finally{this.reviewState.isDeletingReview=!1}},setActionButtons(){(this.isCreating||this.isEditing)&&(this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(),this.changeHistoryState.addActionButton(this.isEditing?"Save Changes":"Create Review",this.isEditing?this.updateReview:this.createReview,"primary",null))},setReviewForm(s){this.reviewState.reviewForm=s}},beforeRouteLeave(s,e,i){if(this.changeHistoryState.hasChangeHistory&&!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return i(!1);i()},unmounted(){this.reviewState.reset()},created(){this.setup(),this.setActionButtons();const s=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let e=0;e<s.length;e++){let i=s[e];this.changeHistoryState.listeners[i]=this.setReviewForm}}},P={class:"pt-24 px-4 pb-80"},j={class:"grid grid-cols-12 gap-4 mb-4"},W={class:"col-span-8 col-start-3"},z={class:"select-none bg-white rounded-lg p-4 mb-4"},G={class:"flex items-center space-x-4"},J={key:0,class:"flex items-center space-x-2"},Y={key:1,class:"flex items-center space-x-1"},K={class:"text-lg text-gray-700 font-semibold"},Q={class:"relative mb-4"},X={class:"bg-white rounded-lg space-y-4 p-4"},Z={class:"grid grid-cols-2 gap-4"},$={class:"flex space-x-1 mt-2"},ee={key:0,class:"mt-1 text-sm text-red-600"},te={key:0,class:"flex space-x-1 items-center justify-end"},ie={class:"text-sm"},re={class:"flex justify-end"};function se(s,e,i,r,n,t){const b=d("Button"),g=d("Skeleton"),u=d("Popover"),R=d("BackdropLoader"),x=d("Star"),F=d("Select"),w=d("Input"),_=d("Modal");return m(),v("div",P,[o("div",j,[o("div",W,[o("div",z,[o("div",G,[l(b,{size:"xs",type:"light",action:t.goBack,leftIcon:n.MoveLeft},{default:p(()=>[...e[8]||(e[8]=[o("span",null,"Back",-1)])]),_:1},8,["action","leftIcon"]),t.isLoadingStore||t.isLoadingReview||t.isEditing&&!t.hasReview?(m(),v("div",J,[l(g,{width:"w-40"}),l(g,{width:"w-4"})])):(m(),v("div",Y,[o("h1",K,c(t.isCreating?"Add Review":`Review #${t.reviewForm.id||"..."}`),1),l(u,{content:"Reviews allow customers to share feedback on their experience with your store.",placement:"top"})]))])]),o("div",Q,[t.isLoadingReview||t.isSubmitting?(m(),I(R,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):h("",!0),o("div",X,[o("div",Z,[o("div",null,[e[9]||(e[9]=o("label",{class:"text-sm leading-6 font-medium text-gray-900"},"Rating",-1)),o("div",$,[(m(),v(N,null,A(5,a=>l(x,{size:24,key:a,class:"cursor-pointer",onClick:oe=>t.setRating(a),fill:a<=t.reviewForm.rating?"gold":"none",stroke:a<=t.reviewForm.rating?"gold":"gray"},null,8,["onClick","fill","stroke"])),64))]),t.formState.getFormError("rating")?(m(),v("p",ee,c(t.formState.getFormError("rating")),1)):h("",!0)]),l(F,{class:"w-full",search:!1,label:"Visibility",options:n.visibilityTypes,modelValue:t.reviewForm.visible,"onUpdate:modelValue":e[0]||(e[0]=a=>t.reviewForm.visible=a),errorText:t.formState.getFormError("visible"),onChange:e[1]||(e[1]=a=>t.reviewState.saveStateDebounced("Visibility changed")),tooltipContent:"Set whether the review is visible to others"},null,8,["options","modelValue","errorText"])]),l(w,{type:"text",label:"Name",placeholder:"John Doe",modelValue:t.reviewForm.name,"onUpdate:modelValue":e[2]||(e[2]=a=>t.reviewForm.name=a),errorText:t.formState.getFormError("name"),onInput:e[3]||(e[3]=a=>t.reviewState.saveStateDebounced("Name changed"))},null,8,["modelValue","errorText"]),l(w,{type:"text",label:"Mobile Number",placeholder:"+26772000001",modelValue:t.reviewForm.mobile_number,"onUpdate:modelValue":e[4]||(e[4]=a=>t.reviewForm.mobile_number=a),errorText:t.formState.getFormError("mobile_number"),onInput:e[5]||(e[5]=a=>t.reviewState.saveStateDebounced("Mobile number changed"))},null,8,["modelValue","errorText"]),l(w,{rows:"2",type:"textarea",label:"Comment",modelValue:t.reviewForm.comment,"onUpdate:modelValue":e[6]||(e[6]=a=>t.reviewForm.comment=a),errorText:t.formState.getFormError("comment"),placeholder:"Great experience, highly recommend!",onInput:e[7]||(e[7]=a=>t.reviewState.saveStateDebounced("Comment changed")),tooltipContent:"A short description of the customer's feedback"},null,8,["modelValue","errorText"]),t.review?(m(),v("div",te,[o("span",ie,c(t.formattedDatetime(t.review.created_at)),1),l(u,{placement:"top",content:t.formattedRelativeDate(t.review.created_at)},null,8,["content"])])):h("",!0)])]),t.review?(m(),v("div",{key:0,class:M(["overflow-hidden rounded-lg space-y-4 p-4 border mb-20",t.isLoadingReview?"border-gray-300 bg-gray-50":"border-red-300 bg-red-50"])},[e[11]||(e[11]=o("p",null,"Do you want to permanently delete this review? Once deleted, it cannot be recovered.",-1)),o("div",re,[l(_,{triggerType:"danger",approveType:"danger",approveLeftIcon:n.Trash2,triggerText:"Delete Review",approveText:"Delete Review",approveAction:t.deleteReview,triggerLoading:t.isDeletingReview,approveLoading:t.isDeletingReview},{content:p(()=>[...e[10]||(e[10]=[o("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Confirm Delete",-1),o("p",{class:"mb-8"},"Are you sure you want to permanently delete this review?",-1)])]),_:1},8,["approveLeftIcon","approveAction","triggerLoading","approveLoading"])])],2)):h("",!0)])])])}const Le=U(O,[["render",se]]);export{Le as default};
