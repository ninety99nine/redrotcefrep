import{c as d,b as s,a as f,e as b,g as u,j as w,t as c,i as v,h as S,r as x,o as m}from"./app-qohHnai2.js";import{L as k}from"./Logo-5CKs0UiT.js";import{L as _}from"./Loader-BkdSj3Qz.js";import{B as E}from"./Button-CPqWnTAQ.js";import{i as T}from"./stringUtils-Bvzw0-oW.js";import{_ as C}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ShineEffect-bdFyZnCD.js";const R={name:"VerifyEmail",components:{Logo:k,Loader:_,Button:E},inject:["authState","formState","notificationState"],data(){return{form:{email:"",token:""},loading:!1,verified:!1,verificationError:!1,currentYear:new Date().getFullYear(),resendStorageKey:null,resendAttempts:0,resendTimer:null,resendCountdown:0,resendDelays:[30,120,300,600],verificationType:"registration email",appName:"Perfect Order"}},computed:{isResendDisabled(){return this.resendCountdown>0||this.resendAttempts>=this.resendDelays.length},currentDelay(){return this.resendDelays[this.resendAttempts]||600}},methods:{isEmpty:T,getStorageKey(){return this.form.email?`verify_email_resend_${btoa(this.form.email).replace(/[^a-zA-Z0-9]/g,"")}`:null},loadResendState(){const i=this.getStorageKey();if(!i)return!1;try{const e=localStorage.getItem(i);if(e){const o=JSON.parse(e),a=Date.now();if(o.expiresAt&&a<o.expiresAt)return this.resendAttempts=o.attempts,this.resendCountdown=Math.ceil((o.expiresAt-a)/1e3),this.startResendTimer(),!0;localStorage.removeItem(i)}}catch(e){console.warn("Failed to load resend state:",e),i&&localStorage.removeItem(i)}return!1},saveResendState(){const i=this.getStorageKey();if(!(!i||this.resendCountdown<=0))try{const e=Date.now()+this.resendCountdown*1e3,o={attempts:this.resendAttempts,expiresAt:e,email:this.form.email,timestamp:Date.now()};localStorage.setItem(i,JSON.stringify(o))}catch(e){console.warn("Failed to save resend state:",e)}},startResendTimer(){this.resendTimer&&clearInterval(this.resendTimer),this.resendTimer=setInterval(()=>{if(this.resendCountdown--,this.resendCountdown%5===0&&this.resendCountdown>0&&this.saveResendState(),this.resendCountdown<=0){clearInterval(this.resendTimer),this.resendTimer=null;const i=this.getStorageKey();i&&localStorage.removeItem(i)}else this.saveResendState()},1e3)},resetResendTimer(){this.resendTimer&&(clearInterval(this.resendTimer),this.resendTimer=null),this.resendCountdown=0,this.resendAttempts=0;const i=this.getStorageKey();i&&localStorage.removeItem(i)},initTimerSystem(){this.resendStorageKey=this.getStorageKey(),this.loadResendState()},async verifyEmail(){var i,e,o,a,t,n,r,h,g,p;if(!this.loading){if(this.formState.hideFormErrors(),this.isEmpty(this.form.email)){this.formState.setFormError("email","Email is required"),this.verificationError=!0;return}if(this.isEmpty(this.form.token)){this.formState.setFormError("token","Verification token is required"),this.verificationError=!0;return}if(this.formState.hasErrors){this.verificationError=!0;return}this.loading=!0,this.verificationError=!1;try{const l=await S.post("/api/auth/verify-email",{email:this.form.email,token:this.form.token});this.verified=!0,this.notificationState.showSuccessNotification("Email verified successfully!");const y=l.data.token;this.authState.setTokenOnRequest(y),this.authState.setTokenOnLocalStorage(y),this.resetResendTimer(),this.goToDashboard()}catch(l){this.verificationError=!0;const y=((e=(i=l==null?void 0:l.response)==null?void 0:i.data)==null?void 0:e.message)||((n=(t=(a=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:a.errors)==null?void 0:t.email)==null?void 0:n[0])||((p=(g=(h=(r=l==null?void 0:l.response)==null?void 0:r.data)==null?void 0:h.errors)==null?void 0:g.token)==null?void 0:p[0])||(l==null?void 0:l.message)||"Email verification failed. Please try again.";this.formState.setFormError("general",y),this.notificationState.showWarningNotification(y)}finally{this.loading=!1}}},async resendVerification(){var i,e,o,a,t,n;if(!(this.loading||this.isResendDisabled)){this.loading=!0,this.verificationError=!1,this.formState.hideFormErrors();try{await S.post("/api/auth/resend-email-verification",{email:this.form.email,type:this.verificationType});const r=this.resendDelays[this.resendAttempts]||20;this.notificationState.showSuccessNotification(`Verification email sent! Please check your inbox. Next resend available in ${r}s`),this.verified=!1,this.resendAttempts++,this.resendCountdown=r,this.startResendTimer()}catch(r){const h=((e=(i=r==null?void 0:r.response)==null?void 0:i.data)==null?void 0:e.message)||((n=(t=(a=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:a.errors)==null?void 0:t.email)==null?void 0:n[0])||(r==null?void 0:r.message)||"Failed to resend verification email";this.formState.setFormError("general",h),this.notificationState.showWarningNotification(h)}finally{this.loading=!1}}},goToDashboard(){this.$router.push({name:"dashboard"})},cleanupOldStorage(){try{const i=Object.keys(localStorage),e=Date.now(),o=1440*60*1e3;i.forEach(a=>{if(a.startsWith("verify_email_resend_"))try{const t=JSON.parse(localStorage.getItem(a));t.timestamp&&e-t.timestamp>o&&localStorage.removeItem(a)}catch{localStorage.removeItem(a)}})}catch(i){console.warn("Cleanup failed:",i)}}},beforeUnmount(){this.saveResendState(),this.resendTimer&&clearInterval(this.resendTimer)},mounted(){if(this.cleanupOldStorage(),this.form.email=decodeURIComponent(this.$route.query.email||""),this.form.token=this.$route.query.token||"",this.verificationType=this.$route.query.type||"registration email",this.initTimerSystem(),!this.form.email){this.formState.setFormError("general","Missing email parameter."),this.notificationState.showWarningNotification("Missing email parameter."),this.verificationError=!0;return}if(!this.form.token){this.formState.setFormError("general","Missing verification token."),this.notificationState.showWarningNotification("Missing verification token."),this.verificationError=!0;return}this.verifyEmail()}},D={class:"min-h-screen grid grid-cols-1 lg:grid-cols-2 transition-opacity opacity-100 duration-750 lg:grow starting:opacity-0"},V={class:"flex items-center justify-center p-6 bg-linear-to-b from-blue-100 to-white-100"},N={class:"w-full max-w-md"},j={class:"bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6"},F={key:0,class:"flex items-center justify-center h-40"},I={key:1},L={class:"text-2xl font-semibold leading-none tracking-tight mb-4"},A={class:"text-sm text-gray-500 mb-6"},B={key:0,class:"ml-1"},O={key:1,class:"ml-1"},M={key:2,class:"ml-1"},K={class:"flex justify-center mt-4"},Y={key:2,class:"text-center py-8"},W={class:"text-sm text-gray-600 mb-6"},q={class:"flex justify-center mt-4"},z={key:3,class:"text-center"},P={class:"text-sm text-gray-600 mb-6"},U={key:0,class:"ml-1"},J={key:1,class:"ml-1"},H={key:2,class:"ml-1"},Z={class:"flex justify-center"},G={class:"text-sm text-center text-gray-500"};function Q(i,e,o,a,t,n){const r=x("Logo"),h=x("Loader"),g=x("Button"),p=x("router-link");return m(),d("div",D,[s("div",V,[s("div",N,[f(r,{height:"h-20 mx-auto mb-4"}),s("div",j,[t.loading&&!t.verified&&!t.verificationError?(m(),d("div",F,[f(h,null,{default:u(()=>[...e[0]||(e[0]=[s("span",{class:"ml-2"},"Verifying your email...",-1)])]),_:1})])):!t.verified&&!t.verificationError?(m(),d("div",I,[s("h1",L,c(t.verificationType==="registration email"?"Verify Your Email":"Verify Your New Email"),1),s("p",A,[e[1]||(e[1]=v(" We've sent a verification link to ",-1)),s("strong",null,c(t.form.email),1),v(". Please check your email and click on the link to "+c(t.verificationType==="registration email"?"activate your account":"verify your new email address")+". ",1)]),e[3]||(e[3]=w('<div class="text-center py-8"><div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div><p class="text-sm text-gray-600">Check your email for verification link</p></div>',1)),f(g,{size:"md",type:"light",action:n.resendVerification,disabled:t.loading||n.isResendDisabled,buttonClass:"w-full mb-4"},{default:u(()=>[t.loading?(m(),d("span",B,"Sending...")):n.isResendDisabled?(m(),d("span",O," Resend in "+c(t.resendCountdown)+"s ",1)):(m(),d("span",M,"Resend Verification Email"))]),_:1},8,["action","disabled"]),s("div",K,[f(p,{to:{name:"login"},class:"text-sm text-blue-600 hover:underline"},{default:u(()=>[...e[2]||(e[2]=[v("Back to Login",-1)])]),_:1})])])):t.verified?(m(),d("div",Y,[e[6]||(e[6]=s("div",{class:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"},[s("svg",{class:"w-8 h-8 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})])],-1)),e[7]||(e[7]=s("h1",{class:"text-2xl font-semibold text-green-800 mb-2"},"Email Verified!",-1)),s("p",W,c(t.verificationType==="registration email"?"Your account has been activated.":"Your new email address has been verified."),1),f(g,{size:"md",type:"primary",action:n.goToDashboard,buttonClass:"w-full"},{default:u(()=>[...e[4]||(e[4]=[s("span",{class:"ml-1"},"Continue to Dashboard",-1)])]),_:1},8,["action"]),s("div",q,[f(p,{to:{name:"login"},class:"text-sm text-blue-600 hover:underline"},{default:u(()=>[...e[5]||(e[5]=[v("Back to Login",-1)])]),_:1})])])):t.verificationError?(m(),d("div",z,[e[9]||(e[9]=s("div",{class:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"},[s("svg",{class:"w-8 h-8 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})])],-1)),e[10]||(e[10]=s("h1",{class:"text-xl font-semibold text-red-800 mb-4"},"Verification Failed",-1)),s("p",P,c(n.formState.generalErrorText||n.formState.getFormError("token")||"There was an error verifying your email."),1),f(g,{size:"md",type:"light",action:n.resendVerification,disabled:t.loading||n.isResendDisabled,buttonClass:"w-full mb-4"},{default:u(()=>[t.loading?(m(),d("span",U,"Sending...")):n.isResendDisabled?(m(),d("span",J," Resend in "+c(t.resendCountdown)+"s ",1)):(m(),d("span",H,"Resend Verification Email"))]),_:1},8,["action","disabled"]),s("div",Z,[f(p,{to:{name:"login"},class:"text-sm text-blue-600 hover:underline"},{default:u(()=>[...e[8]||(e[8]=[v("Back to Login",-1)])]),_:1})])])):b("",!0)]),s("p",G,"© "+c(t.currentYear)+" "+c(t.appName)+". All rights reserved.",1)])]),e[11]||(e[11]=s("div",{class:"hidden lg:block"},[s("img",{src:"/images/lady-with-laptop.jpg",class:"w-full h-full object-cover",alt:"Lady holding boxes"})],-1))])}const oe=C(R,[["render",Q]]);export{oe as default};
