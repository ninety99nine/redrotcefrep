import{I as L}from"./Input-CE4RPfme.js";import{M as D}from"./Modal-onlEinK3.js";import{c as B}from"./cloneDeep-CRZrXCcn.js";import{B as x}from"./Button-gD2nuYEJ.js";import{L as I}from"./Loader-BbY_PjoY.js";import{S as V}from"./Select-DevKOWun.js";import{P as U}from"./Popover-DanCA_pE.js";import{S as q}from"./Skeleton-caFmp0IF.js";import{V as F}from"./vue-draggable-next.esm-bundler-CT3UzaSO.js";import{B as N}from"./BackdropLoader-DFpv8gkS.js";import{P as H}from"./Pill-DvJ1xfHb.js";import{S as j}from"./Search-Cqb-Awi9.js";import{c as y,b as i,a as d,d as C,g as S,r as u,o as h,i as v,t as f,e as b,F as M,f as O,w as R,n as A}from"./app-DzEmJHii.js";import{_ as T}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{M as z}from"./move-DxW8Mmdb.js";import{T as k}from"./trash-2-O_xX6E8Z.js";import{M as W}from"./move-left-ROMTm5r0.js";import"./Copy-BxvDy_-Q.js";import"./ShineEffect-7ISWLx82.js";import"./createLucideIcon-B1C9m8SV.js";const Y={inject:["formState","categoryState","storeState","notificationState"],components:{Move:z,Pill:H,Button:x,Search:j,draggable:F},data(){return{Trash2:k,productOptions:[],latestRequestId:null,cancelTokenSource:null,isLoadingProducts:!1}},watch:{store(s,t){!t&&s&&this.showProducts()}},computed:{store(){return this.storeState.store},categoryForm(){return this.categoryState.categoryForm},categoryProducts(){return this.categoryForm.products},totalCategoryProducts(){return this.categoryProducts.length},hasCategoryProducts(){return this.totalCategoryProducts>0}},methods:{async showProducts(s=null){var o,r;const t=++this.latestRequestId;try{this.isLoadingProducts=!0,this.cancelTokenSource&&this.cancelTokenSource.cancel("Request superseded by a newer one"),this.cancelTokenSource=axios.CancelToken.source();let a={params:{store_id:this.store.id,association:"team member",_relationships:["variant","photo"].join(","),_countable_relationships:["variants"].join(",")},cancelToken:this.cancelTokenSource.token};s&&(a.params.search=s);const e=await axios.get("/api/products",a);if(t!==this.latestRequestId)return;const m=e.data.data;this.productOptions=m.map(l=>({label:l.name,product:l}))}catch(a){if(axios.isCancel(a)||t!==this.latestRequestId)return;const e=((r=(o=a==null?void 0:a.response)==null?void 0:o.data)==null?void 0:r.message)||(a==null?void 0:a.message)||"Something went wrong while fetching products";this.notificationState.showWarningNotification(e),this.formState.setServerFormErrors(a),console.error("Failed to fetch products:",a)}finally{if(t!==this.latestRequestId)return;this.isLoadingProducts=!1,this.cancelTokenSource=null}},addProduct(s){this.categoryState.addProduct(s.product)},removeProduct(s){this.categoryState.removeProduct(s)}},created(){this.store&&this.showProducts()}},$={class:"bg-white rounded-lg p-4 shadow-sm"},G={class:"flex items-center space-x-2 mb-4"},J={class:"w-full flex justify-between items-center"},K={class:"flex space-x-4 items-center"},Q={key:0,class:"flex items-center justify-center w-10 h-10"},X=["src"],Z={class:"truncate"},tt={class:"flex space-x-4 items-center"},et={key:0,class:"flex items-center justify-center w-10 h-10"},ot=["src"],st={class:"text-sm truncate"},at={class:"flex items-center space-x-4"},rt={key:1,class:"flex justify-center bg-gray-50 rounded-lg p-4"};function it(s,t,o,r,a,e){const c=u("Pill"),m=u("Search"),l=u("Button"),w=u("Move"),p=u("draggable");return h(),y("div",$,[i("div",G,[t[3]||(t[3]=i("p",{class:"text-lg text-gray-700 font-semibold"},"Products",-1)),d(c,{type:"light",size:"xs"},{default:S(()=>[v(f(`${e.totalCategoryProducts} total`),1)]),_:1})]),d(m,{class:"mb-4",onSelected:e.addProduct,options:a.productOptions,isLoading:a.isLoadingProducts,placeholder:"Search products to add",search:n=>e.showProducts(n)},{option:S(n=>[i("div",J,[i("div",K,[n.option.product.photo?(h(),y("div",Q,[i("img",{class:"w-full max-h-full object-contain rounded-lg flex-shrink-0",src:n.option.product.photo.path},null,8,X)])):b("",!0),i("span",Z,f(n.option.label),1)]),d(c,{type:n.option.product.visible?"success":"warning",size:"xs"},{default:S(()=>[v(f(n.option.product.visible?"visible":"hidden"),1)]),_:2},1032,["type"])])]),_:1},8,["onSelected","options","isLoading","search"]),e.hasCategoryProducts?(h(),C(p,{key:0,handle:".draggable-handle","ghost-class":"bg-yellow-50",modelValue:e.categoryForm.products,"onUpdate:modelValue":t[1]||(t[1]=n=>e.categoryForm.products=n),class:"divide-y divide-gray-200 mb-4",onChange:t[2]||(t[2]=n=>e.categoryState.saveStateDebounced("Product arrangement changed"))},{default:S(()=>[(h(!0),y(M,null,O(e.categoryForm.products,(n,_)=>(h(),y("div",{key:_,class:"flex items-center justify-between hover:bg-gray-100 min-h-16 px-4"},[i("div",tt,[n.photo?(h(),y("div",et,[i("img",{class:"w-full max-h-full object-contain rounded-lg flex-shrink-0",src:n.photo.path},null,8,ot)])):b("",!0),i("span",st,f(n.name),1),d(c,{type:n.visible?"success":"warning",size:"xs"},{default:S(()=>[v(f(n.visible?"visible":"hidden"),1)]),_:2},1032,["type"])]),i("div",at,[d(l,{size:"xs",type:"bareDanger",leftIcon:a.Trash2,action:()=>e.removeProduct(_)},null,8,["leftIcon","action"]),d(w,{onClick:t[0]||(t[0]=R(()=>{},["stop"])),size:"16",class:"draggable-handle cursor-grab active:cursor-grabbing text-gray-500 hover:text-yellow-500"})])]))),128))]),_:1},8,["modelValue"])):(h(),y("div",rt,t[4]||(t[4]=[i("p",{class:"text-sm"},"No products added",-1)])))])}const nt=T(Y,[["render",it]]),lt={inject:["formState","storeState","categoryState","changeHistoryState","notificationState"],components:{Input:L,Modal:D,Button:x,Loader:I,Select:V,Popover:U,Skeleton:q,draggable:F,BackdropLoader:N,CategoryProducts:nt},data(){return{Trash2:k,MoveLeft:W,products:[],visibilityTypes:[{label:"Visible",value:!0},{label:"Hidden",value:!1}]}},watch:{store(s,t){!t&&s&&this.setup()},"$route.params.category_id"(s){s&&(this.setup(),this.setActionButtons())}},computed:{store(){return this.storeState.store},category(){return this.categoryState.category},hasCategory(){return this.categoryState.hasCategory},categoryId(){return this.$route.params.category_id},isLoadingStore(){return this.storeState.isLoadingStore},isLoadingCategory(){return this.categoryState.isLoadingCategory},isEditing(){return this.$route.name==="edit-category"},isCreating(){return this.$route.name==="create-category"},categoryForm(){return this.categoryState.categoryForm},isSubmitting(){return this.changeHistoryState.actionButtons.length==0?!1:this.changeHistoryState.actionButtons[1].loading},isDeletingCategory(){return this.categoryState.isDeletingCategory}},methods:{goBack(){this.navigateToCategories()},async setup(){this.categoryForm==null&&this.categoryState.setCategoryForm(null,this.isCreating),this.isEditing&&this.store&&await this.showCategory()},async navigateToCategories(){await this.$router.replace({name:"show-categories",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async onView(s){await this.$router.push({name:"edit-category",params:{category_id:s.id},query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})},async showCategory(){var s,t;try{this.categoryState.isLoadingCategory=!0;let o={params:{store_id:this.store.id,_relationships:["photos","products.photo"].join(",")}};const a=(await axios.get(`/api/categories/${this.categoryId}`,o)).data;this.categoryState.setCategory(a),this.categoryState.setCategoryForm(a)}catch(o){const r=((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while fetching category";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(o),console.error("Failed to fetch category:",o),o.status==404&&await this.$router.replace({name:"show-categories",query:{store_id:this.store.id,searchTerm:this.$route.query.searchTerm,filterExpressions:this.$route.query.filterExpressions,sortingExpressions:this.$route.query.sortingExpressions}})}finally{this.categoryState.isLoadingCategory=!1}},async createCategory(){var s,t;try{if(this.categoryState.isCreatingCategory||this.categoryState.isUploading||(this.formState.hideFormErrors(),(this.categoryForm.name==null||this.categoryForm.name.trim()==="")&&this.formState.setFormError("name","The name is required"),this.formState.hasErrors))return;this.categoryState.isCreatingCategory=!0,this.changeHistoryState.actionButtons[1].loading=!0;const o={...this.getPayload(),store_id:this.store.id},a=(await axios.post("/api/categories",o)).data.category;this.categoryForm.id=a.id,this.categoryForm.photos.length&&await this.uploadImages(this.categoryForm.id),this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Category created"),this.categoryState.saveOriginalState("Original category"),await this.onView(a)}catch(o){const r=((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while creating category";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(o),console.error("Failed to create category:",o)}finally{this.categoryState.isUploading=!1,this.categoryState.isCreatingCategory=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async updateCategory(){var s,t;try{if(this.categoryState.isUpdatingCategory||this.categoryState.isUploading||(this.formState.hideFormErrors(),(this.categoryForm.name==null||this.categoryForm.name.trim()==="")&&this.formState.setFormError("name","The name is required"),this.formState.hasErrors))return;this.categoryState.isUpdatingCategory=!0,this.changeHistoryState.actionButtons[1].loading=!0;const o={...this.getPayload(),store_id:this.store.id};await axios.put(`/api/categories/${this.categoryForm.id}`,o),this.categoryForm.photos.length&&await this.uploadImages(this.categoryForm.id),this.storeState.silentUpdate(),this.notificationState.showSuccessNotification("Category updated"),this.categoryState.saveOriginalState("Original category")}catch(o){const r=((t=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:t.message)||(o==null?void 0:o.message)||"Something went wrong while updating category";this.notificationState.showWarningNotification(r),this.formState.setServerFormErrors(o),console.error("Failed to update category:",o)}finally{this.categoryState.isUploading=!1,this.categoryState.isUpdatingCategory=!1,this.changeHistoryState.actionButtons[1].loading=!1}},async deleteCategory(s){var t,o;try{if(this.categoryState.isDeletingCategory)return;this.categoryState.isDeletingCategory=!0;const r={data:{store_id:this.store.id}};await axios.delete(`/api/categories/${this.category.id}`,r),this.storeState.silentUpdate(),s(),await new Promise(a=>setTimeout(a,1e3)),this.notificationState.showSuccessNotification("Category deleted"),await this.navigateToCategories()}catch(r){const a=((o=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:o.message)||(r==null?void 0:r.message)||"Something went wrong while deleting category";this.notificationState.showWarningNotification(a),this.formState.setServerFormErrors(r),console.error("Failed to delete category:",r)}finally{this.categoryState.isDeletingCategory=!1,s()}},async uploadImages(s,t=null,o=null){let r=o!==null?this.categoryForm.variants[o].photos:this.categoryForm.photos,a=[];for(let e=0;e<r.length;e++){let c=r[e];c.id==null&&c.uploading==!1&&(c.uploaded===null||c.uploaded===!1)&&(t==null||t==e)&&a.push(this.uploadSingleImage(s,r[e],e))}if(a.length===0){this.categoryState.isUploading=!1;return}return this.categoryState.isUploading=!0,Promise.allSettled(a).then(e=>{let c=e.filter(m=>m.status==="rejected").length;c>0&&this.notificationState.showWarningNotification(`⚠️ ${c} image(s) failed to upload. Try again or change the image.`),this.categoryState.isUploading=!1})},async uploadSingleImage(s,t,o,r=0,a=null){var e,c,m;try{if(r>2)return console.log(`❌ Image ${o+1} permanently failed after 3 attempts.`),t.uploaded=!1,t.uploading=!1,t.error_message=((c=(e=a==null?void 0:a.response)==null?void 0:e.data)==null?void 0:c.message)||(a==null?void 0:a.message)||"Upload failed",Promise.reject("Failed after 3 attempts");let l=new FormData;l.append("file",t.file_ref),l.append("mediable_id",s),l.append("store_id",this.store.id),l.append("mediable_type","category"),l.append("upload_folder_name","category_photo"),t.uploading=!0,t.error_message=null;const w={headers:{"Content-Type":"multipart/form-data"}},p=await axios.post("/api/media-files",l,w),n=p.data.media_file;return t.uploaded=!0,t.uploading=!1,t.id=n.id,t.path=n.path,console.log(`✅ Image ${o+1} uploaded successfully.`),p}catch(l){return console.error(`⚠️ Image ${o+1} upload attempt ${r+1} failed.`,l),l.code==="ECONNABORTED"||((m=l.response)==null?void 0:m.status)===504?void 0:this.uploadSingleImage(s,t,o,r+1,l)}},getPayload(){let s=B(this.categoryForm);return s.product_ids=s.products.map(t=>t.id),delete s.products,s},setActionButtons(){(this.isCreating||this.isEditing)&&(this.changeHistoryState.removeButtons(),this.changeHistoryState.addDiscardButton(this.onDiscard),this.changeHistoryState.addActionButton(this.isEditing?"Save Changes":"Create Category",this.isEditing?this.updateCategory:this.createCategory,"primary",null))},setCategoryForm(s){this.categoryState.categoryForm=s}},beforeRouteLeave(s,t,o){if(this.changeHistoryState.hasChangeHistory&&!window.confirm("You have unsaved changes. Are you sure you want to leave?"))return o(!1);o()},unmounted(){this.categoryState.reset(),this.changeHistoryState.reset()},created(){this.setup(),this.setActionButtons();const s=["undo","redo","jumpToHistory","resetHistoryToCurrent","resetHistoryToOriginal"];for(let t=0;t<s.length;t++){let o=s[t];this.changeHistoryState.listeners[o]=this.setCategoryForm}}},ct={class:"pt-24 px-4"},dt={class:"grid grid-cols-12 gap-4 mb-4"},gt={class:"col-span-8 col-start-3"},ut={class:"select-none bg-white rounded-lg p-4 mb-4"},ht={class:"flex items-center space-x-4"},mt={key:0,class:"flex items-center space-x-2"},yt={key:1,class:"flex items-center space-x-1"},pt={class:"text-lg text-gray-700 font-semibold"},ft={class:"relative mb-8"},St={class:"bg-white rounded-lg space-y-4 p-4"},vt={class:"relative mb-8"},wt={class:"space-y-2"},bt={class:"font-bold text-black"},_t={class:"flex justify-end"},Ct={class:"mb-8"},xt={class:"font-bold text-black"};function Ft(s,t,o,r,a,e){const c=u("Button"),m=u("Skeleton"),l=u("Popover"),w=u("BackdropLoader"),p=u("Input"),n=u("Select"),_=u("CategoryProducts"),P=u("Modal");return h(),y("div",ct,[i("div",dt,[i("div",gt,[i("div",ut,[i("div",ht,[d(c,{size:"xs",type:"light",action:e.goBack,leftIcon:a.MoveLeft},{default:S(()=>t[10]||(t[10]=[i("span",null,"Back",-1)])),_:1,__:[10]},8,["action","leftIcon"]),e.isLoadingStore||e.isLoadingCategory||e.isEditing&&!e.hasCategory?(h(),y("div",mt,[d(m,{width:"w-40"}),d(m,{width:"w-4"})])):(h(),y("div",yt,[i("h1",pt,f(e.isCreating?"Add Category":e.categoryForm.name||"..."),1),d(l,{content:"Categories are groups that help organize your products so customers can easily browse and find what they’re looking for.",placement:"top"})]))])]),i("div",ft,[e.isLoadingCategory||e.isSubmitting?(h(),C(w,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):b("",!0),i("div",St,[d(p,{type:"text",label:"Name",placeholder:"Main Dish",modelValue:e.categoryForm.name,"onUpdate:modelValue":t[0]||(t[0]=g=>e.categoryForm.name=g),errorText:e.formState.getFormError("name"),tooltipContent:"The name of your category e.g Main Dish",onInput:t[1]||(t[1]=g=>e.categoryState.saveStateDebounced("Name changed"))},null,8,["modelValue","errorText"]),d(n,{class:"w-full",search:!1,label:"Visibility",options:a.visibilityTypes,modelValue:e.categoryForm.visible,"onUpdate:modelValue":t[2]||(t[2]=g=>e.categoryForm.visible=g),errorText:e.formState.getFormError("visible"),onChange:t[3]||(t[3]=g=>e.categoryState.saveStateDebounced("Visibility status changed")),tooltipContent:"Turn on if you want your category to be visible (Made available to customers)"},null,8,["options","modelValue","errorText"]),d(p,{rows:"2",type:"textarea",label:"Description",modelValue:e.categoryForm.description,"onUpdate:modelValue":t[4]||(t[4]=g=>e.categoryForm.description=g),errorText:e.formState.getFormError("description"),description:"Description must be less than 100 characters",onInput:t[5]||(t[5]=g=>e.categoryState.saveStateDebounced("Description changed")),placeholder:"Delicious, filling meals that take center stage on your plate",tooltipContent:"Sweet and short description of your category e.g Delicious, filling meals that take center stage on your plate"},null,8,["modelValue","errorText"]),d(p,{type:"file",maxFiles:1,modelValue:e.categoryForm.photos,"onUpdate:modelValue":t[6]||(t[6]=g=>e.categoryForm.photos=g),onRetryUploads:t[7]||(t[7]=g=>e.uploadImages(e.categoryForm.id)),onChange:t[8]||(t[8]=g=>e.categoryState.saveStateDebounced("Photos changed")),onRetryUpload:t[9]||(t[9]=(g,E)=>e.uploadImages(e.categoryForm.id,E))},null,8,["modelValue"])])]),i("div",vt,[e.isLoadingCategory||e.isSubmitting?(h(),C(w,{key:0,showSpinningLoader:!1,class:"rounded-lg"})):b("",!0),d(_)]),e.category?(h(),y("div",{key:0,class:A(["flex items-center justify-between space-x-4 overflow-hidden rounded-lg p-4 border mb-20",e.isLoadingCategory?"border-gray-300 bg-gray-50":"border-red-300 bg-red-50"])},[i("div",wt,[i("p",null,[t[11]||(t[11]=v("Delete ")),i("span",bt,f(e.categoryForm.name),1),t[12]||(t[12]=v("?"))]),t[13]||(t[13]=i("p",{class:"text-sm"},"Once this category is deleted you will not be able to recover it.",-1))]),i("div",_t,[d(P,{triggerType:"danger",approveType:"danger",approveLeftIcon:a.Trash2,triggerText:"Delete Category",approveText:"Delete Category",approveAction:e.deleteCategory,triggerLoading:e.isDeletingCategory,approveLoading:e.isDeletingCategory},{content:S(()=>[t[16]||(t[16]=i("p",{class:"text-lg font-bold border-b border-gray-300 border-dashed pb-4 mb-4"},"Confirm Delete",-1)),i("p",Ct,[t[14]||(t[14]=v("Are you sure you want to permanently delete ")),i("span",xt,f(e.categoryForm.name),1),t[15]||(t[15]=v("?"))])]),_:1},8,["approveLeftIcon","approveAction","triggerLoading","approveLoading"])])],2)):b("",!0)])])])}const Yt=T(lt,[["render",Ft]]);export{Yt as default};
